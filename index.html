<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>ç“·ç –åº“å­˜ç®¡ç†ç³»ç»Ÿ - æœ€ç»ˆç‰ˆ v2</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
import { getDatabase, ref, set, onValue, get } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";
const firebaseConfig = {
  apiKey: "AIzaSyC65DEOgj4WeksRRVmw4ZTrNkCB83SoQpI",
  authDomain: "tile-management-system-f5db8.firebaseapp.com",
  databaseURL: "https://tile-management-system-f5db8-default-rtdb.firebaseio.com",
  projectId: "tile-management-system-f5db8",
  storageBucket: "tile-management-system-f5db8.appspot.com",
  messagingSenderId: "925027091187",
  appId: "1:925027091187:web:a2bb160b629f541abded86"
};
try {
  const app = initializeApp(firebaseConfig);
  const database = getDatabase(app);
  const stockRef = ref(database, 'tileStock');
  window.firebase = { app, database, ref, set, onValue, get, stockRef };
  window.firebaseInitialized = true;
} catch(e){ window.firebaseInitialized=false; window.firebaseError=e.message; }
</script>
<style>
:root{
  --primary:#007AFF;
  --bg:#F8FAFC;
  --card:#fff;
  --radius:14px;
  --shadow:0 6px 18px rgba(0,0,0,0.08);
  --red:#ef4444;
  --orange:#f59e0b;
  --lightgreen:#10b981;
  --green:#047857;
  font-family:-apple-system, BlinkMacSystemFont, "Helvetica Neue", Arial, sans-serif;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);padding:84px 12px 20px;-webkit-font-smoothing:antialiased;color:#111}
.navbar{
  position:fixed;top:0;left:0;right:0;height:72px;
  backdrop-filter: blur(12px);
  background:rgba(0,122,255,0.82);
  display:flex;align-items:center;justify-content:space-between;padding:10px 12px;color:white;z-index:999;border-bottom:1px solid rgba(255,255,255,0.12);
}
.navbar .brand{display:flex;align-items:center;gap:10px}
.navbar h1{font-size:17px;margin:0;font-weight:600}
.nav-tabs{display:flex;gap:6px;align-items:center}
.nav-tabs button{background:transparent;border:0;color:rgba(255,255,255,0.95);font-size:15px;padding:8px 10px;border-radius:10px;display:flex;gap:8px;align-items:center}
.nav-tabs button .icon{font-size:17px}
.nav-tabs button.active{background:rgba(255,255,255,0.12)}
.container{max-width:980px;margin:0 auto}
.card{background:var(--card);border-radius:14px;box-shadow:var(--shadow);padding:14px;margin-bottom:14px}
h3{color:var(--primary);margin:0 0 6px}
.thai{color:#666;font-size:13px;margin-bottom:8px}
.label-small{font-size:13px;color:#666;margin-bottom:6px}
input,select,textarea,button{font-size:15px}
input,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #e6eef9}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
button.primary{background:var(--primary);color:#fff;border:0;padding:10px;border-radius:10px;cursor:pointer;flex:1}
button.ghost{background:#f6f9ff;border:1px solid #e6eef9;color:#111;padding:10px;border-radius:10px;cursor:pointer;flex:1}
button.small{padding:6px 10px;border-radius:8px;font-size:14px}
.table-wrap{overflow:auto;-webkit-overflow-scrolling:touch;margin-top:10px;border-radius:8px}
table{width:100%;border-collapse:collapse;font-size:14px}
th,td{padding:10px;border-bottom:1px solid #f1f5f9;text-align:left}
th{background:var(--primary);color:#fff;position:sticky;top:0}
.item{background:#fbfdff;padding:10px;border-radius:10px;margin-bottom:10px;border:1px solid #eef5ff}
.mini-row{display:flex;gap:8px;align-items:center}
.mini-row input{flex:1}
.mini-row button{flex:0 0 auto}
.mini-res{margin-top:8px}
.qty-badge{display:inline-block;padding:4px 8px;border-radius:999px;color:#fff;font-weight:600;font-size:13px}
.qty-red{background:var(--red)}
.qty-orange{background:var(--orange);color:#fff}
.qty-lightgreen{background:var(--lightgreen)}
.qty-green{background:var(--green)}
.toast{position:fixed;bottom:26px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.78);color:#fff;padding:10px 16px;border-radius:18px;display:none;z-index:2000}
.admin-btn{position:fixed;right:14px;bottom:18px;background:transparent;border:0;z-index:1500}
.admin-btn .gear{background:rgba(0,0,0,0.6);color:#fff;padding:10px;border-radius:10px}
.modal{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.4);display:none;align-items:center;justify-content:center;z-index:2000}
.modal .card{width:92%;max-width:420px}
.footer-note{color:#666;text-align:center;padding:18px 0;font-size:13px}
@media(max-width:600px){body{padding:92px 12px 20px} .nav-tabs button{padding:6px 8px;font-size:14px} th,td{padding:8px;font-size:13px}}
</style>
</head>
<body>
<div class="navbar" role="banner">
  <div class="brand">
    <h1>ç“·ç –åº“å­˜ç®¡ç†ç³»ç»Ÿ</h1>
  </div>
  <div class="nav-tabs" role="tablist" aria-label="ä¸»å¯¼èˆª">
    <button class="tabbtn active" data-tab="tab-search"><span class="icon">ğŸ“Š</span><span>åº“å­˜æŸ¥è¯¢</span></button>
    <button class="tabbtn" data-tab="tab-chuhuo"><span class="icon">ğŸ“¦</span><span>å‡ºè´§è®¡åˆ’</span></button>
    <button class="tabbtn" data-tab="tab-haiyun"><span class="icon">ğŸš¢</span><span>æµ·è¿å…¥åº“</span></button>
  </div>
</div>

<div class="container">
  <!-- åº“å­˜æŸ¥è¯¢ -->
  <div id="tab-search" class="card tab" role="tabpanel">
    <h3>ğŸ“Š åº“å­˜æŸ¥è¯¢</h3>
    <div class="thai">(à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸ªà¸•à¹‡à¸­à¸à¸ªà¸´à¸™à¸„à¹‰à¸²)</div>
    <div class="label-small">ç“·ç –ç¼–å· (æ”¯æŒæ¨¡ç³Šæœç´¢)</div>
    <input id="searchCode" placeholder="è¾“å…¥ç¼–å·å…³é”®è¯ï¼Œä¾‹å¦‚ AB123">
    <div class="controls">
      <button class="primary" id="searchBtn">æŸ¥è¯¢åº“å­˜<br><span class="thai">(à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸ªà¸•à¹‡à¸­à¸)</span></button>
      <button class="ghost" id="refreshBtn">åˆ·æ–°æ•°æ®<br><span class="thai">(à¸£à¸µà¹€à¸Ÿà¸£à¸Šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥)</span></button>
    </div>
    <div id="lastInfo" style="margin-top:8px;color:#666;font-size:13px">åº“å­˜æœ€åæ›´æ–°æ—¶é—´ï¼šåŠ è½½ä¸­...</div>
    <div class="table-wrap">
      <table id="mainTable" style="display:none">
        <thead><tr><th>å›¾ç‰‡</th><th>ç¼–å·</th><th>è‰²å·</th><th>æ•°é‡(ç®±)</th><th>ä»“åº“</th></tr></thead>
        <tbody id="mainTbody"></tbody>
      </table>
      <div id="mainMsg" style="padding:12px;color:#888">è¯·è¾“å…¥ç¼–å·å¹¶ç‚¹å‡»æŸ¥è¯¢</div>
    </div>
  </div>

  <!-- å‡ºè´§è®¡åˆ’ -->
  <div id="tab-chuhuo" class="card tab" style="display:none">
    <h3>ğŸ“¦ å‡ºè´§è®¡åˆ’</h3>
    <div class="thai">(à¹à¸œà¸™à¸à¸²à¸£à¸ˆà¸±à¸”à¸ªà¹ˆà¸‡à¸ªà¸´à¸™à¸„à¹‰à¸²)</div>
    <label>æ—¥æœŸ</label><input id="ch_date" type="date">
    <label>å•ä½æˆ–è½¦ç‰Œ</label><input id="ch_vehicle" type="text">
    <label>å®¢æˆ·</label><input id="ch_customer" type="text">
    <div id="ch_items"></div>
    <div class="controls">
      <button class="primary" id="ch_add">+ æ·»åŠ è´§é¡¹<br><span class='thai'>(+ à¹€à¸à¸´à¹ˆà¸¡à¸£à¸²à¸¢à¸à¸²à¸£à¸ªà¸´à¸™à¸„à¹‰à¸²)</span></button>
      <button class="ghost" id="ch_gen">ç”Ÿæˆæ–‡å­—<br><span class='thai'>(à¸ªà¸£à¹‰à¸²à¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡)</span></button>
      <button class="primary" id="ch_copy">å¤åˆ¶<br><span class='thai'>(à¸„à¸±à¸”à¸¥à¸­à¸)</span></button>
    </div>
    <pre id="ch_result" style="margin-top:10px">ï¼ˆè¯·å…ˆå¡«å†™è¡¨å•ï¼‰</pre>
  </div>

  <!-- æµ·è¿å…¥åº“ -->
  <div id="tab-haiyun" class="card tab" style="display:none">
    <h3>ğŸš¢ æµ·è¿å…¥åº“</h3>
    <div class="thai">(à¸™à¸³à¹€à¸‚à¹‰à¸²à¸ªà¸´à¸™à¸„à¹‰à¸²à¸—à¸²à¸‡à¹€à¸£à¸·à¸­)</div>
    <label>æ—¥æœŸ</label><input id="hy_date" type="date">
    <label>æŸœå·</label><input id="hy_container" type="text">
    <label>å…¥åº“ä»“åº“ï¼ˆæ‰‹åŠ¨è¾“å…¥ï¼‰</label><input id="hy_warehouse" placeholder="ä¾‹å¦‚ï¼šK38ä»“åº“">
    <div id="hy_items"></div>
    <div class="controls">
      <button class="primary" id="hy_add">+ æ·»åŠ è´§é¡¹<br><span class='thai'>(+ à¹€à¸à¸´à¹ˆà¸¡à¸£à¸²à¸¢à¸à¸²à¸£à¸ªà¸´à¸™à¸„à¹‰à¸²)</span></button>
      <button class="ghost" id="hy_gen">ç”Ÿæˆæ–‡å­—<br><span class='thai'>(à¸ªà¸£à¹‰à¸²à¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡)</span></button>
      <button class="primary" id="hy_copy">å¤åˆ¶<br><span class='thai'>(à¸„à¸±à¸”à¸¥à¸­à¸)</span></button>
    </div>
    <pre id="hy_result" style="margin-top:10px">ï¼ˆè¯·å…ˆå¡«å†™è¡¨å•ï¼‰</pre>
  </div>

  <!-- ç®¡ç†å‘˜åŒºåŸŸï¼ˆåº•éƒ¨å°æŒ‰é’®è§¦å‘ï¼‰ -->
  <div id="admin_placeholder" style="height:18px"></div>

  <div class="footer-note">ä»…é™å†…éƒ¨ä½¿ç”¨ | Designed by Kyson Li</div>
</div>

<!-- ç®¡ç†å‘˜æŒ‰é’® -->
<button class="admin-btn" id="adminToggle" title="ç®¡ç†å‘˜ç™»å½•">
  <span class="gear">âš™ï¸ ç®¡ç†å‘˜ç™»å½•</span>
</button>

<!-- ç®¡ç†å‘˜å¼¹çª— -->
<div class="modal" id="adminModal" role="dialog" aria-modal="true">
  <div class="card">
    <h3>ğŸ” ç®¡ç†å‘˜åŠŸèƒ½</h3>
    <div class="thai">(à¸ªà¸³à¸«à¸£à¸±à¸šà¸œà¸¹à¹‰à¸”à¸¹à¹à¸¥à¸£à¸°à¸šà¸š)</div>
    <label>ç®¡ç†å‘˜å¯†ç </label>
    <input id="adminPw" type="password" placeholder="è¾“å…¥å¯†ç ">
    <div class="controls" style="margin-top:8px">
      <button class="primary" id="adminLogin">ç™»å½•<br><span class='thai'>(à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸š)</span></button>
      <button class="ghost" id="adminClose">å–æ¶ˆ</button>
    </div>
    <div id="adminArea" style="display:none;margin-top:12px">
      <div class="label-small">ä¸Šä¼  Excel æ–‡ä»¶ï¼ˆBåˆ—=ç¼–å·ï¼ŒCåˆ—=è‰²å·ï¼ŒJåˆ—=æ•°é‡ï¼‰</div>
      <input id="excelInput" type="file" accept=".xlsx,.xls">
      <div class="controls" style="margin-top:8px">
        <button class="secondary" id="btnSave">ä¿å­˜å¹¶å†™å…¥ Firebase<br><span class='thai'>(à¸šà¸±à¸™à¸—à¸¶à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥)</span></button>
        <button class="ghost" id="btnPreview">é¢„è§ˆæ•°æ®</button>
      </div>
      <div id="previewBox" style="margin-top:10px"></div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
(function(){
  // Tabs
  const tabButtons = document.querySelectorAll('.tabbtn');
  tabButtons.forEach(b=>{
    b.addEventListener('click', ()=> {
      tabButtons.forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      document.querySelectorAll('.tab').forEach(t=>t.style.display='none');
      const id = 'tab-' + b.dataset.tab?.split?.('-')?.pop?.() || b.dataset.tab;
      // mapping: use dataset tab value directly (we set data-tab to tab-search etc.)
      const target = b.dataset.tab;
      document.getElementById(target).style.display='block';
      window.scrollTo({top:0,behavior:'smooth'});
    });
  });

  function showToast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',2400); }

  // Stock data
  let stockData = [];
  async function loadStockData(){
    if(!window.firebase){ showToast('Firebase æœªåˆå§‹åŒ–'); return; }
    try{
      const snap = await window.firebase.get(window.firebase.stockRef);
      const val = snap.val();
      if(val && val.stockData){ stockData = val.stockData; document.getElementById('lastInfo').textContent = 'åº“å­˜æœ€åæ›´æ–°æ—¶é—´ï¼š' + (val.updateTime || new Date().toLocaleString()); showToast('å·²åŠ è½½åº“å­˜æ•°æ®'); }
      else { stockData = []; showToast('æš‚æ— åº“å­˜æ•°æ®'); }
    }catch(e){ console.error(e); showToast('åŠ è½½åº“å­˜å¤±è´¥'); }
  }

  // render quantity with color
  function qtyBadge(num){
    const n = Number(num) || 0;
    if(n <= 50) return `<span class="qty-badge qty-red">${n}</span>`;
    if(n <= 200) return `<span class="qty-badge qty-orange">${n}</span>`;
    if(n <= 500) return `<span class="qty-badge qty-lightgreen">${n}</span>`;
    return `<span class="qty-badge qty-green">${n}</span>`;
  }

  // main search
  document.getElementById('searchBtn').addEventListener('click', ()=>{
    const key = document.getElementById('searchCode').value.trim().toLowerCase();
    const table = document.getElementById('mainTable'), tbody = document.getElementById('mainTbody'), msg = document.getElementById('mainMsg');
    tbody.innerHTML=''; table.style.display='none'; msg.textContent='';
    if(!key){ msg.textContent='è¯·è¾“å…¥ç¼–å·å…³é”®è¯'; return; }
    const res = stockData.filter(i => i.code && String(i.code).toLowerCase().includes(key));
    if(!res.length){ msg.textContent='æœªæ‰¾åˆ°ç»“æœ'; return; }
    res.forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${r.code}</td><td>${r.color||'-'}</td><td>${qtyBadge(r.quantity)}</td><td>${r.warehouse||''}</td>`;
      tbody.appendChild(tr);
    });
    table.style.display='table';
  });
  document.getElementById('refreshBtn').addEventListener('click', loadStockData);

  // å‡ºè´§è®¡åˆ’: add item with aligned search button
  const chList = document.getElementById('ch_items');
  function addChItem(v={}) {
    const el = document.createElement('div'); el.className='item';
    el.innerHTML = `
      <div class="mini-row">
        <div style="flex:1">
          <label>á€€á€¯á€’á€ºá€”á€­á€•á€á€º/ç¼–å·</label>
          <input class="ch-code" placeholder="è¾“å…¥ç¼–å·">
        </div>
        <button class="small ch-search">æŸ¥è¯¢åº“å­˜</button>
      </div>
      <div class="mini-res"></div>
      <label>á€¡á€›á€±á€¬á€„á€ºá€€á€¯á€’á€ºè‰²å·</label><input class="ch-color">
      <label>á€¡á€œá€»á€¬á€¸á€¡á€”á€¶/è§„æ ¼</label><input class="ch-spec">
      <label>á€¡á€›á€±á€¡á€á€½á€€á€º/æ•°é‡</label><input class="ch-qty">`;
    chList.appendChild(el);
    if(v.code) el.querySelector('.ch-code').value = v.code;
    if(v.color) el.querySelector('.ch-color').value = v.color;
    if(v.spec) el.querySelector('.ch-spec').value = v.spec;
    if(v.qty) el.querySelector('.ch-qty').value = v.qty;

    const btn = el.querySelector('.ch-search');
    const codeInput = el.querySelector('.ch-code');
    const resDiv = el.querySelector('.mini-res');

    btn.addEventListener('click', ()=>{
      const q = codeInput.value.trim().toLowerCase();
      resDiv.innerHTML = '<div style="color:#666;padding:6px">æŸ¥è¯¢ä¸­...</div>';
      if(!q){ resDiv.innerHTML = '<div style="color:#c00;padding:6px">è¯·è¾“å…¥ç¼–å·</div>'; return; }
      const res = stockData.filter(i => i.code && String(i.code).toLowerCase().includes(q));
      if(!res.length){ resDiv.innerHTML = '<div style="color:#666;padding:6px">æœªæ‰¾åˆ°åº“å­˜ä¿¡æ¯</div>'; return; }
      let html = '<div class="table-wrap"><table><thead><tr><th>ç¼–å·</th><th>è‰²å·</th><th>æ•°é‡(ç®±)</th><th>ä»“åº“</th></tr></thead><tbody>';
      res.forEach(r => html += `<tr><td>${r.code}</td><td>${r.color||'-'}</td><td>${qtyBadge(r.quantity)}</td><td>${r.warehouse||''}</td></tr>`);
      html += '</tbody></table></div>';
      resDiv.innerHTML = html;
    });
  }
  addChItem();
  document.getElementById('ch_add').addEventListener('click', ()=>addChItem());
  document.getElementById('ch_gen').addEventListener('click', ()=>{
    const date = document.getElementById('ch_date').value;
    const vehicle = document.getElementById('ch_vehicle').value;
    const customer = document.getElementById('ch_customer').value;
    let text = `å‡ºè´§è®¡åˆ’\næ—¥æœŸï¼š${date}\nå•ä½æˆ–è½¦ç‰Œï¼š${vehicle}\nå®¢æˆ·ï¼š${customer}\n\n`;
    Array.from(chList.children).forEach((el,idx)=>{
      const code = el.querySelector('.ch-code').value;
      const color = el.querySelector('.ch-color').value;
      const spec = el.querySelector('.ch-spec').value;
      const qty = el.querySelector('.ch-qty').value;
      text += `${idx+1}.á€€á€¯á€’á€ºá€”á€­á€•á€á€º/ç¼–å·ï¼š${code}\ná€¡á€›á€±á€¬á€„á€ºá€€á€¯á€’á€ºè‰²å·ï¼š${color}\ná€¡á€œá€»á€¬á€¸á€¡á€”á€¶/è§„æ ¼ï¼š${spec}\ná€¡á€›á€±á€¡à¸±à¸à¸—à¹Œ/æ•°é‡ï¼š${qty}\n\n`;
    });
    document.getElementById('ch_result').textContent = text.trim();
    showToast('å·²ç”Ÿæˆå‡ºè´§è®¡åˆ’');
  });
  document.getElementById('ch_copy').addEventListener('click', ()=>{ navigator.clipboard.writeText(document.getElementById('ch_result').textContent); showToast('å·²å¤åˆ¶'); });

  // æµ·è¿å…¥åº“
  const hyList = document.getElementById('hy_items');
  function addHyItem(v={}) {
    const el = document.createElement('div'); el.className='item';
    el.innerHTML = `
      <label>á€€á€¯á€’á€ºá€”á€­á€•á€á€º/ç¼–å·</label><input class="hy-code">
      <label>è§„æ ¼/á€¡á€œá€»á€¬á€¸á€¡á€”á€¶</label><input class="hy-spec">
      <label>è‰²å·/á€¡á€›á€±á€¬á€„á€ºá€€á€¯á€’á€º</label><input class="hy-color">
      <label>æ•°é‡/á€¡á€›á€±á€¡á€á€½á€€á€º</label><input class="hy-qty">`;
    hyList.appendChild(el);
    if(v.code) el.querySelector('.hy-code').value = v.code;
    if(v.spec) el.querySelector('.hy-spec').value = v.spec;
    if(v.color) el.querySelector('.hy-color').value = v.color;
    if(v.qty) el.querySelector('.hy-qty').value = v.qty;
  }
  addHyItem();
  document.getElementById('hy_add').addEventListener('click', ()=>addHyItem());
  document.getElementById('hy_gen').addEventListener('click', ()=>{
    const date = document.getElementById('hy_date').value;
    const container = document.getElementById('hy_container').value;
    const warehouse = document.getElementById('hy_warehouse').value || '';
    let text = `æµ·è¿å…¥åº“ï¼š${warehouse}\næ—¥æœŸï¼š${date}\næŸœå·ï¼š${container}\n\n`;
    Array.from(hyList.children).forEach((el,idx)=>{
      const code = el.querySelector('.hy-code').value;
      const spec = el.querySelector('.hy-spec').value;
      const color = el.querySelector('.hy-color').value;
      const qty = el.querySelector('.hy-qty').value;
      text += `${idx+1}.á€€á€¯á€’á€ºá€”á€­á€•á€á€º/ç¼–å·ï¼š${code}\ná€¡á€œá€»á€¬á€¸á€¡á€”á€¶/è§„æ ¼ï¼š${spec}\ná€¡á€›á€±á€¬á€„á€ºá€€á€¯á€’á€ºè‰²å·ï¼š${color}\ná€¡á€›á€±á€¡à¸²à¸ªà¸•à¸£à¹Œ/æ•°é‡ï¼š${qty}\n\n`;
    });
    document.getElementById('hy_result').textContent = text.trim();
    showToast('å·²ç”Ÿæˆæµ·è¿å…¥åº“');
  });
  document.getElementById('hy_copy').addEventListener('click', ()=>{ navigator.clipboard.writeText(document.getElementById('hy_result').textContent); showToast('å·²å¤åˆ¶'); });

  // Admin modal behavior
  const adminToggle = document.getElementById('adminToggle');
  const adminModal = document.getElementById('adminModal');
  const adminClose = document.getElementById('adminClose');
  adminToggle.addEventListener('click', ()=>{ adminModal.style.display = 'flex'; });
  adminClose.addEventListener('click', ()=>{ adminModal.style.display = 'none'; });
  adminModal.addEventListener('click', (e)=>{ if(e.target === adminModal) adminModal.style.display='none'; });

  document.getElementById('adminLogin').addEventListener('click', ()=>{
    const pw = document.getElementById('adminPw').value.trim();
    if(pw === 'admin'){ document.getElementById('adminArea').style.display='block'; showToast('ç®¡ç†å‘˜å·²ç™»å½•'); }
    else showToast('å¯†ç é”™è¯¯');
  });

  document.getElementById('btnPreview').addEventListener('click', ()=>{
    const f = document.getElementById('excelInput').files[0];
    if(!f){ showToast('è¯·é€‰æ‹© Excel æ–‡ä»¶'); return; }
    const reader = new FileReader();
    reader.onload = (e)=>{
      const wb = XLSX.read(new Uint8Array(e.target.result), { type:'array' });
      let items = [];
      wb.SheetNames.forEach(name=>{
        const ws = wb.Sheets[name];
        const rows = XLSX.utils.sheet_to_json(ws, { header:1 });
        for(let r=0;r<rows.length;r++){
          const row = rows[r];
          const check = row[1] ? String(row[1]) : '';
          if(String(check).includes('à¸à¸£à¸°à¹€à¸šà¸·à¹‰à¸­à¸‡')) {
            const code = row[1] ? String(row[1]).trim() : '';
            const color = row[2] ? String(row[2]).trim() : '';
            const qty = row[9] ? Number(row[9]) : 0;
            if(code) items.push({ code, color, quantity: qty, warehouse: name });
          }
        }
      });
      document.getElementById('previewBox').innerHTML = '<pre style="max-height:280px;overflow:auto">'+JSON.stringify(items.slice(0,200),null,2)+'</pre>';
      showToast('é¢„è§ˆå·²ç”Ÿæˆ');
    };
    reader.readAsArrayBuffer(f);
  });

  document.getElementById('btnSave').addEventListener('click', ()=>{
    const f = document.getElementById('excelInput').files[0];
    if(!f){ showToast('è¯·é€‰æ‹© Excel æ–‡ä»¶'); return; }
    const reader = new FileReader();
    reader.onload = async (e)=>{
      const wb = XLSX.read(new Uint8Array(e.target.result), { type:'array' });
      let items = [];
      wb.SheetNames.forEach(name=>{
        const ws = wb.Sheets[name];
        const rows = XLSX.utils.sheet_to_json(ws, { header:1 });
        for(let r=0;r<rows.length;r++){
          const row = rows[r];
          const check = row[1] ? String(row[1]) : '';
          if(String(check).includes('à¸à¸£à¸°à¹€à¸šà¸·à¹‰à¸­à¸‡')) {
            const code = row[1] ? String(row[1]).trim() : '';
            const color = row[2] ? String(row[2]).trim() : '';
            const qty = row[9] ? Number(row[9]) : 0;
            if(code) items.push({ code, color, quantity: qty, warehouse: name });
          }
        }
      });
      if(!window.firebase){ showToast('Firebase æœªå°±ç»ª'); return; }
      try{
        const updateTime = new Date().toLocaleString();
        await window.firebase.set(window.firebase.stockRef, { stockData: items, updateTime });
        showToast('å·²ä¿å­˜åˆ° Firebase');
        stockData = items;
        document.getElementById('lastInfo').textContent = 'åº“å­˜æœ€åæ›´æ–°æ—¶é—´ï¼š' + updateTime;
        adminModal.style.display='none';
      }catch(err){ console.error(err); showToast('ä¿å­˜å¤±è´¥'); }
    };
    reader.readAsArrayBuffer(f);
  });

  // initial load
  setTimeout(()=>{ if(window.firebaseInitialized) loadStockData(); }, 600);

  // allow enter key for search
  document.getElementById('searchCode').addEventListener('keypress', (e)=>{ if(e.key==='Enter') document.getElementById('searchBtn').click(); });

})();
</script>

<!-- Injected image preview modal (revised) -->
<div id="imgPreviewModal" style="display:none;align-items:center;justify-content:center;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:99999">
  <img id="imgPreviewModalImg" src="" style="max-width:92%;max-height:92%;border-radius:8px;box-shadow:0 10px 30px rgba(0,0,0,.6)" onclick="event.stopPropagation()">
</div>
<script>
function showImageModal(src){
  var m=document.getElementById('imgPreviewModal');
  var im=document.getElementById('imgPreviewModalImg');
  im.src=src||'';
  m.style.display='flex';
}
function hideImageModal(){
  var m=document.getElementById('imgPreviewModal');
  var im=document.getElementById('imgPreviewModalImg');
  im.src='';
  m.style.display='none';
}
document.getElementById('imgPreviewModal').onclick=function(){ hideImageModal(); };
document.addEventListener('keydown',function(e){ if(e.key==='Escape') hideImageModal(); });
</script>


<script>
(function(){
  const IMG_BASE = "https://raw.githubusercontent.com/li995913596-beep/tile-images/main/";
  function placeholderDataURI(){
    return 'data:image/svg+xml;utf8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="240" height="160"><rect width="100%" height="100%" fill="%23f7f7f7"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="%23999" font-size="14">No image</text></svg>');
  }
  function extractCodeFromText(text){
    if(!text) return '';
    const s = String(text).trim();
    const tokens = s.split(/[\s,;\/\\]+/).map(t=>t.trim()).filter(Boolean);
    if(tokens.length === 0) return '';
    for(const t of tokens){ if(/\d/.test(t)) return t; }
    for(const t of tokens){ if(t.length>=2 && t.length<=60) return t; }
    return tokens[0] || '';
  }
  function loadImgIntoCell(cell, code){
    try{
      if(!cell) return;
      // clear placeholder
      cell.innerHTML = '';
      if(!code) { cell.innerHTML = ''; return; }
      var img = document.createElement('img');
      img.alt = code;
      img.style.width='80px'; img.style.height='56px'; img.style.objectFit='cover'; img.style.borderRadius='6px'; img.style.cursor='zoom-in';
      img.src = IMG_BASE + encodeURIComponent(code) + '.jpg';
      img.onerror = function(){
        if(this._t === undefined){ this._t = 1; this.src = IMG_BASE + encodeURIComponent(code) + '.jpeg'; }
        else if(this._t === 1){ this._t = 2; this.src = IMG_BASE + encodeURIComponent(code) + '.png'; }
        else { this.src = IMG_BASE + 'wutu.gif'; }
      };
      img.addEventListener('click', function(e){ e.stopPropagation(); showImageModal(img.src); });
      cell.appendChild(img);
    }catch(e){ console.warn(e); }
  }

  // Process tables initially and for dynamic rows
  function processTables(){
    const tables = document.querySelectorAll('table');
    tables.forEach(table=>{
      const tbody = table.tBodies[0] || table;
      Array.from(tbody.querySelectorAll('tr')).forEach(row=>{
        if(!row.querySelector('.img-cell')){
          const imgTd = document.createElement('td');
          imgTd.className = 'img-cell';
          imgTd.innerHTML = '&#8203;'; // zero-width placeholder
          row.insertBefore(imgTd, row.firstChild);
          const codeCell = row.children[1];
          const codeText = codeCell ? (codeCell.textContent || codeCell.innerText || '') : '';
          const code = extractCodeFromText(codeText);
          loadImgIntoCell(imgTd, code);
        } else {
          const cell = row.querySelector('.img-cell');
          if(cell && !cell.querySelector('img')){
            const codeCell = row.children[1];
            const codeText = codeCell ? (codeCell.textContent || codeCell.innerText || '') : '';
            const code = extractCodeFromText(codeText);
            loadImgIntoCell(cell, code);
          }
        }
      });
      // observe future additions
      const obs = new MutationObserver(muts=>{
        muts.forEach(mut=>{
          mut.addedNodes && mut.addedNodes.forEach(node=>{
            if(node && node.nodeType===1 && node.tagName.toLowerCase()==='tr'){
              if(!node.querySelector('.img-cell')){
                const imgTd = document.createElement('td');
                imgTd.className = 'img-cell';
                imgTd.innerHTML = '&#8203;';
                node.insertBefore(imgTd, node.firstChild);
                const codeCell = node.children[1];
                const codeText = codeCell ? (codeCell.textContent || codeCell.innerText || '') : '';
                const code = extractCodeFromText(codeText);
                loadImgIntoCell(imgTd, code);
              }
            }
          });
        });
      });
      obs.observe(tbody, { childList:true });
    });
  }

  if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', processTables);
  else processTables();

  window.nsTileImageHelpers = { loadImgIntoCell, processTables, extractCodeFromText };
})();
</script>

</body>
</html>
