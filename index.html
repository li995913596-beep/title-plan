<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç“·ç –å‡ºå…¥åº“ç®¡ç†ç³»ç»Ÿ</title>
    <!-- å¼•å…¥SheetJSåº“ç”¨äºå¤„ç†Excelæ–‡ä»¶ -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- å¼•å…¥Firebaseæ¨¡å—åŒ–ç‰ˆæœ¬ -->
    <script type="module">
        // é¦–å…ˆå¯¼å…¥æ‰€æœ‰éœ€è¦çš„Firebaseå‡½æ•°
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, get, update } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";
        
        // Firebaseé…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyC65DEOgj4WeksRRVmw4ZTrNkCB83SoQpI",
            authDomain: "tile-management-system-f5db8.firebaseapp.com",
            databaseURL: "https://tile-management-system-f5db8-default-rtdb.firebaseio.com",
            projectId: "tile-management-system-f5db8",
            storageBucket: "tile-management-system-f5db8.appspot.com",
            messagingSenderId: "925027091187",
            appId: "1:925027091187:web:a2bb160b629f541abded86"
        };

        try {
            // åˆå§‹åŒ–Firebaseåº”ç”¨
            const app = initializeApp(firebaseConfig);
            const database = getDatabase(app);
            
            // åˆ›å»ºæ•°æ®åº“å¼•ç”¨
            const stockRef = ref(database, 'tileStock');
            
            // å°†Firebaseç›¸å…³å¯¹è±¡æš´éœ²åˆ°å…¨å±€ï¼Œç¡®ä¿å…¶ä»–è„šæœ¬å¯ä»¥è®¿é—®
            window.firebase = {
                app,
                database,
                ref,
                set,
                onValue,
                get,
                update,
                stockRef
            };
            
            // æ ‡è®°Firebaseåˆå§‹åŒ–æˆåŠŸ
            window.firebaseInitialized = true;
            console.log('Firebaseåˆå§‹åŒ–æˆåŠŸ');
        } catch (error) {
            console.error('Firebaseåˆå§‹åŒ–å¤±è´¥:', error);
            window.firebaseInitialized = false;
            window.firebaseError = error.message;
        }
    </script>
    <style>
        /* ä¿æŒåŸæœ‰æ ·å¼ä¸å˜ */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
        body { padding: 15px; background-color: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; }
        .card { background: white; padding: 15px; margin-bottom: 15px; border-radius: 8px; box-shadow: 0 1px 3px #eee; }
        h1, h2 { margin-bottom: 15px; color: #333; }
        h1 { text-align: center; color: #4F46E5; font-size: 20px; padding: 10px 0; }
        .form-group { margin-bottom: 12px; }
        label { display: block; margin-bottom: 5px; font-size: 14px; color: #666; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 15px; }
        button { background-color: #4F46E5; color: white; border: none; padding: 12px; border-radius: 4px; width: 100%; font-size: 16px; margin-top: 5px; cursor: pointer; transition: background-color 0.3s; }
        button:hover { opacity: 0.9; }
        button.secondary { background-color: #10B981; }
        button.gray { background-color: #f0f0f0; color: #666; }
        button.admin { background-color: #f59e0b; }
        .flex-row { display: flex; gap: 10px; }
        .flex-row button { flex: 1; }
        #tiles-list { margin: 10px 0; padding: 10px; border: 1px dashed #ddd; min-height: 60px; }
        .tile-item { padding: 8px; background: #f9f9f9; margin-bottom: 5px; border-radius: 4px; }
        #result { margin: 10px 0; padding: 10px; background: #f9f9f9; border-radius: 4px; white-space: pre-wrap; font-size: 14px; }
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); color: white; padding: 10px 15px; border-radius: 4px; display: none; z-index: 1000; }
        .mode-selector { display: flex; margin-bottom: 15px; flex-wrap: wrap; }
        .mode-selector button { flex: 1; margin: 0; min-width: 120px; }
        .mode-selector button.active { background-color: #4F46E5; color: white; }
        .mode-selector button:not(.active) { background-color: #f0f0f0; color: #666; }
        .mode-content { display: none; }
        .mode-content.active { display: block; }
        .common-content { display: block; }
        .stock-mode .common-content { display: none; }
        
        .import-area {
            border: 2px dashed #ccc;
            border-radius: 6px;
            padding: 20px;
            text-align: center;
            margin-bottom: 15px;
            cursor: pointer;
            transition: border-color 0.3s;
        }
        .import-area:hover {
            border-color: #4F46E5;
        }
        .import-icon {
            font-size: 24px;
            color: #4F46E5;
            margin-bottom: 10px;
        }
        
        .last-update {
            font-size: 13px;
            color: #666;
            margin-top: 10px;
            text-align: right;
        }
        .github-footer {
            text-align: center;
            font-size: 12px;
            color: #666;
            margin-top: 20px;
            padding: 10px;
        }
        .admin-section {
            margin: 15px 0;
            padding: 10px;
            background-color: #fff3cd;
            border-radius: 4px;
            display: none;
        }
        
        .compact-auth {
            margin: 10px 0;
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        .compact-auth .form-group {
            flex: 1;
            margin: 0;
        }
        .compact-auth input {
            padding: 8px;
            font-size: 14px;
        }
        .compact-auth button {
            padding: 8px;
            font-size: 14px;
            white-space: nowrap;
            width: auto;
        }
        .auth-label {
            font-size: 12px;
            color: #888;
            margin-bottom: 3px;
            display: block;
        }
        .error-message {
            color: #dc2626;
            font-size: 12px;
            margin-top: 3px;
            display: none;
        }
        
        .offline-notice {
            background-color: #fff3cd;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 14px;
            display: none;
        }
        .sync-status {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            text-align: right;
        }
        
        .stock-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            box-shadow: 0 2px 3px rgba(0,0,0,0.05);
        }
        .stock-table th {
            padding: 12px 15px;
            text-align: left;
            background-color: #4F46E5;
            color: white;
            font-weight: bold;
            font-size: 15px;
            position: sticky;
            top: 0;
        }
        .stock-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
            font-size: 15px;
        }
        .stock-table tr:hover {
            background-color: #f0f7ff;
            transform: translateX(3px);
            transition: all 0.2s ease;
        }
        .stock-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .stock-high {
            color: #10B981;
            font-weight: bold;
        }
        .stock-medium {
            color: #f59e0b;
            font-weight: bold;
        }
        .stock-low {
            color: #ef4444;
            font-weight: bold;
        }
        .stock-urgent {
            color: white;
            background-color: #ef4444;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: bold;
        }
        
        #stockCode {
            padding: 12px;
            font-size: 16px;
            border: 2px solid #ddd;
            transition: border-color 0.3s;
        }
        #stockCode:focus {
            border-color: #4F46E5;
            outline: none;
        }
        #stock-content button {
            padding: 12px;
            font-weight: 600;
        }
        
        .search-highlight {
            background-color: #fff380;
            padding: 0 3px;
            border-radius: 2px;
        }
        
        .table-container {
            overflow-x: auto;
            margin-top: 10px;
            border-radius: 6px;
            border: 1px solid #eee;
            max-height: 500px;
            overflow-y: auto;
        }
        
        #copyButton, #stockCopyButton {
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
        }
        
        #copyButton.copied, #stockCopyButton.copied {
            background-color: #10B981;
        }
        
        #copyButton.copied::after, #stockCopyButton.copied::after {
            content: "âœ“ å·²å¤åˆ¶";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #10B981;
            animation: copySuccess 1.5s;
        }
        
        @keyframes copySuccess {
            0% { opacity: 0; }
            20% { opacity: 1; }
            80% { opacity: 1; }
            100% { opacity: 0; }
        }
        
        .copy-hint {
            font-size: 12px;
            color: #666;
            text-align: center;
            margin-top: 5px;
        }
        
        .upload-instructions {
            font-size: 13px;
            color: #666;
            margin: 10px 0;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        
        .upload-instructions strong {
            color: #4F46E5;
        }
        
        .query-status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-size: 14px;
            display: none;
        }
        
        .status-loading {
            background-color: #e0f2fe;
            color: #0284c7;
            display: block;
        }
        
        .status-error {
            background-color: #fee2e2;
            color: #b91c1c;
            display: block;
        }
        
        .status-info {
            background-color: #eff6ff;
            color: #1e40af;
            display: block;
        }
        
        .troubleshoot {
            margin-top: 8px;
            padding-left: 15px;
            font-size: 13px;
        }
        
        .troubleshoot li {
            margin: 4px 0;
        }
        
        /* åˆå§‹åŒ–çŠ¶æ€æç¤ºæ ·å¼ */
        .initialization-status {
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 6px;
            font-size: 14px;
            text-align: center;
        }
        
        .initialization-loading {
            background-color: #f0fdf4;
            color: #15803d;
        }
        
        .initialization-error {
            background-color: #fee2e2;
            color: #b91c1c;
        }
        
        /* åº“å­˜ç®¡ç†é€‰é¡¹å¡æ ·å¼ */
        .stock-tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid #ddd;
        }
        
        .stock-tab {
            padding: 8px 15px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-right: 10px;
        }
        
        .stock-tab.active {
            border-bottom-color: #4F46E5;
            color: #4F46E5;
            font-weight: bold;
        }
        
        .stock-tab-content {
            display: none;
        }
        
        .stock-tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
<div class="container">
    <!-- åˆå§‹åŒ–çŠ¶æ€æç¤º -->
    <div id="initializationStatus" class="initialization-status initialization-loading">
        ç³»ç»Ÿæ­£åœ¨åˆå§‹åŒ–ï¼Œè¯·ç¨å€™...
    </div>

    <h1>ç“·ç –å‡ºå…¥åº“ç®¡ç†ç³»ç»Ÿ</h1>
    
    <!-- ç¦»çº¿æ¨¡å¼æç¤º -->
    <div class="offline-notice" id="offlineNotice">
        æ³¨æ„ï¼šç³»ç»Ÿæ­£ä»¥ç¦»çº¿æ¨¡å¼è¿è¡Œï¼Œåº“å­˜æ•°æ®å¯èƒ½ä¸æ˜¯æœ€æ–°çš„
    </div>

    <div class="mode-selector">
        <button id="outbound-mode" class="active" onclick="switchMode('outbound')">å‡ºè´§è®¡åˆ’</button>
        <button id="inbound-mode" onclick="switchMode('inbound')">æµ·è¿å…¥åº“</button>
        <button id="stock-mode" onclick="switchMode('stock')">åº“å­˜ç®¡ç†</button>
    </div>
    <div class="card"><div id="date"></div></div>

    <div id="outbound-content" class="mode-content active">
        <div class="card">
            <h2>è®¢å•ä¿¡æ¯</h2>
            <div class="form-group"><label>å®¢æˆ· (å¯é€‰)</label><input type="text" id="customer" oninput="saveData()"></div>
            <div class="form-group">
                <label>æ˜¯å¦ä»˜æ¬¾</label>
                <select id="payment" onchange="saveData()">
                    <option value="">è¯·é€‰æ‹©</option>
                    <option value="yes">æ˜¯</option>
                    <option value="no">å¦</option>
                </select>
            </div>
            <div class="form-group"><label>å•ä½æˆ–è½¦ç‰Œ</label><input type="text" id="unit" oninput="saveData()"></div>
        </div>
    </div>

    <div id="inbound-content" class="mode-content">
        <div class="card">
            <h2>å…¥åº“ä¿¡æ¯</h2>
            <div class="form-group"><label>æŸœå· *</label><input type="text" id="containerNo" oninput="saveData()"></div>
            <div class="form-group">
                <label>å…¥åº“ä»“åº“ *</label>
                <select id="warehouse" onchange="saveData()">
                    <option value="">è¯·é€‰æ‹©</option>
                    <option value="1å·ä»“åº“">1å·ä»“åº“</option>
                    <option value="k38ä»“åº“">k38ä»“åº“</option>
                    <option value="k39ä»“åº“">k39ä»“åº“</option>
                </select>
            </div>
        </div>
    </div>

    <div id="stock-content" class="mode-content">
        <div class="card">
            <h2>åº“å­˜ç®¡ç†</h2>
            
            <!-- åº“å­˜ç®¡ç†é€‰é¡¹å¡ -->
            <div class="stock-tabs">
                <div class="stock-tab active" onclick="switchStockTab('search')">åº“å­˜æŸ¥è¯¢</div>
                <div class="stock-tab" onclick="switchStockTab('full')">å®Œæ•´åº“å­˜è¡¨</div>
            </div>
            
            <!-- åº“å­˜æŸ¥è¯¢å†…å®¹ -->
            <div id="search-tab-content" class="stock-tab-content active">
                <div class="form-group">
                    <label>ç“·ç –ç¼–å· (æ”¯æŒæ¨¡ç³ŠæŸ¥è¯¢)</label>
                    <input type="text" id="stockCode" placeholder="è¾“å…¥ç¼–å·å…³é”®è¯">
                </div>
                <div class="flex-row">
                    <button onclick="searchStock()">æŸ¥è¯¢åº“å­˜</button>
                    <button class="secondary" onclick="refreshStockData()">åˆ·æ–°æ•°æ®</button>
                </div>
                <button class="gray" id="stockCopyButton" style="margin-top: 10px;" onclick="copyStockResults()">å¤åˆ¶æŸ¥è¯¢ç»“æœ</button>
                
                <!-- æŸ¥è¯¢çŠ¶æ€æç¤ºåŒºåŸŸ -->
                <div id="queryStatus" class="query-status"></div>
                
                <div class="last-update" id="last-update-time">
                    åº“å­˜æœ€åæ›´æ–°æ—¶é—´ï¼šåŠ è½½ä¸­...
                </div>
                
                <div class="card" style="margin-top: 15px;">
                    <h3>æŸ¥è¯¢ç»“æœ</h3>
                    <div class="table-container">
                        <table class="stock-table" id="stock-result-table" style="display: none;">
                            <thead>
                                <tr>
                                    <th>ç¼–å·</th>
                                    <th>è‰²å·</th>
                                    <th>æ•°é‡(ç®±)</th>
                                    <th>ä»“åº“</th>
                                </tr>
                            </thead>
                            <tbody id="stock-result-body">
                                <!-- ç»“æœå°†åœ¨è¿™é‡ŒåŠ¨æ€å¡«å…… -->
                            </tbody>
                        </table>
                        <div id="stock-result-message">è¯·è¾“å…¥ç¼–å·å¹¶ç‚¹å‡»æŸ¥è¯¢</div>
                    </div>
                </div>
            </div>
            
            <!-- å®Œæ•´åº“å­˜è¡¨å†…å®¹ -->
            <div id="full-tab-content" class="stock-tab-content">
                <button class="secondary" onclick="refreshStockData()">åˆ·æ–°åº“å­˜æ•°æ®</button>
                <div class="last-update" id="full-last-update-time">
                    åº“å­˜æœ€åæ›´æ–°æ—¶é—´ï¼šåŠ è½½ä¸­...
                </div>
                
                <div class="card" style="margin-top: 15px;">
                    <h3>å®Œæ•´åº“å­˜è¡¨ï¼ˆæŒ‰æ•°é‡ä»å¤šåˆ°å°‘æ’åˆ—ï¼‰</h3>
                    <div class="table-container">
                        <table class="stock-table" id="full-stock-table" style="display: none;">
                            <thead>
                                <tr>
                                    <th>ç¼–å·</th>
                                    <th>è‰²å·</th>
                                    <th>æ•°é‡(ç®±)</th>
                                    <th>ä»“åº“</th>
                                </tr>
                            </thead>
                            <tbody id="full-stock-body">
                                <!-- å®Œæ•´åº“å­˜æ•°æ®å°†åœ¨è¿™é‡ŒåŠ¨æ€å¡«å…… -->
                            </tbody>
                        </table>
                        <div id="full-stock-message">åŠ è½½åº“å­˜æ•°æ®ä¸­...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å…¬å…±å†…å®¹åŒºåŸŸ -->
    <div class="common-content">
        <div class="card">
            <h2>ç“·ç –ä¿¡æ¯</h2>
            <div class="form-group"><label>ç¼–å· *</label><input type="text" id="code"></div>
            <div class="form-group">
                <label>è§„æ ¼ *</label>
                <select id="size" onchange="handleSizeChange()">
                    <option value="">è¯·é€‰æ‹©</option>
                    <option value="300*300">300*300</option>
                    <option value="300*600">300*600</option>
                    <option value="400*400">400*400</option>
                    <option value="400*800">400*800</option>
                    <option value="470*1200">470*1200</option>
                    <option value="470*1350">470*1350</option>
                    <option value="600*600">600*600</option>
                    <option value="600*1200">600*1200</option>
                    <option value="750*1500">750*1500</option>
                    <option value="800*800">800*800</option>
                    <option value="200*1200">200*1200</option>
                    <option value="custom">è‡ªå®šä¹‰</option>
                </select>
                <input type="text" id="customSize" placeholder="è¯·è¾“å…¥è‡ªå®šä¹‰è§„æ ¼" style="margin-top:5px; display:none;" oninput="saveData()">
            </div>
            <div class="form-group"><label>æ•°é‡ *</label><input type="text" id="quantity" oninput="this.value=this.value.replace(/\D/g,''); saveData();"></div>
            <div class="form-group"><label>è‰²å· (å¯é€‰)</label><input type="text" id="color"></div>
            <button onclick="addTile()">æ·»åŠ åˆ°åˆ—è¡¨</button>
        </div>

        <div class="card">
            <h2>å·²æ·»åŠ çš„ç“·ç –</h2>
            <div id="tiles-list">å°šæœªæ·»åŠ ç“·ç –</div>
            <div class="flex-row">
                <button class="gray" id="clearButton" onclick="clearAll()">æ¸…ç©º</button>
                <button class="secondary" onclick="generatePlan()">ç”Ÿæˆè®¡åˆ’</button>
            </div>
        </div>

        <div class="card">
            <h2>è®¡åˆ’ç»“æœ</h2>
            <div id="result"></div>
            <button id="copyButton" onclick="copyResult()">å¤åˆ¶å†…å®¹</button>
            <div class="copy-hint">ç‚¹å‡»æŒ‰é’®å³å¯å¤åˆ¶ï¼Œæ— éœ€æ‰‹åŠ¨é€‰æ‹©</div>
        </div>
    </div>
    
    <!-- ç´§å‡‘çš„ç®¡ç†å‘˜ç™»å½•åŒºåŸŸ -->
    <div class="compact-auth">
        <div class="form-group">
            <span class="auth-label">ç®¡ç†å‘˜å…¥å£</span>
            <input type="password" id="adminPassword" placeholder="è¾“å…¥å¯†ç ">
            <div class="error-message" id="adminError"></div>
        </div>
        <button class="admin" id="adminLoginBtn">ç™»å½•</button>
    </div>
    
    <!-- ç®¡ç†å‘˜åŠŸèƒ½åŒºåŸŸï¼ˆé»˜è®¤éšè—ï¼‰ -->
    <div class="admin-section" id="adminSection">
        <h2>ç®¡ç†å‘˜åŠŸèƒ½</h2>
        
        <!-- ä¸Šä¼ è¯´æ˜ -->
        <div class="upload-instructions">
            <strong>åº“å­˜è¡¨æ ¼å¼è¦æ±‚ï¼š</strong><br>
            - ç¼–å·è¯·æ”¾åœ¨ <strong>Båˆ—</strong><br>
            - è‰²å·è¯·æ”¾åœ¨ <strong>Cåˆ—</strong>ï¼ˆæ— å†…å®¹å¯ç•™ç©ºï¼‰<br>
            - åº“å­˜æ•°é‡è¯·æ”¾åœ¨ <strong>Jåˆ—</strong><br>
            - æ”¯æŒ .xlsx å’Œ .xls æ ¼å¼
        </div>
        
        <div class="import-area" onclick="document.getElementById('adminFileInput').click()">
            <div class="import-icon">ğŸ“‚</div>
            <p>ç‚¹å‡»æˆ–æ‹–æ‹½Excelæ–‡ä»¶åˆ°æ­¤å¤„æ›´æ–°å…¬å…±åº“å­˜æ•°æ®</p>
            <input type="file" id="adminFileInput" accept=".xlsx,.xls" onchange="handleAdminFileUpload(event)">
        </div>
        
        <div class="sync-status" id="syncStatus"></div>
        <button class="gray" onclick="logoutAdmin()">é€€å‡ºç®¡ç†å‘˜æ¨¡å¼</button>
    </div>
    
    <div class="github-footer">
        ç“·ç –å‡ºå…¥åº“ç®¡ç†ç³»ç»Ÿ &copy; 2023
    </div>
</div>
<div class="toast" id="toast"></div>

<script>
    // ç­‰å¾…Firebaseåˆå§‹åŒ–å®Œæˆåå†æ‰§è¡Œç³»ç»Ÿåˆå§‹åŒ–
    function waitForFirebase() {
        const statusElement = document.getElementById('initializationStatus');
        
        // æ£€æŸ¥Firebaseæ˜¯å¦å·²åˆå§‹åŒ–
        if (window.firebaseInitialized !== undefined) {
            if (window.firebaseInitialized) {
                // åˆå§‹åŒ–æˆåŠŸï¼Œéšè—çŠ¶æ€æç¤º
                statusElement.style.display = 'none';
                // ç»§ç»­ç³»ç»Ÿåˆå§‹åŒ–
                initSystem();
            } else {
                // åˆå§‹åŒ–å¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                statusElement.className = 'initialization-status initialization-error';
                statusElement.innerHTML = `
                    ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥: ${window.firebaseError || 'æœªçŸ¥é”™è¯¯'}<br><br>
                    <strong>è¯·å°è¯•ï¼š</strong><br>
                    1. åˆ·æ–°é¡µé¢é‡æ–°åŠ è½½<br>
                    2. æ£€æŸ¥ç½‘ç»œè¿æ¥<br>
                    3. ç¨åå†è¯•
                `;
            }
            return;
        }
        
        // å¦‚æœè¿˜æœªåˆå§‹åŒ–ï¼Œç»§ç»­ç­‰å¾…
        setTimeout(waitForFirebase, 100);
    }
    
    // å¯åŠ¨ç­‰å¾…æœºåˆ¶
    waitForFirebase();

    // å…¨å±€å˜é‡
    let tiles = [];
    let tileIndex = 0;
    let currentMode = 'outbound';
    let currentStockTab = 'search'; // åº“å­˜ç®¡ç†ä¸­çš„å½“å‰é€‰é¡¹å¡
    let stockData = [];
    let isAdmin = false;
    let isOfflineMode = false;
    let isStockDataLoading = false;
    const ADMIN_PASSWORD = "admin"; // è¯·ä¿®æ”¹ä¸ºå®‰å…¨å¯†ç 
    
    // åº“å­˜é˜ˆå€¼è®¾ç½®
    const STOCK_THRESHOLDS = {
        urgent: 10,   // ç´§æ€¥åº“å­˜ï¼ˆ<=10ç®±ï¼‰
        low: 50,      // ä½åº“å­˜ï¼ˆ<=50ç®±ï¼‰
        medium: 100   // ä¸­ç­‰åº“å­˜ï¼ˆ<=100ç®±ï¼‰
    };

    // ç³»ç»Ÿåˆå§‹åŒ–å‡½æ•°
    function initSystem() {
        // æ˜¾ç¤ºå½“å‰æ—¥æœŸ
        const now = new Date();
        document.getElementById('date').textContent = 
            `${now.getFullYear()}/${(now.getMonth()+1).toString().padStart(2, '0')}/${now.getDate().toString().padStart(2, '0')}`;

        // ç»‘å®šç®¡ç†å‘˜ç™»å½•æŒ‰é’®äº‹ä»¶
        document.getElementById('adminLoginBtn').addEventListener('click', authenticateAdmin);
        
        // ä¸ºæ¸…ç©ºæŒ‰é’®æ·»åŠ é¢å¤–çš„äº‹ä»¶ç›‘å¬å™¨ï¼Œç¡®ä¿èƒ½å“åº”
        document.getElementById('clearButton').addEventListener('click', clearAll);
        
        // æ£€æŸ¥ç½‘ç»œçŠ¶æ€
        isOfflineMode = !navigator.onLine;
        if (isOfflineMode) {
            document.getElementById('offlineNotice').style.display = 'block';
        }

        // ä¼˜å…ˆåŠ è½½åº“å­˜æ•°æ®
        loadStockData();

        // æ¢å¤æœ¬åœ°è®¡åˆ’æ•°æ®
        restoreSavedData();
        
        // è®¾ç½®å®æ—¶ç›‘å¬ï¼Œå½“åº“å­˜æ•°æ®å˜åŒ–æ—¶è‡ªåŠ¨æ›´æ–°æ‰€æœ‰ç”¨æˆ·
        firebase.onValue(firebase.stockRef, (snapshot) => {
            const data = snapshot.val();
            if (data && data.stockData) {
                stockData = data.stockData;
                updateLastUpdateTime(data.updateTime);
                
                // ç¼“å­˜åˆ°æœ¬åœ°
                localStorage.setItem('cachedStockData', JSON.stringify(stockData));
                localStorage.setItem('cachedStockTime', data.updateTime);
                
                // å¦‚æœå½“å‰åœ¨åº“å­˜ç®¡ç†é¡µé¢ï¼Œåˆ·æ–°æ•°æ®
                if (currentMode === 'stock') {
                    if (currentStockTab === 'search') {
                        // å¦‚æœåœ¨æŸ¥è¯¢é¡µé¢ä¸”æœ‰æŸ¥è¯¢å†…å®¹ï¼Œé‡æ–°æŸ¥è¯¢
                        const currentSearch = document.getElementById('stockCode').value.trim();
                        if (currentSearch) {
                            searchStock();
                        }
                    } else {
                        // å¦‚æœåœ¨å®Œæ•´åº“å­˜è¡¨é¡µé¢ï¼Œåˆ·æ–°è¡¨æ ¼
                        displayFullStockTable();
                    }
                }
                
                showToast('åº“å­˜æ•°æ®å·²æ›´æ–°');
            }
        });
    }

    // åˆ‡æ¢åº“å­˜ç®¡ç†é€‰é¡¹å¡
    function switchStockTab(tabName) {
        currentStockTab = tabName;
        
        // æ›´æ–°é€‰é¡¹å¡æ ·å¼
        document.querySelectorAll('.stock-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelector(`.stock-tab[onclick="switchStockTab('${tabName}')"]`).classList.add('active');
        
        // æ›´æ–°å†…å®¹æ˜¾ç¤º
        document.querySelectorAll('.stock-tab-content').forEach(content => {
            content.classList.remove('active');
        });
        document.getElementById(`${tabName}-tab-content`).classList.add('active');
        
        // å¦‚æœåˆ‡æ¢åˆ°å®Œæ•´åº“å­˜è¡¨ï¼Œç¡®ä¿æ•°æ®å·²åŠ è½½å¹¶æ˜¾ç¤º
        if (tabName === 'full') {
            if (stockData.length === 0 && !isStockDataLoading) {
                loadStockData();
            } else {
                displayFullStockTable();
            }
        }
    }

    // æ˜¾ç¤ºå®Œæ•´åº“å­˜è¡¨ï¼ˆæŒ‰æ•°é‡ä»å¤šåˆ°å°‘æ’åˆ—ï¼‰
    function displayFullStockTable() {
        const table = document.getElementById('full-stock-table');
        const tbody = document.getElementById('full-stock-body');
        const message = document.getElementById('full-stock-message');
        
        // æ¸…ç©ºä¹‹å‰çš„ç»“æœ
        table.style.display = 'none';
        tbody.innerHTML = '';
        message.textContent = '';
        
        // æ£€æŸ¥æ•°æ®åŠ è½½çŠ¶æ€
        if (isStockDataLoading) {
            message.textContent = 'æ­£åœ¨åŠ è½½åº“å­˜æ•°æ®...';
            return;
        }
        
        // æ£€æŸ¥æ˜¯å¦æœ‰åº“å­˜æ•°æ®
        if (stockData.length === 0) {
            message.textContent = 'æš‚æ— åº“å­˜æ•°æ®ï¼Œè¯·ç®¡ç†å‘˜ä¸Šä¼ ';
            return;
        }
        
        try {
            // éªŒè¯åº“å­˜æ•°æ®æ ¼å¼
            if (!Array.isArray(stockData)) {
                throw new Error('åº“å­˜æ•°æ®æ ¼å¼é”™è¯¯ï¼Œä¸æ˜¯æœ‰æ•ˆçš„æ•°ç»„');
            }
            
            // å¤åˆ¶å¹¶æŒ‰æ•°é‡ä»å¤šåˆ°å°‘æ’åº
            const sortedData = [...stockData].sort((a, b) => {
                // ç¡®ä¿æ•°é‡æ˜¯æ•°å­—
                const qtyA = Number(a.quantity) || 0;
                const qtyB = Number(b.quantity) || 0;
                return qtyB - qtyA; // é™åºæ’åˆ—
            });
            
            // æ˜¾ç¤ºè¡¨æ ¼
            table.style.display = 'table';
            message.textContent = '';
            
            // å¡«å……è¡¨æ ¼å†…å®¹
            sortedData.forEach(item => {
                const row = document.createElement('tr');
                
                // æ ¹æ®åº“å­˜æ•°é‡è®¾ç½®æ ·å¼
                let quantityHtml = item.quantity || 0;
                if (quantityHtml <= STOCK_THRESHOLDS.urgent) {
                    quantityHtml = `<span class="stock-urgent">${quantityHtml}</span>`;
                } else if (quantityHtml <= STOCK_THRESHOLDS.low) {
                    quantityHtml = `<span class="stock-low">${quantityHtml}</span>`;
                } else if (quantityHtml <= STOCK_THRESHOLDS.medium) {
                    quantityHtml = `<span class="stock-medium">${quantityHtml}</span>`;
                } else {
                    quantityHtml = `<span class="stock-high">${quantityHtml}</span>`;
                }
                
                row.innerHTML = `
                    <td>${item.code || ''}</td>
                    <td>${item.color || '-'}</td>
                    <td>${quantityHtml}</td>
                    <td>${item.warehouse || '-'}</td>
                `;
                tbody.appendChild(row);
            });
            
        } catch (error) {
            console.error('æ˜¾ç¤ºå®Œæ•´åº“å­˜è¡¨æ—¶å‘ç”Ÿé”™è¯¯:', error);
            message.textContent = `æ˜¾ç¤ºå¤±è´¥: ${error.message}`;
        }
    }

    // æ‰‹åŠ¨åˆ·æ–°åº“å­˜æ•°æ®
    function refreshStockData() {
        if (isStockDataLoading) {
            showToast('æ•°æ®æ­£åœ¨åŠ è½½ä¸­ï¼Œè¯·ç¨å€™');
            return;
        }
        
        if (isOfflineMode) {
            showQueryStatus('info', 'å½“å‰ç¦»çº¿æ¨¡å¼', [
                'å°†å°è¯•åŠ è½½æœ¬åœ°ç¼“å­˜æ•°æ®',
                'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ä»¥è·å–æœ€æ–°æ•°æ®'
            ]);
        } else {
            showToast('æ­£åœ¨åˆ·æ–°åº“å­˜æ•°æ®...');
        }
        
        // å¼ºåˆ¶ä»æœåŠ¡å™¨é‡æ–°åŠ è½½æ•°æ®
        stockData = [];
        loadStockData(true);
    }

    // åŠ è½½åº“å­˜æ•°æ®
    function loadStockData(forceRefresh = false) {
        // æ ‡è®°æ•°æ®åŠ è½½ä¸­
        isStockDataLoading = true;
        showQueryStatus('loading', 'æ­£åœ¨åŠ è½½åº“å­˜æ•°æ®...');
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        document.getElementById('last-update-time').textContent = 'åº“å­˜æœ€åæ›´æ–°æ—¶é—´ï¼šåŠ è½½ä¸­...';
        document.getElementById('full-last-update-time').textContent = 'åº“å­˜æœ€åæ›´æ–°æ—¶é—´ï¼šåŠ è½½ä¸­...';
        
        // å¦‚æœä¸æ˜¯å¼ºåˆ¶åˆ·æ–°ï¼Œå…ˆå°è¯•ä»æœ¬åœ°ç¼“å­˜åŠ è½½
        if (!forceRefresh) {
            const cachedStock = localStorage.getItem('cachedStockData');
            const cachedTime = localStorage.getItem('cachedStockTime');
            
            if (cachedStock) {
                try {
                    stockData = JSON.parse(cachedStock);
                    updateLastUpdateTime(cachedTime);
                    
                    // æ ‡è®°åŠ è½½å®Œæˆ
                    isStockDataLoading = false;
                    hideQueryStatus();
                    
                    // å¦‚æœæœ‰ç¼“å­˜æ•°æ®ï¼Œæ›´æ–°å½“å‰æ˜¾ç¤ºçš„åº“å­˜é¡µé¢
                    if (currentMode === 'stock') {
                        if (currentStockTab === 'search') {
                            // å¦‚æœåœ¨æŸ¥è¯¢é¡µé¢ä¸”æœ‰æŸ¥è¯¢å†…å®¹ï¼Œé‡æ–°æŸ¥è¯¢
                            const currentSearch = document.getElementById('stockCode').value.trim();
                            if (currentSearch) {
                                searchStock();
                            }
                        } else {
                            // å¦‚æœåœ¨å®Œæ•´åº“å­˜è¡¨é¡µé¢ï¼Œæ˜¾ç¤ºè¡¨æ ¼
                            displayFullStockTable();
                        }
                    }
                    
                    // å¦‚æœæ˜¯ç¦»çº¿æ¨¡å¼ï¼Œæç¤ºä½¿ç”¨ç¼“å­˜
                    if (isOfflineMode) {
                        showQueryStatus('info', 'ä½¿ç”¨æœ¬åœ°ç¼“å­˜æ•°æ®', [
                            'æ•°æ®å¯èƒ½ä¸æ˜¯æœ€æ–°çš„',
                            'è”ç½‘åå¯ç‚¹å‡»"åˆ·æ–°åº“å­˜æ•°æ®"è·å–æ›´æ–°'
                        ]);
                    }
                    return; // æˆåŠŸåŠ è½½ç¼“å­˜åç›´æ¥è¿”å›
                } catch (e) {
                    console.error('è§£æç¼“å­˜çš„åº“å­˜æ•°æ®å¤±è´¥', e);
                    stockData = [];
                    showQueryStatus('error', 'ç¼“å­˜æ•°æ®æŸå', [
                        'å°†å°è¯•é‡æ–°åŠ è½½æ•°æ®',
                        'è¯·ç¡®ä¿ç½‘ç»œè¿æ¥æ­£å¸¸'
                    ]);
                }
            }
        }

        // å¦‚æœåœ¨çº¿ï¼Œå°è¯•ä»FirebaseåŠ è½½æœ€æ–°æ•°æ®
        if (!isOfflineMode) {
            firebase.get(firebase.stockRef).then((snapshot) => {
                // æ ‡è®°åŠ è½½å®Œæˆ
                isStockDataLoading = false;
                
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    if (data && data.stockData) {
                        // åªæœ‰å½“æ•°æ®ä¸åŒæ—¶æ‰æ›´æ–°
                        const newDataStr = JSON.stringify(data.stockData);
                        const oldDataStr = JSON.stringify(stockData);
                        
                        if (newDataStr !== oldDataStr || forceRefresh) {
                            stockData = data.stockData;
                            showToast('å·²è·å–æœ€æ–°åº“å­˜æ•°æ®');
                            
                            // æ›´æ–°å½“å‰æ˜¾ç¤ºçš„åº“å­˜é¡µé¢
                            if (currentMode === 'stock') {
                                if (currentStockTab === 'search') {
                                    // å¦‚æœåœ¨æŸ¥è¯¢é¡µé¢ä¸”æœ‰æŸ¥è¯¢å†…å®¹ï¼Œé‡æ–°æŸ¥è¯¢
                                    const currentSearch = document.getElementById('stockCode').value.trim();
                                    if (currentSearch) {
                                        searchStock();
                                    }
                                } else {
                                    // å¦‚æœåœ¨å®Œæ•´åº“å­˜è¡¨é¡µé¢ï¼Œæ˜¾ç¤ºè¡¨æ ¼
                                    displayFullStockTable();
                                }
                            }
                        } else {
                            showToast('åº“å­˜æ•°æ®å·²æ˜¯æœ€æ–°');
                        }
                        
                        updateLastUpdateTime(data.updateTime);
                        
                        // ç¼“å­˜åˆ°æœ¬åœ°
                        localStorage.setItem('cachedStockData', newDataStr);
                        localStorage.setItem('cachedStockTime', data.updateTime);
                        
                        hideQueryStatus();
                    } else {
                        showToast('åº“å­˜æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
                        document.getElementById('last-update-time').textContent = 'åº“å­˜æœ€åæ›´æ–°æ—¶é—´ï¼šæ•°æ®æ ¼å¼é”™è¯¯';
                        document.getElementById('full-last-update-time').textContent = 'åº“å­˜æœ€åæ›´æ–°æ—¶é—´ï¼šæ•°æ®æ ¼å¼é”™è¯¯';
                        showQueryStatus('error', 'åº“å­˜æ•°æ®æ ¼å¼é”™è¯¯', [
                            'è¯·è”ç³»ç®¡ç†å‘˜é‡æ–°ä¸Šä¼ æ•°æ®',
                            'ç¡®è®¤ä¸Šä¼ çš„Excelæ–‡ä»¶ç¬¦åˆæ ¼å¼è¦æ±‚'
                        ]);
                    }
                } else {
                    showToast('å°šæœªæœ‰åº“å­˜æ•°æ®ï¼Œè¯·ç®¡ç†å‘˜ä¸Šä¼ ');
                    document.getElementById('last-update-time').textContent = 'åº“å­˜æœ€åæ›´æ–°æ—¶é—´ï¼šæš‚æ— æ•°æ®';
                    document.getElementById('full-last-update-time').textContent = 'åº“å­˜æœ€åæ›´æ–°æ—¶é—´ï¼šæš‚æ— æ•°æ®';
                    showQueryStatus('info', 'æš‚æ— åº“å­˜æ•°æ®', [
                        'è¯·è”ç³»ç®¡ç†å‘˜ä¸Šä¼ åº“å­˜Excelæ–‡ä»¶',
                        'æ–‡ä»¶éœ€æŒ‰æŒ‡å®šæ ¼å¼å‡†å¤‡ï¼ˆBåˆ—=ç¼–å·ï¼ŒCåˆ—=è‰²å·ï¼ŒJåˆ—=åº“å­˜ï¼‰'
                    ]);
                }
            }).catch((error) => {
                console.error('åŠ è½½åº“å­˜æ•°æ®å¤±è´¥', error);
                isStockDataLoading = false; // æ ‡è®°åŠ è½½å®Œæˆ
                showToast('åŠ è½½åº“å­˜æ•°æ®å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                document.getElementById('last-update-time').textContent = 'åº“å­˜æœ€åæ›´æ–°æ—¶é—´ï¼šåŠ è½½å¤±è´¥';
                document.getElementById('full-last-update-time').textContent = 'åº“å­˜æœ€åæ›´æ–°æ—¶é—´ï¼šåŠ è½½å¤±è´¥';
                showQueryStatus('error', 'åŠ è½½æ•°æ®å¤±è´¥', [
                    'æ£€æŸ¥ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸',
                    'å°è¯•ç‚¹å‡»"åˆ·æ–°åº“å­˜æ•°æ®"é‡æ–°åŠ è½½',
                    'å¦‚æœé—®é¢˜æŒç»­ï¼Œè¯·è”ç³»ç³»ç»Ÿç®¡ç†å‘˜'
                ]);
            });
        } else {
            // ç¦»çº¿ä¸”æ— ç¼“å­˜æ•°æ®çš„æƒ…å†µ
            isStockDataLoading = false;
            showQueryStatus('error', 'æ— å¯ç”¨æ•°æ®', [
                'å½“å‰å¤„äºç¦»çº¿çŠ¶æ€',
                'æ²¡æœ‰æ‰¾åˆ°ç¼“å­˜çš„åº“å­˜æ•°æ®',
                'è¯·è”ç½‘ååˆ·æ–°æ•°æ®'
            ]);
            document.getElementById('last-update-time').textContent = 'åº“å­˜æœ€åæ›´æ–°æ—¶é—´ï¼šæ— æ•°æ®';
            document.getElementById('full-last-update-time').textContent = 'åº“å­˜æœ€åæ›´æ–°æ—¶é—´ï¼šæ— æ•°æ®';
        }
    }

    // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´æ˜¾ç¤º
    function updateLastUpdateTime(timeString) {
        if (timeString) {
            document.getElementById('last-update-time').textContent = `åº“å­˜æœ€åæ›´æ–°æ—¶é—´ï¼š${timeString}`;
            document.getElementById('full-last-update-time').textContent = `åº“å­˜æœ€åæ›´æ–°æ—¶é—´ï¼š${timeString}`;
        } else {
            document.getElementById('last-update-time').textContent = 'åº“å­˜æœ€åæ›´æ–°æ—¶é—´ï¼šä»æœªæ›´æ–°';
            document.getElementById('full-last-update-time').textContent = 'åº“å­˜æœ€åæ›´æ–°æ—¶é—´ï¼šä»æœªæ›´æ–°';
        }
    }

    // åˆ‡æ¢æ¨¡å¼
    function switchMode(mode) {
        currentMode = mode;
        
        // éšè—æ‰€æœ‰æ¨¡å¼å†…å®¹
        document.querySelectorAll('.mode-content').forEach(el => {
            el.classList.remove('active');
        });
        // ç§»é™¤æ‰€æœ‰æ¨¡å¼æŒ‰é’®çš„æ¿€æ´»çŠ¶æ€
        document.querySelectorAll('.mode-selector button').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // æ˜¾ç¤ºé€‰ä¸­çš„æ¨¡å¼
        document.getElementById(`${mode}-content`).classList.add('active');
        document.getElementById(`${mode}-mode`).classList.add('active');
        
        // æ§åˆ¶å…¬å…±å†…å®¹åŒºåŸŸæ˜¾ç¤º
        const commonContent = document.querySelector('.common-content');
        if (mode === 'stock') {
            commonContent.style.display = 'none';
            // åˆ‡æ¢åˆ°åº“å­˜é¡µé¢æ—¶ï¼Œç¡®ä¿æ•°æ®å·²åŠ è½½
            if (stockData.length === 0 && !isStockDataLoading) {
                loadStockData();
            } else if (currentStockTab === 'full') {
                // å¦‚æœå½“å‰æ˜¯å®Œæ•´åº“å­˜è¡¨é€‰é¡¹å¡ï¼Œæ˜¾ç¤ºè¡¨æ ¼
                displayFullStockTable();
            }
        } else {
            commonContent.style.display = 'block';
        }
        
        // ä¿å­˜å½“å‰æ¨¡å¼
        localStorage.setItem('currentMode', mode);
    }

    // å¤„ç†è§„æ ¼é€‰æ‹©å˜åŒ–
    function handleSizeChange() {
        const sizeSelect = document.getElementById('size');
        const customSizeInput = document.getElementById('customSize');
        
        if (sizeSelect.value === 'custom') {
            customSizeInput.style.display = 'block';
        } else {
            customSizeInput.style.display = 'none';
        }
    }

    // æ·»åŠ ç“·ç –åˆ°åˆ—è¡¨
    function addTile() {
        const code = document.getElementById('code').value.trim();
        const sizeSelect = document.getElementById('size');
        let size = sizeSelect.value === 'custom' 
            ? document.getElementById('customSize').value.trim() 
            : sizeSelect.value;
        const quantity = document.getElementById('quantity').value.trim();
        const color = document.getElementById('color').value.trim();
        
        // éªŒè¯å¿…å¡«å­—æ®µ
        if (!code) {
            showToast('è¯·è¾“å…¥ç“·ç –ç¼–å·');
            return;
        }
        if (!size) {
            showToast('è¯·é€‰æ‹©æˆ–è¾“å…¥è§„æ ¼');
            return;
        }
        if (!quantity || isNaN(quantity) || parseInt(quantity) <= 0) {
            showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°é‡');
            return;
        }
        
        // æ·»åŠ åˆ°åˆ—è¡¨
        tileIndex++;
        const tile = {
            id: tileIndex,
            code,
            size,
            quantity: parseInt(quantity),
            color
        };
        
        tiles.push(tile);
        renderTilesList();
        
        // ä¿å­˜æ•°æ®
        saveData();
        
        // æ¸…ç©ºè¾“å…¥æ¡†
        document.getElementById('code').value = '';
        document.getElementById('quantity').value = '';
        document.getElementById('color').value = '';
        document.getElementById('code').focus();
        
        showToast('å·²æ·»åŠ åˆ°åˆ—è¡¨');
    }

    // æ¸²æŸ“ç“·ç –åˆ—è¡¨
    function renderTilesList() {
        const tilesListElement = document.getElementById('tiles-list');
        
        if (tiles.length === 0) {
            tilesListElement.innerHTML = 'å°šæœªæ·»åŠ ç“·ç –';
            return;
        }
        
        let html = '';
        tiles.forEach(tile => {
            html += `
                <div class="tile-item" data-id="${tile.id}">
                    <strong>${tile.code}</strong> ${tile.size} ${tile.color ? `(${tile.color})` : ''} 
                    æ•°é‡: ${tile.quantity}ç®±
                    <button class="gray" style="width: auto; padding: 3px 8px; font-size: 12px; float: right;" 
                            onclick="removeTile(${tile.id})">åˆ é™¤</button>
                </div>
            `;
        });
        
        tilesListElement.innerHTML = html;
    }

    // ä»åˆ—è¡¨ä¸­ç§»é™¤ç“·ç –
    function removeTile(id) {
        tiles = tiles.filter(tile => tile.id !== id);
        renderTilesList();
        saveData();
        showToast('å·²ä»åˆ—è¡¨ä¸­ç§»é™¤');
    }

    // æ¸…ç©ºæ‰€æœ‰ç“·ç –ï¼ˆç¡®ä¿æ­¤å‡½æ•°èƒ½è¢«æ­£ç¡®è°ƒç”¨ï¼‰
    function clearAll() {
        try {
            if (tiles.length === 0) {
                showToast('åˆ—è¡¨å·²ä¸ºç©º');
                return;
            }
            
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ç“·ç –å—ï¼Ÿ')) {
                // æ¸…ç©ºç“·ç –æ•°ç»„
                tiles = [];
                // é‡æ–°æ¸²æŸ“åˆ—è¡¨
                renderTilesList();
                // ä¿å­˜æ¸…ç©ºçŠ¶æ€
                saveData();
                // æ˜¾ç¤ºæˆåŠŸæç¤º
                showToast('å·²æ¸…ç©ºæ‰€æœ‰ç“·ç –');
            }
        } catch (error) {
            console.error('æ¸…ç©ºæ“ä½œå¤±è´¥:', error);
            showToast('æ¸…ç©ºå¤±è´¥ï¼Œè¯·é‡è¯•');
        }
    }

    // ç”Ÿæˆè®¡åˆ’
    function generatePlan() {
        if (tiles.length === 0) {
            showToast('è¯·å…ˆæ·»åŠ ç“·ç –ä¿¡æ¯');
            return;
        }

        let result = '';
        const date = document.getElementById('date').textContent;

        if (currentMode === 'outbound') {
            // å‡ºè´§è®¡åˆ’æ¨¡æ¿ï¼ˆç¼…ç”¸è¯­+ä¸­æ–‡ï¼‰
            const unit = document.getElementById('unit').value || 'æœªå¡«å†™';
            const customer = document.getElementById('customer').value || 'æœªå¡«å†™';
            const paymentStatus = document.getElementById('payment').value === 'yes' ? 'å·²ä»˜æ¬¾' : 'æœªä»˜æ¬¾';
            
            result += `å•ä½æˆ–è½¦ç‰Œï¼š${unit}\n`;
            result += `æ—¥æœŸï¼š${date}\n`;
            result += `å®¢æˆ·ï¼š${customer}ï¼Œ${paymentStatus}ã€‚\n\n`;
            
            tiles.forEach((tile, index) => {
                result += `${index + 1}.á€€á€¯á€’á€ºá€”á€­á€•á€á€º/ç¼–å·ï¼š${tile.code}\n`;
                result += `   á€¡á€œá€»á€¬á€¸á€¡á€”á€¶/è§„æ ¼ï¼š${tile.size}\n`;
                result += `   á€¡á€›á€±á€¬á€„á€ºá€€á€¯á€’á€ºè‰²å·ï¼š${tile.color || 'æ— '}\n`;
                result += `   á€¡á€›á€±á€¡á€á€½á€€á€º/æ•°é‡ï¼š${tile.quantity}ç®±\n\n`;
            });
        } else if (currentMode === 'inbound') {
            // æµ·è¿å…¥åº“æ¨¡æ¿ï¼ˆç§»é™¤äº†æŸœå·ã€å…¥åº“ä»“åº“å’Œæ—¥æœŸçš„ç¼…ç”¸è¯­å‰ç¼€ï¼‰
            const containerNo = document.getElementById('containerNo').value || 'æœªå¡«å†™';
            const warehouse = document.getElementById('warehouse').value || 'æœªå¡«å†™';
            
            result += `æŸœå·ï¼š${containerNo}\n`;
            result += `å…¥åº“ä»“åº“ï¼š${warehouse}\n`;
            result += `æ—¥æœŸï¼š${date}\n\n`;
            
            tiles.forEach((tile, index) => {
                result += `${index + 1}.á€€á€¯á€’á€ºá€”á€­á€•á€á€º/ç¼–å·ï¼š${tile.code}\n`;
                result += `   á€¡á€œá€»á€¬á€¸á€¡á€”á€¶/è§„æ ¼ï¼š${tile.size}\n`;
                result += `   á€¡á€›á€±á€¬á€„á€ºá€€á€¯á€’á€ºè‰²å·ï¼š${tile.color || 'æ— '}\n`;
                result += `   á€¡á€›á€±á€¡á€á€½á€€á€º/æ•°é‡ï¼š${tile.quantity}ç®±\n\n`;
            });
        }

        document.getElementById('result').textContent = result;
        showToast('è®¡åˆ’ç”ŸæˆæˆåŠŸ');
    }

    // å¤åˆ¶è®¡åˆ’ç»“æœ
    function copyResult() {
        const resultElement = document.getElementById('result');
        const result = resultElement.textContent;
        const copyButton = document.getElementById('copyButton');
        
        if (!result) {
            showToast('æ²¡æœ‰å¯å¤åˆ¶çš„å†…å®¹');
            return;
        }
        
        // é‡ç½®æŒ‰é’®çŠ¶æ€
        copyButton.classList.remove('copied');
        
        // æ–¹æ³•1ï¼šå°è¯•ä½¿ç”¨ç°ä»£å‰ªè´´æ¿API
        if (navigator.clipboard) {
            navigator.clipboard.writeText(result).then(() => {
                confirmCopySuccess(copyButton);
            }).catch(err => {
                console.log('å‰ªè´´æ¿APIå¤±è´¥ï¼Œå°è¯•å¤‡é€‰æ–¹æ³•', err);
                fallbackCopyMethod(resultElement, copyButton);
            });
        } else {
            // ç›´æ¥ä½¿ç”¨å¤‡é€‰æ–¹æ³•
            fallbackCopyMethod(resultElement, copyButton);
        }
    }
    
    // å¤åˆ¶åº“å­˜æŸ¥è¯¢ç»“æœï¼ˆæŒ‰æŒ‡å®šæ ¼å¼ï¼‰
    function copyStockResults() {
        const table = document.getElementById('stock-result-table');
        const copyButton = document.getElementById('stockCopyButton');
        
        // é‡ç½®æŒ‰é’®çŠ¶æ€
        copyButton.classList.remove('copied');
        
        // æ£€æŸ¥æ˜¯å¦æœ‰æŸ¥è¯¢ç»“æœ
        if (table.style.display !== 'table') {
            showToast('è¯·å…ˆæŸ¥è¯¢åº“å­˜æ•°æ®');
            return;
        }
        
        // è·å–è¡¨æ ¼ä¸­çš„æ‰€æœ‰è¡Œ
        const rows = table.querySelectorAll('tbody tr');
        if (rows.length === 0) {
            showToast('æ²¡æœ‰å¯å¤åˆ¶çš„æŸ¥è¯¢ç»“æœ');
            return;
        }
        
        // æ„å»ºå¤åˆ¶å†…å®¹
        let copyContent = '';
        rows.forEach((row, index) => {
            // å¦‚æœæ˜¯å¤šæ¡è®°å½•ï¼Œæ·»åŠ åˆ†éš”ç¬¦
            if (index > 0) {
                copyContent += '\n--------------------\n';
            }
            
            // è·å–æ¯è¡Œçš„æ•°æ®
            const cells = row.querySelectorAll('td');
            if (cells.length >= 4) {
                // æå–çº¯æ–‡æœ¬å†…å®¹ï¼ˆå»é™¤HTMLæ ‡ç­¾ï¼‰
                const code = cells[0].textContent.trim();
                const color = cells[1].textContent.trim() || 'æ— ';
                const quantity = cells[2].textContent.trim();
                const warehouse = cells[3].textContent.trim() || 'æœªæŒ‡å®š';
                
                // æŒ‰æŒ‡å®šæ ¼å¼æ‹¼æ¥
                copyContent += `ç¼–å·ï¼š${code}\n`;
                copyContent += `è‰²å·ï¼š${color}\n`;
                copyContent += `æ•°é‡ï¼š${quantity}ç®±\n`;
                copyContent += `æ‰€åœ¨ä»“åº“ï¼š${warehouse}\n`;
            }
        });
        
        // å¤åˆ¶åˆ°å‰ªè´´æ¿
        if (navigator.clipboard) {
            navigator.clipboard.writeText(copyContent).then(() => {
                confirmCopySuccess(copyButton);
                showToast(`å·²å¤åˆ¶ ${rows.length} æ¡è®°å½•`);
            }).catch(err => {
                console.log('å‰ªè´´æ¿APIå¤±è´¥ï¼Œå°è¯•å¤‡é€‰æ–¹æ³•', err);
                // åˆ›å»ºä¸´æ—¶å…ƒç´ ç”¨äºå¤åˆ¶
                const tempElement = document.createElement('textarea');
                tempElement.value = copyContent;
                document.body.appendChild(tempElement);
                tempElement.select();
                document.execCommand('copy');
                document.body.removeChild(tempElement);
                
                confirmCopySuccess(copyButton);
                showToast(`å·²å¤åˆ¶ ${rows.length} æ¡è®°å½•`);
            });
        }
    }
    
    // å¤‡é€‰å¤åˆ¶æ–¹æ³•ï¼ˆå…¼å®¹æ—§æµè§ˆå™¨ï¼‰
    function fallbackCopyMethod(element, button) {
        // é€‰ä¸­å†…å®¹
        const range = document.createRange();
        range.selectNode(element);
        const selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(range);
        
        try {
            // å°è¯•æ‰§è¡Œå¤åˆ¶å‘½ä»¤
            const successful = document.execCommand('copy');
            if (successful) {
                confirmCopySuccess(button);
            } else {
                throw new Error('å¤åˆ¶å‘½ä»¤æ‰§è¡Œå¤±è´¥');
            }
        } catch (err) {
            console.error('æ‰€æœ‰å¤åˆ¶æ–¹æ³•éƒ½å¤±è´¥äº†', err);
            showToast('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ (Ctrl+C)');
        } finally {
            // æ¸…é™¤é€‰ä¸­çŠ¶æ€
            selection.removeAllRanges();
        }
    }
    
    // ç¡®è®¤å¤åˆ¶æˆåŠŸå¹¶æä¾›è§†è§‰åé¦ˆ
    function confirmCopySuccess(button) {
        // æ·»åŠ æˆåŠŸæ ·å¼
        button.classList.add('copied');
        
        // 3ç§’åç§»é™¤æˆåŠŸæ ·å¼
        setTimeout(() => {
            button.classList.remove('copied');
        }, 3000);
    }

    // æœç´¢åº“å­˜
    function searchStock() {
        // é‡ç½®æ‰€æœ‰çŠ¶æ€
        const queryStatus = document.getElementById('queryStatus');
        const table = document.getElementById('stock-result-table');
        const tbody = document.getElementById('stock-result-body');
        const message = document.getElementById('stock-result-message');
        const searchCode = document.getElementById('stockCode').value.trim().toLowerCase();
        
        // æ¸…ç©ºä¹‹å‰çš„ç»“æœ
        table.style.display = 'none';
        tbody.innerHTML = '';
        message.textContent = '';
        
        // æ˜¾ç¤ºæŸ¥è¯¢ä¸­çŠ¶æ€
        showQueryStatus('loading', `æ­£åœ¨æŸ¥è¯¢åŒ…å«"${searchCode}"çš„åº“å­˜...`);
        
        // 1. éªŒè¯æŸ¥è¯¢æ¡ä»¶
        if (!searchCode) {
            showQueryStatus('error', 'æŸ¥è¯¢æ¡ä»¶ä¸ºç©º', [
                'è¯·åœ¨è¾“å…¥æ¡†ä¸­å¡«å†™ç“·ç –ç¼–å·å…³é”®è¯',
                'æ”¯æŒæ¨¡ç³ŠæŸ¥è¯¢ï¼Œåªéœ€è¾“å…¥éƒ¨åˆ†ç¼–å·å³å¯'
            ]);
            return;
        }
        
        // 2. æ£€æŸ¥æ•°æ®åŠ è½½çŠ¶æ€
        if (isStockDataLoading) {
            showQueryStatus('info', 'æ•°æ®æ­£åœ¨åŠ è½½ä¸­', [
                'è¯·ç¨å€™ç‰‡åˆ»å†å°è¯•æŸ¥è¯¢',
                'ç­‰å¾…åº“å­˜æ•°æ®åŠ è½½å®Œæˆ'
            ]);
            return;
        }
        
        // 3. æ£€æŸ¥æ˜¯å¦æœ‰åº“å­˜æ•°æ®
        if (stockData.length === 0) {
            showQueryStatus('error', 'æ— åº“å­˜æ•°æ®å¯æŸ¥è¯¢', [
                'è¯·ç¡®è®¤ç®¡ç†å‘˜å·²ä¸Šä¼ åº“å­˜æ•°æ®',
                'ç‚¹å‡»"åˆ·æ–°åº“å­˜æ•°æ®"æŒ‰é’®å°è¯•é‡æ–°åŠ è½½',
                'æ£€æŸ¥ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸'
            ]);
            return;
        }
        
        try {
            // 4. éªŒè¯åº“å­˜æ•°æ®æ ¼å¼
            if (!Array.isArray(stockData)) {
                throw new Error('åº“å­˜æ•°æ®æ ¼å¼é”™è¯¯ï¼Œä¸æ˜¯æœ‰æ•ˆçš„æ•°ç»„');
            }
            
            // 5. æ‰§è¡ŒæŸ¥è¯¢é€»è¾‘
            const matchedItems = stockData.filter(item => {
                // ç¡®ä¿itemæ˜¯å¯¹è±¡ä¸”åŒ…å«codeå±æ€§
                if (typeof item !== 'object' || item === null || !item.code) {
                    return false;
                }
                // æ‰§è¡Œæ¨¡ç³ŠåŒ¹é…
                return item.code.toString().toLowerCase().includes(searchCode);
            });
            
            // 6. å¤„ç†æŸ¥è¯¢ç»“æœ
            if (matchedItems.length === 0) {
                hideQueryStatus();
                message.textContent = `æœªæ‰¾åˆ°åŒ…å«"${searchCode}"çš„ç“·ç –`;
                showToast('æœªæ‰¾åˆ°åŒ¹é…çš„ç“·ç –');
                
                // æä¾›è¿›ä¸€æ­¥æ’æŸ¥å»ºè®®
                if (searchCode.length < 2) {
                    showQueryStatus('info', 'æŸ¥è¯¢ç»“æœä¸ºç©º', [
                        'å°è¯•è¾“å…¥æ›´é•¿çš„ç¼–å·ç‰‡æ®µ',
                        'æ£€æŸ¥è¾“å…¥çš„ç¼–å·æ˜¯å¦æ­£ç¡®',
                        'ç¡®è®¤åº“å­˜ä¸­æ˜¯å¦å­˜åœ¨è¯¥ç¼–å·'
                    ]);
                }
                return;
            }
            
            // 7. æ˜¾ç¤ºæŸ¥è¯¢æˆåŠŸç»“æœ
            hideQueryStatus();
            table.style.display = 'table';
            message.textContent = '';
            
            // å¡«å……è¡¨æ ¼å†…å®¹
            matchedItems.forEach(item => {
                const row = document.createElement('tr');
                
                // é«˜äº®æ˜¾ç¤ºåŒ¹é…çš„æ–‡æœ¬
                let codeHtml = item.code || '';
                const index = codeHtml.toLowerCase().indexOf(searchCode);
                if (index !== -1) {
                    const before = codeHtml.substring(0, index);
                    const match = codeHtml.substring(index, index + searchCode.length);
                    const after = codeHtml.substring(index + searchCode.length);
                    codeHtml = `${before}<span class="search-highlight">${match}</span>${after}`;
                }
                
                // æ ¹æ®åº“å­˜æ•°é‡è®¾ç½®æ ·å¼
                let quantityHtml = item.quantity || 0;
                if (quantityHtml <= STOCK_THRESHOLDS.urgent) {
                    quantityHtml = `<span class="stock-urgent">${quantityHtml}</span>`;
                } else if (quantityHtml <= STOCK_THRESHOLDS.low) {
                    quantityHtml = `<span class="stock-low">${quantityHtml}</span>`;
                } else if (quantityHtml <= STOCK_THRESHOLDS.medium) {
                    quantityHtml = `<span class="stock-medium">${quantityHtml}</span>`;
                } else {
                    quantityHtml = `<span class="stock-high">${quantityHtml}</span>`;
                }
                
                row.innerHTML = `
                    <td>${codeHtml}</td>
                    <td>${item.color || '-'}</td>
                    <td>${quantityHtml}</td>
                    <td>${item.warehouse || '-'}</td>
                `;
                tbody.appendChild(row);
            });
            
            showToast(`æ‰¾åˆ° ${matchedItems.length} æ¡åŒ¹é…ç»“æœ`);
            
        } catch (error) {
            // 8. å¤„ç†æŸ¥è¯¢è¿‡ç¨‹ä¸­çš„é”™è¯¯
            console.error('æŸ¥è¯¢åº“å­˜æ—¶å‘ç”Ÿé”™è¯¯:', error);
            showQueryStatus('error', 'æŸ¥è¯¢è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯', [
                `é”™è¯¯è¯¦æƒ…: ${error.message}`,
                'è¯·å°è¯•åˆ·æ–°é¡µé¢åé‡æ–°æŸ¥è¯¢',
                'å¦‚æœé—®é¢˜æŒç»­ï¼Œè¯·è”ç³»ç®¡ç†å‘˜'
            ]);
            message.textContent = 'æŸ¥è¯¢å¤±è´¥ï¼Œè¯·å‚è€ƒä¸Šæ–¹æç¤ºè§£å†³';
        }
    }

    // æ˜¾ç¤ºæŸ¥è¯¢çŠ¶æ€æç¤º
    function showQueryStatus(type, message, troubleshooting = []) {
        const statusElement = document.getElementById('queryStatus');
        
        // æ¸…é™¤æ‰€æœ‰çŠ¶æ€ç±»
        statusElement.className = 'query-status';
        
        // æ·»åŠ å½“å‰çŠ¶æ€ç±»
        statusElement.classList.add(`status-${type}`);
        
        // æ„å»ºçŠ¶æ€HTML
        let html = `<strong>${message}</strong>`;
        
        // æ·»åŠ æ’æŸ¥æ­¥éª¤ï¼ˆå¦‚æœæœ‰ï¼‰
        if (troubleshooting && troubleshooting.length > 0) {
            html += '<div class="troubleshoot"><strong>æ’æŸ¥å»ºè®®ï¼š</strong><ul>';
            troubleshooting.forEach(step => {
                html += `<li>${step}</li>`;
            });
            html += '</ul></div>';
        }
        
        statusElement.innerHTML = html;
    }

    // éšè—æŸ¥è¯¢çŠ¶æ€æç¤º
    function hideQueryStatus() {
        const statusElement = document.getElementById('queryStatus');
        statusElement.className = 'query-status';
        statusElement.innerHTML = '';
    }

    // ç®¡ç†å‘˜è®¤è¯
    function authenticateAdmin() {
        const password = document.getElementById('adminPassword').value;
        const errorElement = document.getElementById('adminError');
        
        if (!password) {
            errorElement.textContent = 'è¯·è¾“å…¥å¯†ç ';
            errorElement.style.display = 'block';
            return;
        }
        
        if (password === ADMIN_PASSWORD) {
            // ç™»å½•æˆåŠŸ
            isAdmin = true;
            document.getElementById('adminSection').style.display = 'block';
            document.getElementById('adminPassword').value = '';
            errorElement.style.display = 'none';
            showToast('ç®¡ç†å‘˜ç™»å½•æˆåŠŸ');
        } else {
            // å¯†ç é”™è¯¯
            errorElement.textContent = 'å¯†ç é”™è¯¯';
            errorElement.style.display = 'block';
        }
    }

    // é€€å‡ºç®¡ç†å‘˜æ¨¡å¼
    function logoutAdmin() {
        isAdmin = false;
        document.getElementById('adminSection').style.display = 'none';
        showToast('å·²é€€å‡ºç®¡ç†å‘˜æ¨¡å¼');
    }

    // å¤„ç†ç®¡ç†å‘˜ä¸Šä¼ çš„Excelæ–‡ä»¶
    function handleAdminFileUpload(event) {
        if (!isAdmin) {
            showToast('è¯·å…ˆä»¥ç®¡ç†å‘˜èº«ä»½ç™»å½•');
            return;
        }
        
        if (isOfflineMode) {
            showToast('å½“å‰ç¦»çº¿ï¼Œæ— æ³•æ›´æ–°åº“å­˜æ•°æ®');
            return;
        }
        
        const file = event.target.files[0];
        if (!file) return;
        
        const syncStatus = document.getElementById('syncStatus');
        syncStatus.textContent = 'æ­£åœ¨è§£ææ–‡ä»¶...';
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                
                // è·å–æ‰€æœ‰å•å…ƒæ ¼
                const range = XLSX.utils.decode_range(worksheet['!ref'] || 'A1:A1');
                const stockData = [];
                let validRowCount = 0;
                let invalidRowCount = 0;
                
                // ä»ç¬¬äºŒè¡Œå¼€å§‹è¯»å–ï¼ˆè·³è¿‡è¡¨å¤´ï¼‰
                for (let row = range.s.r + 1; row <= range.e.r; row++) {
                    try {
                        // æŒ‰æŒ‡å®šåˆ—è¯»å–æ•°æ®ï¼ˆBåˆ—=1, Cåˆ—=2, Jåˆ—=9ï¼ŒExcelåˆ—ä»0å¼€å§‹è®¡æ•°ï¼‰
                        const codeCell = worksheet[XLSX.utils.encode_cell({ r: row, c: 1 })]; // Båˆ—
                        const colorCell = worksheet[XLSX.utils.encode_cell({ r: row, c: 2 })]; // Cåˆ—
                        const quantityCell = worksheet[XLSX.utils.encode_cell({ r: row, c: 9 })]; // Jåˆ—
                        
                        // è·å–å•å…ƒæ ¼å€¼
                        const code = codeCell ? (codeCell.v || '').toString().trim() : '';
                        const color = colorCell ? (colorCell.v || '').toString().trim() : '';
                        const quantity = quantityCell ? Number(quantityCell.v) : 0;
                        
                        // éªŒè¯å¿…è¦æ•°æ®
                        if (!code || isNaN(quantity) || quantity < 0) {
                            invalidRowCount++;
                            continue; // è·³è¿‡æ— æ•ˆè¡Œ
                        }
                        
                        // æ·»åŠ åˆ°åº“å­˜æ•°æ®
                        stockData.push({
                            code,
                            color,
                            quantity,
                            warehouse: '1å·ä»“åº“'
                        });
                        
                        validRowCount++;
                    } catch (rowError) {
                        invalidRowCount++;
                        console.error(`å¤„ç†è¡Œ ${row + 1} æ—¶å‡ºé”™:`, rowError);
                    }
                }
                
                // æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆæ•°æ®
                if (validRowCount === 0) {
                    syncStatus.textContent = `æœªæ‰¾åˆ°æœ‰æ•ˆæ•°æ®ï¼Œå…±è·³è¿‡ ${invalidRowCount} è¡Œ`;
                    showToast('æœªæ‰¾åˆ°æœ‰æ•ˆæ•°æ®ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼');
                    return;
                }
                
                syncStatus.textContent = `è§£æå®Œæˆï¼šæœ‰æ•ˆæ•°æ® ${validRowCount} è¡Œï¼Œæ­£åœ¨åŒæ­¥åˆ°æœåŠ¡å™¨...`;
                
                // å‡†å¤‡è¦ä¿å­˜çš„æ•°æ®ï¼ˆåŒ…å«æ—¶é—´æˆ³ï¼‰
                const saveData = {
                    stockData: stockData,
                    updateTime: new Date().toLocaleString()
                };
                
                // ä¿å­˜åˆ°Firebase
                firebase.set(firebase.stockRef, saveData).then(() => {
                    syncStatus.textContent = `åº“å­˜æ•°æ®å·²æˆåŠŸæ›´æ–°ï¼Œå…±å¯¼å…¥ ${validRowCount} æ¡è®°å½•`;
                    showToast(`åº“å­˜æ•°æ®æ›´æ–°æˆåŠŸï¼Œå¯¼å…¥ ${validRowCount} æ¡è®°å½•`);
                    
                    // æ›´æ–°æœ¬åœ°ç¼“å­˜
                    localStorage.setItem('cachedStockData', JSON.stringify(stockData));
                    localStorage.setItem('cachedStockTime', saveData.updateTime);
                    
                    // æ›´æ–°å½“å‰å†…å­˜ä¸­çš„åº“å­˜æ•°æ®
                    window.stockData = stockData;
                    
                    // å¦‚æœåœ¨åº“å­˜ç®¡ç†é¡µé¢ï¼Œåˆ·æ–°æ˜¾ç¤º
                    if (currentMode === 'stock') {
                        if (currentStockTab === 'search') {
                            // å¦‚æœåœ¨æŸ¥è¯¢é¡µé¢ä¸”æœ‰æŸ¥è¯¢å†…å®¹ï¼Œé‡æ–°æŸ¥è¯¢
                            const currentSearch = document.getElementById('stockCode').value.trim();
                            if (currentSearch) {
                                searchStock();
                            }
                        } else {
                            // å¦‚æœåœ¨å®Œæ•´åº“å­˜è¡¨é¡µé¢ï¼Œåˆ·æ–°è¡¨æ ¼
                            displayFullStockTable();
                        }
                    }
                    
                    // é‡ç½®æ–‡ä»¶è¾“å…¥
                    document.getElementById('adminFileInput').value = '';
                }).catch((error) => {
                    console.error('æ›´æ–°åº“å­˜æ•°æ®å¤±è´¥', error);
                    syncStatus.textContent = 'æ›´æ–°å¤±è´¥ï¼Œè¯·é‡è¯•';
                    showToast('æ›´æ–°åº“å­˜æ•°æ®å¤±è´¥');
                });
                
            } catch (error) {
                console.error('è§£æExcelæ–‡ä»¶å¤±è´¥', error);
                syncStatus.textContent = `æ–‡ä»¶è§£æå¤±è´¥: ${error.message}`;
                showToast('æ–‡ä»¶è§£æå¤±è´¥');
            }
        };
        
        reader.readAsArrayBuffer(file);
    }

    // ä¿å­˜æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
    function saveData() {
        const saveData = {
            tiles,
            tileIndex,
            customer: document.getElementById('customer').value,
            payment: document.getElementById('payment').value,
            unit: document.getElementById('unit').value,
            containerNo: document.getElementById('containerNo').value,
            warehouse: document.getElementById('warehouse').value,
            currentMode
        };
        
        localStorage.setItem('tileManagementData', JSON.stringify(saveData));
    }

    // ä»æœ¬åœ°å­˜å‚¨æ¢å¤æ•°æ®
    function restoreSavedData() {
        const savedData = localStorage.getItem('tileManagementData');
        
        if (savedData) {
            try {
                const data = JSON.parse(savedData);
                
                // æ¢å¤ç“·ç –åˆ—è¡¨
                if (data.tiles && Array.isArray(data.tiles)) {
                    tiles = data.tiles;
                    renderTilesList();
                }
                
                // æ¢å¤å…¶ä»–æ•°æ®
                if (data.tileIndex) tileIndex = data.tileIndex;
                if (data.customer) document.getElementById('customer').value = data.customer;
                if (data.payment) document.getElementById('payment').value = data.payment;
                if (data.unit) document.getElementById('unit').value = data.unit;
                if (data.containerNo) document.getElementById('containerNo').value = data.containerNo;
                if (data.warehouse) document.getElementById('warehouse').value = data.warehouse;
                
                // æ¢å¤æ¨¡å¼
                if (data.currentMode) {
                    switchMode(data.currentMode);
                }
                
            } catch (e) {
                console.error('æ¢å¤ä¿å­˜çš„æ•°æ®å¤±è´¥', e);
            }
        }
    }

    // æ˜¾ç¤ºæç¤ºä¿¡æ¯
    function showToast(message) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.style.display = 'block';
        
        setTimeout(() => {
            toast.style.display = 'none';
        }, 3000);
    }
</script>
</body>
</html>
