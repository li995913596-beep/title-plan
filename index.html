<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>ç“·ç –åº“å­˜ç®¡ç†ç³»ç»Ÿ</title>
<!-- å¼•å…¥Excelå¤„ç†åº“ -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<!-- å¼•å…¥Firebase -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, get } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";
    import { getStorage, ref as storageRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-storage.js";
    
    const firebaseConfig = {
        apiKey: "AIzaSyC65DEOgj4WeksRRVmw4ZTrNkCB83SoQpI",
        authDomain: "tile-management-system-f5db8.firebaseapp.com",
        databaseURL: "https://tile-management-system-f5db8-default-rtdb.firebaseio.com",
        projectId: "tile-management-system-f5db8",
        storageBucket: "tile-management-system-f5db8.appspot.com",
        messagingSenderId: "925027091187",
        appId: "1:925027091187:web:a2bb160b629f541abded86"
    };

    try {
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const storage = getStorage(app);
        const stockRef = ref(database, 'tileStock');
        const imagesRef = ref(database, 'tileImages');
        
        window.firebase = { 
            app, database, ref, set, onValue, get, stockRef,
            storage, storageRef, uploadBytesResumable, getDownloadURL, imagesRef
        };
        window.firebaseInitialized = true;
    } catch (error) {
        window.firebaseInitialized = false;
        window.firebaseError = error.message;
    }
</script>
<!-- å¼•å…¥EChartsç”¨äºå¯è§†åŒ– -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
<style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
    body { padding: 10px; background-color: #f5f5f5; }
    .container { max-width: 1200px; margin: 0 auto; }
    .card { background: white; padding: 15px; margin-bottom: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    h1, h2, h3 { margin-bottom: 12px; color: #333; position: relative; padding-bottom: 5px; }
    /* æ ‡é¢˜è‹±æ–‡ç¿»è¯‘æ ·å¼ */
    h1 .en-trans, h2 .en-trans, h3 .en-trans {
        font-size: 0.7em;
        color: #888;
        font-weight: normal;
        display: block;
        margin-top: 3px;
    }
    h1 { text-align: center; color: #4F46E5; font-size: 22px; padding: 8px 0; }
    .form-group { margin-bottom: 12px; }
    label { display: block; margin-bottom: 5px; font-size: 14px; color: #666; }
    input, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
    button { background-color: #4F46E5; color: white; border: none; padding: 10px; border-radius: 4px; width: 100%; font-size: 15px; margin-top: 8px; cursor: pointer; transition: background 0.3s; }
    button:hover { background-color: #4338ca; }
    button.secondary { background-color: #10B981; }
    button.gray { background-color: #f0f0f0; color: #666; }
    button.admin { background-color: #f59e0b; }
    .flex-row { display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
    .flex-row button { flex: 1; min-width: 120px; }
    .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); color: white; padding: 10px 15px; border-radius: 4px; display: none; z-index: 1000; }
    .last-update { font-size: 12px; color: #666; margin-top: 8px; text-align: right; }
    .admin-section { margin: 15px 0; padding: 15px; background-color: #fff3cd; border-radius: 8px; display: none; }
    
    /* è¡¨æ ¼æ ·å¼ - ç§»åŠ¨ç«¯é€‚é…ä¼˜åŒ– */
    .stock-table { width: 100%; border-collapse: collapse; margin-top: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .stock-table th { padding: 10px 8px; text-align: left; background-color: #4F46E5; color: white; font-weight: bold; font-size: 13px; }
    .stock-table td { padding: 10px 8px; text-align: left; border-bottom: 1px solid #eee; font-size: 13px; }
    .stock-table tr:hover { background-color: #f0f7ff; }
    .stock-table tr:nth-child(even) { background-color: #f9f9f9; }
    /* è¡¨æ ¼åˆ—å®½æ§åˆ¶ - ç¡®ä¿ç§»åŠ¨ç«¯æ˜¾ç¤ºå…³é”®ä¿¡æ¯ */
    .stock-table th:nth-child(1), .stock-table td:nth-child(1) { min-width: 100px; } /* ç¼–å· */
    .stock-table th:nth-child(2), .stock-table td:nth-child(2) { min-width: 80px; }  /* è‰²å· */
    .stock-table th:nth-child(3), .stock-table td:nth-child(3) { min-width: 80px; }  /* æ•°é‡ */
    .stock-table th:nth-child(4), .stock-table td:nth-child(4) { min-width: 80px; }  /* ä»“åº“ */
    .stock-table th:nth-child(5), .stock-table td:nth-child(5) { width: 80px; }     /* å›¾ç‰‡ */
    
    /* åº“å­˜çŠ¶æ€æ ·å¼ */
    .stock-urgent { color: white; background-color: #ef4444; padding: 2px 4px; border-radius: 3px; font-weight: bold; font-size: 12px; }
    .stock-low { color: #ef4444; font-weight: bold; }
    .stock-medium { color: #f59e0b; font-weight: bold; }
    .stock-high { color: #10B981; font-weight: bold; }
    
    /* é€‰é¡¹å¡æ ·å¼ */
    .stock-tabs { display: flex; margin-bottom: 15px; border-bottom: 1px solid #ddd; overflow-x: auto; white-space: nowrap; padding-bottom: 5px; }
    .stock-tab { padding: 8px 15px; cursor: pointer; border-bottom: 2px solid transparent; margin-right: 8px; font-size: 14px; }
    .stock-tab.active { border-bottom-color: #4F46E5; color: #4F46E5; font-weight: bold; }
    .stock-tab-content { display: none; }
    .stock-tab-content.active { display: block; }
    
    /* å¯è§†åŒ–åŒºåŸŸ - è§£å†³å›¾è¡¨é‡å é—®é¢˜ */
    .visualization-container { display: flex; flex-wrap: wrap; gap: 15px; margin-top: 15px; }
    .chart-box { width: 100%; height: 350px; min-width: 300px; flex: 1; }
    @media (min-width: 768px) {
        .chart-box { width: calc(50% - 8px); }
    }
    /* è°ƒæ•´å›¾è¡¨æ ‡é¢˜ä½ç½®ï¼Œé¿å…é‡å  */
    .chart-title-fix { margin-bottom: 20px !important; padding-top: 10px; }
    
    /* ä¸Šä¼ åŒºåŸŸ */
    .import-area { border: 2px dashed #4F46E5; border-radius: 8px; padding: 20px; text-align: center; margin: 12px 0; cursor: pointer; transition: all 0.3s; }
    .import-area:hover { background-color: #f0f7ff; }
    .import-icon { font-size: 30px; margin-bottom: 10px; color: #4F46E5; }
    #adminFileInput, #batchImageInput { display: none; }
    
    /* è¡¨æ ¼å®¹å™¨ - ä¼˜åŒ–ç§»åŠ¨ç«¯æ»šåŠ¨ä½“éªŒ */
    .table-container { overflow-x: auto; margin-top: 10px; max-height: 450px; overflow-y: auto; -webkit-overflow-scrolling: touch; }
    
    /* ç®¡ç†å‘˜ç™»å½• */
    .compact-auth { display: flex; gap: 8px; align-items: flex-end; margin: 12px 0; flex-wrap: wrap; }
    .compact-auth .form-group { flex: 1; min-width: 200px; margin: 0; }
    .compact-auth input { padding: 8px; font-size: 14px; }
    .compact-auth button { padding: 8px; font-size: 14px; width: auto; white-space: nowrap; min-width: 80px; }
    .auth-label { font-size: 12px; color: #888; margin-bottom: 3px; display: block; }
    .error-message { color: #dc2626; font-size: 12px; margin-top: 3px; display: none; }
    
    /* å›¾ç‰‡ä¸Šä¼ æ¨¡å— */
    #imageUploadSection, #batchImageUploadSection { margin: 15px 0; padding: 12px; background-color: #f8fafc; border-radius: 6px; }
    #imagePreviewContainer, #batchImagePreviewContainer { display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap; }
    #imagePreviewContainer img, #batchImagePreviewContainer img { width: 80px; height: 80px; object-fit: cover; border-radius: 4px; cursor: pointer; }
    
    /* ä¸Šä¼ è¿›åº¦æ¡ */
    #uploadProgressContainer, #batchUploadProgressContainer { margin: 12px 0; }
    #progressBarContainer, #batchProgressBarContainer { height: 6px; background-color: #eee; border-radius: 3px; overflow: hidden; margin-top: 5px; }
    #progressBar, #batchProgressBar { height: 100%; width: 0%; background-color: #10B981; transition: width 0.3s; }
    
    /* å›¾ç‰‡æŸ¥çœ‹æ ·å¼ */
    .image-thumbnail { width: 60px; height: 60px; object-fit: cover; border-radius: 4px; cursor: pointer; border: 1px solid #ddd; }
    
    /* å›¾ç‰‡é¢„è§ˆå¼¹çª— */
    #imageViewerModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1001; display: none; justify-content: center; align-items: center; padding: 20px; }
    #imageViewerContent { max-width: 100%; max-height: 90%; position: relative; }
    #mainViewerImage { max-width: 100%; max-height: 70vh; border: 3px solid white; border-radius: 4px; }
    #imagePagination { position: absolute; bottom: -30px; left: 50%; transform: translateX(-50%); color: white; display: flex; gap: 8px; }
    .pagination-dot { width: 8px; height: 8px; border-radius: 50%; background-color: rgba(255,255,255,0.5); cursor: pointer; }
    .pagination-dot.active { background-color: white; }
    .image-nav-btn { position: absolute; top: 50%; transform: translateY(-50%); background: transparent; color: white; border: none; font-size: 24px; cursor: pointer; }
    .close-btn { position: absolute; top: -35px; right: 0; background: transparent; color: white; border: none; font-size: 22px; cursor: pointer; }
    
    /* æ‰¹é‡ä¸Šä¼ è¯´æ˜æ ·å¼ */
    .batch-upload-note { font-size: 12px; color: #666; margin-top: 5px; padding: 8px; background-color: #f0f9ff; border-radius: 4px; }
    .batch-upload-note strong { color: #0284c7; }
</style>
</head>
<body>
<div class="container">
    <h1>ç“·ç –åº“å­˜ç®¡ç†ç³»ç»Ÿ
        <span class="en-trans">Tile Inventory Management System</span>
    </h1>
    
    <!-- åº“å­˜ç®¡ç†å†…å®¹ -->
    <div id="stock-content">
        <div class="card">
            <h2>åº“å­˜ç®¡ç†
                <span class="en-trans">Inventory Management</span>
            </h2>
            <!-- é€‰é¡¹å¡ -->
            <div class="stock-tabs">
                <div class="stock-tab active" onclick="switchStockTab('search')">åº“å­˜æŸ¥è¯¢</div>
                <div class="stock-tab" onclick="switchStockTab('full')">å®Œæ•´åº“å­˜è¡¨</div>
                <div class="stock-tab" onclick="switchStockTab('visual')">åº“å­˜å¯è§†åŒ–</div>
            </div>
            
            <!-- æŸ¥è¯¢å†…å®¹ -->
            <div class="stock-tab-content active" id="search-tab-content">
                <div class="form-group">
                    <label>ç“·ç –ç¼–å· (Båˆ—ï¼Œæ”¯æŒæ¨¡ç³ŠæŸ¥è¯¢)
                        <span class="en-trans">Tile Code (B column, supports fuzzy search)</span>
                    </label>
                    <input id="stockCode" placeholder="è¾“å…¥ç¼–å·å…³é”®è¯" type="text"/>
                </div>
                <div class="flex-row">
                    <button onclick="searchStock()">æŸ¥è¯¢åº“å­˜
                        <span class="en-trans">Search Inventory</span>
                    </button>
                    <button class="secondary" onclick="refreshStockData()">åˆ·æ–°æ•°æ®
                        <span class="en-trans">Refresh Data</span>
                    </button>
                </div>
                <div class="last-update" id="last-update-time">åº“å­˜æœ€åæ›´æ–°æ—¶é—´ï¼šåŠ è½½ä¸­...
                    <span class="en-trans">Last updated: Loading...</span>
                </div>
                
                <div class="card" style="margin-top: 12px;">
                    <h3>æŸ¥è¯¢ç»“æœ
                        <span class="en-trans">Search Results</span>
                    </h3>
                    <div class="table-container">
                        <table class="stock-table" id="stock-result-table" style="display: none;">
                            <thead>
                                <tr>
                                    <th>ç¼–å· (Båˆ—)</th>
                                    <th>è‰²å· (Cåˆ—)</th>
                                    <th>æ•°é‡(ç®±) (Jåˆ—)</th>
                                    <th>ä»“åº“</th>
                                    <th>å›¾ç‰‡</th>
                                </tr>
                            </thead>
                            <tbody id="stock-result-body"></tbody>
                        </table>
                        <div id="stock-result-message">è¯·è¾“å…¥ç¼–å·å¹¶ç‚¹å‡»æŸ¥è¯¢
                            <span class="en-trans">Please enter code and click search</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- å®Œæ•´åº“å­˜è¡¨ -->
            <div class="stock-tab-content" id="full-tab-content">
                <button class="secondary" onclick="refreshStockData()">åˆ·æ–°æ•°æ®
                    <span class="en-trans">Refresh Data</span>
                </button>
                <div class="last-update" id="full-last-update-time">åº“å­˜æœ€åæ›´æ–°æ—¶é—´ï¼šåŠ è½½ä¸­...
                    <span class="en-trans">Last updated: Loading...</span>
                </div>
                
                <div class="card" style="margin-top: 12px;">
                    <h3>å®Œæ•´åº“å­˜è¡¨
                        <span class="en-trans">Full Inventory List</span>
                    </h3>
                    <div class="table-container">
                        <table class="stock-table" id="full-stock-table" style="display: none;">
                            <thead>
                                <tr>
                                    <th>ç¼–å· (Båˆ—)</th>
                                    <th>è‰²å· (Cåˆ—)</th>
                                    <th>æ•°é‡(ç®±) (Jåˆ—)</th>
                                    <th>ä»“åº“</th>
                                    <th>å›¾ç‰‡</th>
                                </tr>
                            </thead>
                            <tbody id="full-stock-body"></tbody>
                        </table>
                        <div id="full-stock-message">åŠ è½½åº“å­˜æ•°æ®ä¸­...
                            <span class="en-trans">Loading inventory data...</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- å¯è§†åŒ–å†…å®¹ -->
            <div class="stock-tab-content" id="visual-tab-content">
                <h3 class="chart-title-fix">åº“å­˜æ•°æ®å¯è§†åŒ–
                    <span class="en-trans">Inventory Data Visualization</span>
                </h3>
                <p>åŸºäºå½“å‰åº“å­˜æ•°æ®ç”Ÿæˆçš„ç»Ÿè®¡å›¾è¡¨
                    <span class="en-trans">Statistical charts based on current inventory data</span>
                </p>
                
                <div class="visualization-container">
                    <div class="chart-box" id="warehouse-pie-chart"></div>
                    <div class="chart-box" id="stock-bar-chart"></div>
                </div>
                
                <!-- è°ƒæ•´å›¾è¡¨å®¹å™¨é«˜åº¦å’Œé—´è·ï¼Œè§£å†³é‡å é—®é¢˜ -->
                <div class="chart-box" id="category-bar-chart" style="margin-top: 25px; height: 380px;"></div>
                
                <div class="last-update" style="margin-top: 15px;">
                    å›¾è¡¨æ•°æ®æœ€åæ›´æ–°ï¼š<span id="visual-update-time">åŠ è½½ä¸­...</span>
                    <span class="en-trans">Chart data last updated: <span id="visual-update-time-en">Loading...</span></span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ç®¡ç†å‘˜ç™»å½• -->
    <div class="compact-auth">
        <div class="form-group">
            <span class="auth-label">ç®¡ç†å‘˜å…¥å£
                <span class="en-trans">Admin Access</span>
            </span>
            <input id="adminPassword" placeholder="è¾“å…¥å¯†ç " type="password"/>
            <div class="error-message" id="adminError">å¯†ç é”™è¯¯
                <span class="en-trans">Incorrect password</span>
            </div>
        </div>
        <button class="admin" onclick="authenticateAdmin()">ç™»å½•
            <span class="en-trans">Login</span>
        </button>
    </div>
    
    <!-- ç®¡ç†å‘˜åŠŸèƒ½åŒº -->
    <div class="admin-section" id="adminSection">
        <h2>ç®¡ç†å‘˜åŠŸèƒ½
            <span class="en-trans">Admin Functions</span>
        </h2>
        <p><strong>åˆ—æ˜ å°„è¯´æ˜ï¼š</strong>Båˆ—=ç¼–å·ï¼ŒCåˆ—=è‰²å·ï¼ˆç©ºåˆ™ä¸æ˜¾ç¤ºï¼‰ï¼ŒJåˆ—=æ•°é‡
            <span class="en-trans"><strong>Column mapping:</strong> Column B=Code, Column C=Color, Column J=Quantity</span>
        </p>
        
        <div class="import-area" onclick="document.getElementById('adminFileInput').click()">
            <div class="import-icon">ğŸ“‚</div>
            <p>ç‚¹å‡»æˆ–æ‹–æ‹½Excelæ–‡ä»¶åˆ°æ­¤å¤„ä¸Šä¼ åº“å­˜æ•°æ®
                <span class="en-trans">Click or drag Excel file to upload inventory data</span>
            </p>
            <input accept=".xlsx,.xls" id="adminFileInput" onchange="handleAdminFileUpload(event)" type="file"/>
        </div>
        
        <!-- å·¥ä½œè¡¨é€‰æ‹© -->
        <div id="sheetSelection" style="display: none; margin: 15px 0;">
            <h3>å·¥ä½œè¡¨ä¸ä»“åº“æ˜ å°„
                <span class="en-trans">Worksheet and Warehouse Mapping</span>
            </h3>
            <div id="sheetList"></div>
            <button class="secondary" onclick="previewMappedData()">é¢„è§ˆæ•°æ®
                <span class="en-trans">Preview Data</span>
            </button>
        </div>
        
        <!-- æ•°æ®é¢„è§ˆ -->
        <div id="dataPreview" style="display: none; margin: 15px 0;">
            <h3>æ•°æ®é¢„è§ˆ
                <span class="en-trans">Data Preview</span>
            </h3>
            <div id="previewContent"></div>
            <div class="flex-row" style="margin-top: 12px;">
                <button onclick="saveMappedData()">ç¡®è®¤å¹¶ä¿å­˜
                    <span class="en-trans">Confirm and Save</span>
                </button>
                <button class="gray" onclick="cancelUpload()">å–æ¶ˆ
                    <span class="en-trans">Cancel</span>
                </button>
            </div>
        </div>
        
        <!-- æ‰¹é‡å›¾ç‰‡ä¸Šä¼ æ¨¡å—ï¼ˆæŒ‰æ–‡ä»¶åè‡ªåŠ¨åŒ¹é…ï¼‰ -->
        <div id="batchImageUploadSection">
            <h3>å›¾ç‰‡æ‰¹é‡ä¸Šä¼ ï¼ˆæŒ‰æ–‡ä»¶åè‡ªåŠ¨åŒ¹é…ï¼‰
                <span class="en-trans">Batch Image Upload (Auto-match by filename)</span>
            </h3>
            <div class="form-group">
                <label>é€‰æ‹©å›¾ç‰‡æ–‡ä»¶ï¼ˆæ”¯æŒJPG/PNGï¼Œæ–‡ä»¶ååŒ…å«ç“·ç –ç¼–å·å³å¯è‡ªåŠ¨åŒ¹é…ï¼‰
                    <span class="en-trans">Select image files (JPG/PNG), filenames containing tile code will be auto-matched</span>
                </label>
                <input type="file" id="batchImageInput" accept="image/jpeg,image/png" multiple onchange="previewBatchImages()">
                <div class="batch-upload-note">
                    <strong>ä½¿ç”¨è¯´æ˜ï¼š</strong>å›¾ç‰‡æ–‡ä»¶åä¸­åŒ…å«ç“·ç –ç¼–å·å³å¯è‡ªåŠ¨åŒ¹é…ï¼ˆä¾‹å¦‚"AB123.jpg"ä¼šåŒ¹é…ç¼–å·"AB123"çš„ç“·ç –ï¼‰ï¼Œæ— éœ€æ‰‹åŠ¨é€‰æ‹©ç¼–å·ã€‚ç³»ç»Ÿä¼šè‡ªåŠ¨å‹ç¼©å›¾ç‰‡ä»¥æé«˜ä¸Šä¼ é€Ÿåº¦ã€‚
                    <span class="en-trans"><strong>Instructions:</strong> Image filenames containing tile codes will be auto-matched (e.g., "AB123.jpg" matches tile "AB123"). No need to select code manually. System will auto-compress images to improve upload speed.</span>
                </div>
                <div id="batchImagePreviewContainer"></div>
            </div>
            <!-- æ‰¹é‡ä¸Šä¼ è¿›åº¦æ¡ -->
            <div id="batchUploadProgressContainer" style="display: none;">
                <div style="font-size: 14px;">ä¸Šä¼ è¿›åº¦ï¼š<span id="batchProgressPercent">0%</span></div>
                <div id="batchProgressBarContainer">
                    <div id="batchProgressBar"></div>
                </div>
                <div style="font-size: 12px; color: #666; margin-top: 5px;">
                    æ­£åœ¨å¤„ç† <span id="batchCurrentFile">0</span>/<span id="batchTotalFiles">0</span> ä¸ªæ–‡ä»¶
                    <span class="en-trans">Processing <span id="batchCurrentFile-en">0</span>/<span id="batchTotalFiles-en">0</span> files</span>
                </div>
                <div style="font-size: 12px; color: #666; margin-top: 3px;">
                    å·²åŒ¹é… <span id="matchedCount">0</span> ä¸ªï¼ŒæœªåŒ¹é… <span id="unmatchedCount">0</span> ä¸ª
                    <span class="en-trans">Matched: <span id="matchedCount-en">0</span>, Unmatched: <span id="unmatchedCount-en">0</span></span>
                </div>
            </div>
            <button class="secondary" onclick="batchUploadImages()">å¼€å§‹æ‰¹é‡ä¸Šä¼ 
                <span class="en-trans">Start Batch Upload</span>
            </button>
        </div>
        
        <button class="gray" onclick="logoutAdmin()" style="margin-top: 15px;">é€€å‡ºç®¡ç†å‘˜
            <span class="en-trans">Logout Admin</span>
        </button>
    </div>
</div>

<!-- å›¾ç‰‡é¢„è§ˆå¼¹çª— -->
<div id="imageViewerModal">
    <div id="imageViewerContent">
        <button class="close-btn" onclick="closeImageViewer()">Ã—</button>
        <img id="mainViewerImage" src="" alt="ç“·ç –å›¾ç‰‡">
        <button class="image-nav-btn" style="left: -30px;" onclick="switchViewerImage(-1)">â†</button>
        <button class="image-nav-btn" style="right: -30px;" onclick="switchViewerImage(1)">â†’</button>
        <div id="imagePagination"></div>
    </div>
</div>

<div class="toast" id="toast"></div>

<script>
    // å…¨å±€å˜é‡
    let stockData = [];
    let tileImages = []; // å­˜å‚¨æ‰€æœ‰ç“·ç –å›¾ç‰‡æ•°æ®
    let isAdmin = false;
    let workbookData = null;
    let sheetWarehouses = {};
    let mappedData = [];
    const DEFAULT_ADMIN_PASSWORD = "admin";
    const THAI_KEYWORD = "à¸à¸£à¸°à¹€à¸šà¸·à¹‰à¸­à¸‡";
    let currentViewerIndex = 0;
    let currentViewerImages = [];
    let tileCodes = []; // å­˜å‚¨æ‰€æœ‰ç“·ç –ç¼–å·ç”¨äºè‡ªåŠ¨åŒ¹é…
    
    // åˆ—æ˜ å°„é…ç½®ï¼ˆBåˆ—=ç¼–å·ï¼ŒCåˆ—=è‰²å·ï¼ŒJåˆ—=æ•°é‡ï¼‰
    const COLUMN_MAPPINGS = {
        checkColumn: "B",    // æ£€æŸ¥æ˜¯å¦åŒ…å«æ³°è¯­çš„åˆ—ï¼ˆBåˆ—ï¼‰
        codeColumn: "B",     // ç¼–å·åˆ—ï¼ˆBåˆ—ï¼‰
        colorColumn: "C",    // è‰²å·åˆ—ï¼ˆCåˆ—ï¼‰
        quantityColumn: "J", // æ•°é‡åˆ—ï¼ˆJåˆ—ï¼‰
        startRow: 0          // æ•°æ®èµ·å§‹è¡Œ
    };
    
    // åº“å­˜é˜ˆå€¼
    const STOCK_THRESHOLDS = {
        urgent: 10,   // ç´§æ€¥åº“å­˜
        low: 50,      // ä½åº“å­˜
        medium: 100   // ä¸­ç­‰åº“å­˜
    };
    
    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    window.onload = function() {
        waitForFirebase();
    };
    
    // ç­‰å¾…Firebaseåˆå§‹åŒ–
    function waitForFirebase() {
        if (window.firebaseInitialized !== undefined) {
            if (window.firebaseInitialized) {
                initSystem();
            } else {
                showToast('åˆå§‹åŒ–å¤±è´¥: ' + window.firebaseError);
            }
            return;
        }
        setTimeout(waitForFirebase, 100);
    }
    
    // ç³»ç»Ÿåˆå§‹åŒ–
    function initSystem() {
        // åŠ è½½åº“å­˜æ•°æ®
        loadStockData();
        // åŠ è½½å›¾ç‰‡æ•°æ®
        loadTileImages();
        
        // å®æ—¶ç›‘å¬æ•°æ®å˜åŒ–
        if (window.firebase) {
            firebase.onValue(firebase.stockRef, (snapshot) => {
                const data = snapshot.val();
                if (data && data.stockData) {
                    stockData = data.stockData;
                    updateLastUpdateTime(data.updateTime);
                    localStorage.setItem('cachedStockData', JSON.stringify(stockData));
                    localStorage.setItem('cachedStockTime', data.updateTime);
                    
                    // æå–æ‰€æœ‰ç“·ç –ç¼–å·ç”¨äºå›¾ç‰‡è‡ªåŠ¨åŒ¹é…
                    extractTileCodes();
                    
                    // æ›´æ–°å¯è§†åŒ–å›¾è¡¨
                    if (document.querySelector('.stock-tab.active').getAttribute('onclick').includes('visual')) {
                        updateVisualizations();
                    }
                }
            });
            
            // ç›‘å¬å›¾ç‰‡æ•°æ®å˜åŒ–
            firebase.onValue(firebase.imagesRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    tileImages = data;
                    // æ›´æ–°å½“å‰æ˜¾ç¤ºçš„è¡¨æ ¼
                    if (document.getElementById('stock-result-table').style.display !== 'none') {
                        searchStock(); // é‡æ–°æœç´¢ä»¥æ›´æ–°å›¾ç‰‡
                    }
                    if (document.getElementById('full-stock-table').style.display !== 'none') {
                        displayFullStockTable(); // é‡æ–°æ˜¾ç¤ºå®Œæ•´è¡¨æ ¼
                    }
                }
            });
        }
    }
    
    // æå–æ‰€æœ‰ç“·ç –ç¼–å·ç”¨äºè‡ªåŠ¨åŒ¹é…
    function extractTileCodes() {
        if (stockData.length > 0) {
            tileCodes = [...new Set(stockData.map(item => item.code))];
            console.log('å·²æå–ç“·ç –ç¼–å·:', tileCodes.length, 'ä¸ª');
        }
    }
    
    // åˆ‡æ¢é€‰é¡¹å¡
    function switchStockTab(tabName) {
        // æ›´æ–°é€‰é¡¹å¡æ ·å¼
        document.querySelectorAll('.stock-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelector(`.stock-tab[onclick="switchStockTab('${tabName}')"]`).classList.add('active');
        
        // æ›´æ–°å†…å®¹æ˜¾ç¤º
        document.querySelectorAll('.stock-tab-content').forEach(content => {
            content.classList.remove('active');
        });
        document.getElementById(`${tabName}-tab-content`).classList.add('active');
        
        // å¦‚æœåˆ‡æ¢åˆ°å¯è§†åŒ–æ ‡ç­¾ï¼Œæ›´æ–°å›¾è¡¨
        if (tabName === 'visual') {
            updateVisualizations();
        }
    }
    
    // æœç´¢åº“å­˜
    function searchStock() {
        const code = document.getElementById('stockCode').value.trim().toLowerCase();
        const table = document.getElementById('stock-result-table');
        const tbody = document.getElementById('stock-result-body');
        const message = document.getElementById('stock-result-message');
        
        table.style.display = 'none';
        tbody.innerHTML = '';
        message.textContent = '';
        
        if (!code) {
            message.textContent = 'è¯·è¾“å…¥ç“·ç –ç¼–å·å…³é”®è¯';
            return;
        }
        
        if (stockData.length === 0) {
            message.textContent = 'æš‚æ— åº“å­˜æ•°æ®ï¼Œè¯·ç®¡ç†å‘˜ä¸Šä¼ ';
            return;
        }
        
        // æ‰§è¡Œæœç´¢
        const results = stockData.filter(item => 
            item.code && item.code.toLowerCase().includes(code)
        );
        
        if (results.length === 0) {
            message.textContent = `æœªæ‰¾åˆ°åŒ…å«"${code}"çš„ç“·ç –ç¼–å·`;
            return;
        }
        
        // æ˜¾ç¤ºç»“æœ
        table.style.display = 'table';
        results.forEach(item => {
            const row = document.createElement('tr');
            
            // åº“å­˜çŠ¶æ€æ ·å¼
            let quantityHtml = item.quantity;
            if (quantityHtml <= STOCK_THRESHOLDS.urgent) {
                quantityHtml = `<span class="stock-urgent">${quantityHtml}</span>`;
            } else if (quantityHtml <= STOCK_THRESHOLDS.low) {
                quantityHtml = `<span class="stock-low">${quantityHtml}</span>`;
            } else if (quantityHtml <= STOCK_THRESHOLDS.medium) {
                quantityHtml = `<span class="stock-medium">${quantityHtml}</span>`;
            } else {
                quantityHtml = `<span class="stock-high">${quantityHtml}</span>`;
            }
            
            // è·å–å›¾ç‰‡
            const imageData = tileImages.find(
                item => item && item.code === tileCode && item.color === tileColor
            );
            let imageHtml = '<span>æ— å›¾ç‰‡</span>';
            
            if (imageData && imageData.images && imageData.images.length > 0) {
                // æ˜¾ç¤ºç¬¬ä¸€å¼ å›¾ç‰‡ä½œä¸ºç¼©ç•¥å›¾
                imageHtml = `<img src="${imageData.images[0]}" class="image-thumbnail" 
                    onclick="openImageViewer('${item.code}', '${item.color}')" 
                    alt="${item.code} ${item.color}çš„å›¾ç‰‡">`;
            }
            
            row.innerHTML = `
                <td>${item.code}</td>
                <td>${item.color || '-'}</td>
                <td>${quantityHtml}</td>
                <td>${item.warehouse}</td>
                <td>${imageHtml}</td>
            `;
            tbody.appendChild(row);
        });
    }
    
    // æ˜¾ç¤ºå®Œæ•´åº“å­˜è¡¨
    function displayFullStockTable() {
        const table = document.getElementById('full-stock-table');
        const tbody = document.getElementById('full-stock-body');
        const message = document.getElementById('full-stock-message');
        
        table.style.display = 'none';
        tbody.innerHTML = '';
        
        if (stockData.length === 0) {
            message.textContent = 'æš‚æ— åº“å­˜æ•°æ®ï¼Œè¯·ç®¡ç†å‘˜ä¸Šä¼ ';
            return;
        }
        
        // æŒ‰ä»“åº“åˆ†ç»„æ˜¾ç¤º
        const sortedData = [...stockData].sort((a, b) => {
            if (a.warehouse !== b.warehouse) {
                return a.warehouse.localeCompare(b.warehouse);
            }
            return a.code.localeCompare(b.code);
        });
        
        table.style.display = 'table';
        message.textContent = '';
        
        sortedData.forEach(item => {
            const row = document.createElement('tr');
            
            let quantityHtml = item.quantity;
            if (quantityHtml <= STOCK_THRESHOLDS.urgent) {
                quantityHtml = `<span class="stock-urgent">${quantityHtml}</span>`;
            } else if (quantityHtml <= STOCK_THRESHOLDS.low) {
                quantityHtml = `<span class="stock-low">${quantityHtml}</span>`;
            } else if (quantityHtml <= STOCK_THRESHOLDS.medium) {
                quantityHtml = `<span class="stock-medium">${quantityHtml}</span>`;
            } else {
                quantityHtml = `<span class="stock-high">${quantityHtml}</span>`;
            }
            
            // è·å–å›¾ç‰‡
            const imageData = tileImages.find(
                img => img && img.code === item.code && img.color === item.color
            );
            let imageHtml = '<span>æ— å›¾ç‰‡</span>';
            
            if (imageData && imageData.images && imageData.images.length > 0) {
                // æ˜¾ç¤ºç¬¬ä¸€å¼ å›¾ç‰‡ä½œä¸ºç¼©ç•¥å›¾
                imageHtml = `<img src="${imageData.images[0]}" class="image-thumbnail" 
                    onclick="openImageViewer('${item.code}', '${item.color}')" 
                    alt="${item.code} ${item.color}çš„å›¾ç‰‡">`;
            }
            
            row.innerHTML = `
                <td>${item.code}</td>
                <td>${item.color || '-'}</td>
                <td>${quantityHtml}</td>
                <td>${item.warehouse}</td>
                <td>${imageHtml}</td>
            `;
            tbody.appendChild(row);
        });
    }
    
    // åˆ·æ–°åº“å­˜æ•°æ®
    function refreshStockData() {
        showToast('æ­£åœ¨åˆ·æ–°æ•°æ®...');
        stockData = [];
        loadStockData(true);
    }
    
    // åŠ è½½åº“å­˜æ•°æ®
    function loadStockData(forceRefresh = false) {
        // å°è¯•ä»ç¼“å­˜åŠ è½½
        if (!forceRefresh) {
            const cachedStock = localStorage.getItem('cachedStockData');
            const cachedTime = localStorage.getItem('cachedStockTime');
            if (cachedStock && cachedTime) {
                try {
                    stockData = JSON.parse(cachedStock);
                    updateLastUpdateTime(cachedTime);
                    displayFullStockTable();
                    showToast('å·²åŠ è½½ç¼“å­˜æ•°æ®');
                    
                    // æå–ç“·ç –ç¼–å·ç”¨äºè‡ªåŠ¨åŒ¹é…
                    extractTileCodes();
                    return;
                } catch (e) {
                    console.error('ç¼“å­˜æ•°æ®è§£æå¤±è´¥', e);
                }
            }
        }
        
        // ä»æ•°æ®åº“åŠ è½½
        if (window.firebase) {
            firebase.get(firebase.stockRef).then((snapshot) => {
                const data = snapshot.val();
                if (data && data.stockData) {
                    stockData = data.stockData;
                    updateLastUpdateTime(data.updateTime);
                    localStorage.setItem('cachedStockData', JSON.stringify(stockData));
                    localStorage.setItem('cachedStockTime', data.updateTime);
                    showToast('å·²åŠ è½½æœ€æ–°æ•°æ®');
                    
                    // æå–ç“·ç –ç¼–å·ç”¨äºè‡ªåŠ¨åŒ¹é…
                    extractTileCodes();
                } else {
                    stockData = [];
                    showToast('æš‚æ— åº“å­˜æ•°æ®');
                }
                displayFullStockTable();
            }).catch((error) => {
                console.error('åŠ è½½æ•°æ®å¤±è´¥', error);
                showToast('åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ');
            });
        }
    }
    
    // ä»FirebaseåŠ è½½å›¾ç‰‡æ•°æ®
    function loadTileImages() {
        if (!window.firebase) return;
        firebase.get(firebase.imagesRef).then((snapshot) => {
            const data = snapshot.val();
            tileImages = data ? data : [];
            console.log('å·²åŠ è½½ç“·ç –å›¾ç‰‡æ•°æ®', tileImages.length, 'æ¡');
        }).catch(error => {
            console.error('åŠ è½½å›¾ç‰‡æ•°æ®å¤±è´¥', error);
        });
    }
    
    // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
    function updateLastUpdateTime(time) {
        if (!time) return;
        const formattedTime = new Date(time).toLocaleString();
        document.getElementById('last-update-time').textContent = `åº“å­˜æœ€åæ›´æ–°æ—¶é—´ï¼š${formattedTime}`;
        document.getElementById('full-last-update-time').textContent = `åº“å­˜æœ€åæ›´æ–°æ—¶é—´ï¼š${formattedTime}`;
        document.getElementById('visual-update-time').textContent = formattedTime;
        document.getElementById('visual-update-time-en').textContent = new Date(time).toLocaleString('en-US');
    }
    
    // ç®¡ç†å‘˜ç™»å½•
    function authenticateAdmin() {
        const password = document.getElementById('adminPassword').value;
        const errorElement = document.getElementById('adminError');
        
        if (!password) {
            errorElement.textContent = 'è¯·è¾“å…¥å¯†ç ';
            errorElement.style.display = 'block';
            return;
        }
        
        if (password === DEFAULT_ADMIN_PASSWORD) {
            isAdmin = true;
            document.getElementById('adminSection').style.display = 'block';
            document.getElementById('adminPassword').value = '';
            showToast('ç®¡ç†å‘˜ç™»å½•æˆåŠŸ');
            errorElement.style.display = 'none';
        } else {
            errorElement.textContent = 'å¯†ç é”™è¯¯';
            errorElement.style.display = 'block';
        }
    }
    
    // ç®¡ç†å‘˜é€€å‡º
    function logoutAdmin() {
        isAdmin = false;
        document.getElementById('adminSection').style.display = 'none';
        showToast('å·²é€€å‡ºç®¡ç†å‘˜æ¨¡å¼');
    }
    
    // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
    function handleAdminFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        if (!file.name.endsWith('.xlsx') && !file.name.endsWith('.xls')) {
            showToast('è¯·ä¸Šä¼ Excelæ–‡ä»¶');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                workbookData = XLSX.read(data, { type: 'array' });
                const sheetNames = workbookData.SheetNames;
                
                if (sheetNames.length === 0) {
                    throw new Error('æœªæ‰¾åˆ°å·¥ä½œè¡¨');
                }
                
                // ç”Ÿæˆå·¥ä½œè¡¨é€‰æ‹©åˆ—è¡¨
                const sheetListElement = document.getElementById('sheetList');
                sheetListElement.innerHTML = '';
                
                sheetNames.forEach((sheetName, index) => {
                    const defaultWarehouse = index === 0 ? '1å·ä»“åº“' : 
                                           index === 1 ? 'k38ä»“åº“' : 'k39ä»“åº“';
                    
                    sheetWarehouses[sheetName] = defaultWarehouse;
                    
                    const sheetItem = document.createElement('div');
                    sheetItem.className = 'form-group';
                    sheetItem.innerHTML = `
                        <label>
                            <input type="checkbox" checked id="sheet-${index}">
                            å·¥ä½œè¡¨: ${sheetName}
                        </label>
                        <select onchange="sheetWarehouses['${sheetName}'] = this.value">
                            <option value="1å·ä»“åº“" ${defaultWarehouse === '1å·ä»“åº“' ? 'selected' : ''}>1å·ä»“åº“</option>
                            <option value="k38ä»“åº“" ${defaultWarehouse === 'k38ä»“åº“' ? 'selected' : ''}>k38ä»“åº“</option>
                            <option value="k39ä»“åº“" ${defaultWarehouse === 'k39ä»“åº“' ? 'selected' : ''}>k39ä»“åº“</option>
                        </select>
                    `;
                    sheetListElement.appendChild(sheetItem);
                });
                
                document.getElementById('sheetSelection').style.display = 'block';
                showToast(`å·²è§£ææ–‡ä»¶ï¼Œå‘ç° ${sheetNames.length} ä¸ªå·¥ä½œè¡¨`);
            } catch (error) {
                console.error('å¤„ç†æ–‡ä»¶å¤±è´¥', error);
                showToast('å¤„ç†æ–‡ä»¶å¤±è´¥: ' + error.message);
            }
        };
        reader.readAsArrayBuffer(file);
    }
    
    // é¢„è§ˆæ˜ å°„æ•°æ®
    function previewMappedData() {
        if (!workbookData) return;
        
        mappedData = [];
        const previewContent = document.getElementById('previewContent');
        previewContent.innerHTML = '';
        
        // å¤„ç†æ¯ä¸ªé€‰ä¸­çš„å·¥ä½œè¡¨
        Object.keys(sheetWarehouses).forEach(sheetName => {
            const sheetIndex = workbookData.SheetNames.indexOf(sheetName);
            const isChecked = document.getElementById(`sheet-${sheetIndex}`).checked;
            
            if (!isChecked) return;
            
            const warehouse = sheetWarehouses[sheetName];
            const worksheet = workbookData.Sheets[sheetName];
            const sheetData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            
            if (!sheetData || sheetData.length === 0) return;
            
            const warehouseData = [];
            let validCount = 0;
            
            // å¤„ç†æ¯ä¸€è¡Œæ•°æ®
            for (let i = COLUMN_MAPPINGS.startRow; i < sheetData.length; i++) {
                const row = sheetData[i];
                
                // åˆ—ç´¢å¼•è½¬æ¢ (A=0, B=1, C=2, ..., J=9)
                const checkColIndex = XLSX.utils.decode_col(COLUMN_MAPPINGS.checkColumn);
                const codeColIndex = XLSX.utils.decode_col(COLUMN_MAPPINGS.codeColumn);
                const colorColIndex = XLSX.utils.decode_col(COLUMN_MAPPINGS.colorColumn);
                const quantityColIndex = XLSX.utils.decode_col(COLUMN_MAPPINGS.quantityColumn);
                
                // è·å–Båˆ—æ•°æ®æ£€æŸ¥æ˜¯å¦åŒ…å«æ³°è¯­å…³é”®è¯
                const checkValue = row[checkColIndex] ? String(row[checkColIndex]).trim() : '';
                const containsKeyword = checkValue.includes(THAI_KEYWORD);
                
                if (containsKeyword) {
                    // æå–æ•°æ®
                    const code = row[codeColIndex] ? String(row[codeColIndex]).trim() : '';
                    const color = row[colorColIndex] ? String(row[colorColIndex]).trim() : '';
                    const quantity = row[quantityColIndex] ? Number(row[quantityColIndex]) : 0;
                    
                    // éªŒè¯æ•°æ®
                    const isValid = code && !isNaN(quantity) && quantity >= 0;
                    if (isValid) validCount++;
                    
                    const item = {
                        code,
                        color,
                        quantity: isValid ? quantity : 0,
                        warehouse,
                        rowNumber: i + 1,
                        isValid
                    };
                    
                    warehouseData.push(item);
                    if (isValid) mappedData.push(item);
                }
            }
            
            // ç”Ÿæˆé¢„è§ˆè¡¨æ ¼
            const warehousePreview = document.createElement('div');
            warehousePreview.className = 'card';
            warehousePreview.style.marginBottom = '15px';
            
            warehousePreview.innerHTML = `
                <h4>${sheetName} - ${warehouse}</h4>
                <p>å…±å‘ç° ${warehouseData.length} æ¡åŒ…å«æ³°è¯­å…³é”®è¯çš„æ•°æ®ï¼Œå…¶ä¸­æœ‰æ•ˆæ•°æ® ${validCount} æ¡</p>
                <table class="stock-table">
                    <thead>
                        <tr>
                            <th>è¡Œå·</th>
                            <th>ç¼–å· (Båˆ—)</th>
                            <th>è‰²å· (Cåˆ—)</th>
                            <th>æ•°é‡ (Jåˆ—)</th>
                            <th>çŠ¶æ€</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${warehouseData.slice(0, 5).map(item => `
                            <tr style="background-color: ${item.isValid ? '' : '#fff0f0'}">
                                <td>${item.rowNumber}</td>
                                <td>${item.code}</td>
                                <td>${item.color || '-'}</td>
                                <td>${item.quantity}</td>
                                <td>${item.isValid ? 'æœ‰æ•ˆ' : 'æ— æ•ˆ'}</td>
                            </tr>
                        `).join('')}
                        ${warehouseData.length > 5 ? `<tr><td colspan="5">... å…± ${warehouseData.length} æ¡æ•°æ® ...</td></tr>` : ''}
                    </tbody>
                </table>
            `;
            
            previewContent.appendChild(warehousePreview);
        });
        
        document.getElementById('dataPreview').style.display = 'block';
        showToast(`é¢„è§ˆå®Œæˆï¼Œå…± ${mappedData.length} æ¡æœ‰æ•ˆæ•°æ®`);
    }
    
    // ä¿å­˜æ˜ å°„æ•°æ®
    function saveMappedData() {
        if (mappedData.length === 0) {
            showToast('æ²¡æœ‰æœ‰æ•ˆæ•°æ®å¯ä¿å­˜');
            return;
        }
        
        const updateTime = new Date().toLocaleString();
        
        if (window.firebase) {
            firebase.set(firebase.stockRef, {
                stockData: mappedData,
                updateTime
            }).then(() => {
                showToast('æ•°æ®ä¿å­˜æˆåŠŸ');
                document.getElementById('sheetSelection').style.display = 'none';
                document.getElementById('dataPreview').style.display = 'none';
                
                // æ›´æ–°æœ¬åœ°æ•°æ®
                stockData = mappedData;
                updateLastUpdateTime(updateTime);
                displayFullStockTable();
                
                // æå–ç“·ç –ç¼–å·ç”¨äºè‡ªåŠ¨åŒ¹é…
                extractTileCodes();
            }).catch(error => {
                console.error('ä¿å­˜æ•°æ®å¤±è´¥', error);
                showToast('ä¿å­˜æ•°æ®å¤±è´¥: ' + error.message);
            });
        }
    }
    
    // å–æ¶ˆä¸Šä¼ 
    function cancelUpload() {
        document.getElementById('sheetSelection').style.display = 'none';
        document.getElementById('dataPreview').style.display = 'none';
        workbookData = null;
        showToast('å·²å–æ¶ˆä¸Šä¼ ');
    }
    
    // æ›´æ–°å¯è§†åŒ–å›¾è¡¨ - è§£å†³é‡å é—®é¢˜
    function updateVisualizations() {
        if (stockData.length === 0) {
            document.getElementById('warehouse-pie-chart').innerHTML = '<p style="text-align: center; padding: 20px;">æš‚æ— æ•°æ®å¯å¯è§†åŒ–</p>';
            document.getElementById('stock-bar-chart').innerHTML = '<p style="text-align: center; padding: 20px;">æš‚æ— æ•°æ®å¯å¯è§†åŒ–</p>';
            document.getElementById('category-bar-chart').innerHTML = '<p style="text-align: center; padding: 20px;">æš‚æ— æ•°æ®å¯å¯è§†åŒ–</p>';
            return;
        }
        
        // 1. ä»“åº“åº“å­˜åˆ†å¸ƒé¥¼å›¾
        const warehouseData = {};
        stockData.forEach(item => {
            if (!warehouseData[item.warehouse]) {
                warehouseData[item.warehouse] = 0;
            }
            warehouseData[item.warehouse] += item.quantity;
        });
        
        const pieChart = echarts.init(document.getElementById('warehouse-pie-chart'));
        pieChart.setOption({
            title: { 
                text: 'å„ä»“åº“åº“å­˜æ€»é‡åˆ†å¸ƒ', 
                left: 'center',
                top: 10,  // è°ƒæ•´æ ‡é¢˜ä½ç½®é¿å…é‡å 
                textStyle: { fontSize: 14 }
            },
            tooltip: { trigger: 'item' },
            legend: { 
                orient: 'vertical', 
                left: 'left',
                top: 40  // è°ƒæ•´å›¾ä¾‹ä½ç½®
            },
            series: [{
                name: 'åº“å­˜æ•°é‡',
                type: 'pie',
                radius: ['40%', '70%'],  // ä½¿ç”¨ç¯å½¢å›¾èŠ‚çœç©ºé—´
                center: ['60%', '50%'],  // è°ƒæ•´å›¾è¡¨ä½ç½®
                data: Object.entries(warehouseData).map(([name, value]) => ({ name, value })),
                emphasis: { itemStyle: { shadowBlur: 10, shadowOffsetX: 0, shadowColor: 'rgba(0, 0, 0, 0.5)' } }
            }]
        });
        
        // 2. åº“å­˜æ•°é‡TOP10æŸ±çŠ¶å›¾
        const topItems = [...stockData]
            .sort((a, b) => b.quantity - a.quantity)
            .slice(0, 10);
        
        const barChart = echarts.init(document.getElementById('stock-bar-chart'));
        barChart.setOption({
            title: { 
                text: 'åº“å­˜æ•°é‡TOP10', 
                left: 'center',
                top: 10,
                textStyle: { fontSize: 14 }
            },
            tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
            grid: { 
                left: '5%', 
                right: '5%', 
                bottom: '10%', 
                top: '20%',  // å¢åŠ é¡¶éƒ¨è·ç¦»é¿å…æ ‡é¢˜é‡å 
                containLabel: true 
            },
            xAxis: { type: 'value' },
            yAxis: { 
                type: 'category',
                data: topItems.map(item => item.code),
                axisLabel: { fontSize: 12 }  // ç¼©å°æ ‡ç­¾å­—ä½“
            },
            series: [{
                name: 'æ•°é‡(ç®±)',
                type: 'bar',
                data: topItems.map(item => item.quantity),
                itemStyle: {
                    color: function(params) {
                        const value = params.value;
                        if (value <= STOCK_THRESHOLDS.urgent) return '#ef4444';
                        if (value <= STOCK_THRESHOLDS.low) return '#f97316';
                        if (value <= STOCK_THRESHOLDS.medium) return '#f59e0b';
                        return '#10B981';
                    }
                }
            }]
        });
        
        // 3. ä»“åº“åº“å­˜åˆ†ç±»å¯¹æ¯”å›¾ - è§£å†³æ ‡é¢˜ä¸å›¾ä¾‹é‡å é—®é¢˜
        const categoryData = {};
        const warehouses = new Set(stockData.map(item => item.warehouse));
        
        // åˆå§‹åŒ–æ¯ä¸ªä»“åº“çš„åº“å­˜åˆ†ç±»
        warehouses.forEach(warehouse => {
            categoryData[warehouse] = {
                urgent: 0,
                low: 0,
                medium: 0,
                high: 0
            };
        });
        
        // ç»Ÿè®¡å„ä»“åº“çš„åº“å­˜åˆ†ç±»
        stockData.forEach(item => {
            let category;
            if (item.quantity <= STOCK_THRESHOLDS.urgent) category = 'urgent';
            else if (item.quantity <= STOCK_THRESHOLDS.low) category = 'low';
            else if (item.quantity <= STOCK_THRESHOLDS.medium) category = 'medium';
            else category = 'high';
            
            categoryData[item.warehouse][category]++;
        });
        
        const categoryChart = echarts.init(document.getElementById('category-bar-chart'));
        categoryChart.setOption({
            title: { 
                text: 'å„ä»“åº“åº“å­˜çŠ¶æ€åˆ†å¸ƒ', 
                left: 'center',
                top: 10,  // è°ƒæ•´æ ‡é¢˜ä½ç½®
                textStyle: { fontSize: 14 }
            },
            tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
            legend: { 
                data: ['ç´§æ€¥', 'ä½åº“å­˜', 'ä¸­ç­‰åº“å­˜', 'å……è¶³'],
                top: 40,  // è°ƒæ•´å›¾ä¾‹ä½ç½®ï¼Œé¿å…ä¸æ ‡é¢˜é‡å 
                left: 'center',
                orient: 'horizontal',
                textStyle: { fontSize: 12 }  // ç¼©å°å­—ä½“
            },
            grid: { 
                left: '5%', 
                right: '5%', 
                bottom: '10%', 
                top: '15%',  // å¢åŠ é¡¶éƒ¨è·ç¦»ï¼Œé¿å…ä¸å›¾ä¾‹é‡å 
                containLabel: true 
            },
            xAxis: { type: 'category', data: Array.from(warehouses) },
            yAxis: { type: 'value', name: 'å•†å“æ•°é‡' },
            series: [
                { name: 'ç´§æ€¥', type: 'bar', stack: 'total', data: Array.from(warehouses).map(w => categoryData[w].urgent), itemStyle: { color: '#ef4444' } },
                { name: 'ä½åº“å­˜', type: 'bar', stack: 'total', data: Array.from(warehouses).map(w => categoryData[w].low), itemStyle: { color: '#f97316' } },
                { name: 'ä¸­ç­‰åº“å­˜', type: 'bar', stack: 'total', data: Array.from(warehouses).map(w => categoryData[w].medium), itemStyle: { color: '#f59e0b' } },
                { name: 'å……è¶³', type: 'bar', stack: 'total', data: Array.from(warehouses).map(w => categoryData[w].high), itemStyle: { color: '#10B981' } }
            ]
        });
        
        // å“åº”çª—å£å¤§å°å˜åŒ–
        window.addEventListener('resize', () => {
            pieChart.resize();
            barChart.resize();
            categoryChart.resize();
        });
    }
    
    // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
    function showToast(message) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.style.display = 'block';
        setTimeout(() => { toast.style.display = 'none'; }, 3000);
    }
    
    // -------------------------- æ‰¹é‡å›¾ç‰‡ä¸Šä¼ ä¸è‡ªåŠ¨åŒ¹é…åŠŸèƒ½ --------------------------
    
    // é¢„è§ˆæ‰¹é‡é€‰æ‹©çš„å›¾ç‰‡
    function previewBatchImages() {
        const fileInput = document.getElementById('batchImageInput');
        const previewContainer = document.getElementById('batchImagePreviewContainer');
        previewContainer.innerHTML = '';
        
        if (!fileInput.files || fileInput.files.length === 0) return;
        
        for (let i = 0; i < fileInput.files.length; i++) {
            const file = fileInput.files[i];
            if (!file.type.startsWith('image/')) continue;
            
            // å°è¯•ä»æ–‡ä»¶åæå–åŒ¹é…çš„ç“·ç –ç¼–å·
            const matchedCode = findMatchingTileCode(file.name);
            const matchIndicator = matchedCode 
                ? `<span style="color: #10B981; font-size: 11px;">åŒ¹é…: ${matchedCode}</span>`
                : `<span style="color: #ef4444; font-size: 11px;">æœªåŒ¹é…</span>`;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const imgContainer = document.createElement('div');
                imgContainer.style.position = 'relative';
                imgContainer.style.textAlign = 'center';
                imgContainer.style.width = '80px';
                
                const img = document.createElement('img');
                img.src = e.target.result;
                img.style.width = '80px';
                img.style.height = '80px';
                img.style.objectFit = 'cover';
                img.style.borderRadius = '4px';
                
                const fileName = document.createElement('div');
                fileName.style.fontSize = '11px';
                fileName.style.overflow = 'hidden';
                fileName.style.textOverflow = 'ellipsis';
                fileName.style.whiteSpace = 'nowrap';
                fileName.style.marginTop = '3px';
                fileName.textContent = file.name.substring(0, 10) + (file.name.length > 10 ? '...' : '');
                
                const removeBtn = document.createElement('span');
                removeBtn.textContent = 'Ã—';
                removeBtn.style.position = 'absolute';
                removeBtn.style.top = '-5px';
                removeBtn.style.right = '-5px';
                removeBtn.style.backgroundColor = 'red';
                removeBtn.style.color = 'white';
                removeBtn.style.borderRadius = '50%';
                removeBtn.style.width = '20px';
                removeBtn.style.height = '20px';
                removeBtn.style.display = 'flex';
                removeBtn.style.alignItems = 'center';
                removeBtn.style.justifyContent = 'center';
                removeBtn.style.cursor = 'pointer';
                removeBtn.style.fontSize = '12px';
                removeBtn.onclick = function() {
                    previewContainer.removeChild(imgContainer);
                };
                
                imgContainer.appendChild(img);
                imgContainer.appendChild(removeBtn);
                imgContainer.appendChild(fileName);
                imgContainer.appendChild(document.createElement('br'));
                imgContainer.appendChild(matchIndicator);
                previewContainer.appendChild(imgContainer);
            };
            reader.readAsDataURL(file);
        }
    }
    
    // ä»æ–‡ä»¶åä¸­æŸ¥æ‰¾åŒ¹é…çš„ç“·ç –ç¼–å·ï¼ˆæ¨¡ç³ŠåŒ¹é…ï¼‰
    function findMatchingTileCode(filename) {
        if (!filename || tileCodes.length === 0) return null;
        
        // æ¸…ç†æ–‡ä»¶åï¼ˆå»é™¤æ‰©å±•åå’Œç‰¹æ®Šå­—ç¬¦ï¼‰
        const cleanName = filename.replace(/\.[^/.]+$/, "").replace(/[^a-zA-Z0-9]/g, "");
        
        // æŸ¥æ‰¾æœ€å¯èƒ½åŒ¹é…çš„ç¼–å·
        for (const code of tileCodes) {
            // ç“·ç –ç¼–å·ä¹Ÿæ¸…ç†ç‰¹æ®Šå­—ç¬¦
            const cleanCode = code.replace(/[^a-zA-Z0-9]/g, "");
            // å¦‚æœæ–‡ä»¶ååŒ…å«ç¼–å·çš„å…¨éƒ¨å­—ç¬¦ï¼ˆä¸è€ƒè™‘é¡ºåºï¼‰
            if (cleanName.includes(cleanCode)) {
                return code;
            }
        }
        
        // å¦‚æœæ²¡æœ‰å®Œå…¨åŒ¹é…ï¼Œå°è¯•éƒ¨åˆ†åŒ¹é…ï¼ˆè‡³å°‘åŒ…å«3ä¸ªè¿ç»­å­—ç¬¦ï¼‰
        for (const code of tileCodes) {
            if (code.length < 3) continue;
            
            const cleanCode = code.replace(/[^a-zA-Z0-9]/g, "");
            // æ£€æŸ¥æ˜¯å¦æœ‰3ä¸ªè¿ç»­å­—ç¬¦åŒ¹é…
            for (let i = 0; i <= cleanCode.length - 3; i++) {
                const substring = cleanCode.substring(i, i + 3);
                if (cleanName.includes(substring)) {
                    return code;
                }
            }
        }
        
        return null;
    }
    
    // å›¾ç‰‡å‹ç¼©å‡½æ•°ï¼ˆæå‡ä¸Šä¼ é€Ÿåº¦ï¼‰
    async function compressImage(file, maxWidth = 1000, quality = 0.6) {
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.onload = function() {
                // è®¡ç®—å‹ç¼©åçš„å°ºå¯¸ï¼ˆä¿æŒå®½é«˜æ¯”ï¼‰
                let width = img.width;
                let height = img.height;
                if (width > maxWidth) {
                    height = (height * maxWidth) / width;
                    width = maxWidth;
                }
                
                // ä½¿ç”¨Canvaså‹ç¼© - æå‡å‹ç¼©æ•ˆç‡
                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                
                // ä¼˜åŒ–ç»˜åˆ¶è´¨é‡
                ctx.imageSmoothingQuality = 'high';
                ctx.drawImage(img, 0, 0, width, height);
                
                // è½¬æ¢ä¸ºBlobï¼ˆäºŒè¿›åˆ¶å¯¹è±¡ï¼Œé€‚åˆä¸Šä¼ ï¼‰
                canvas.toBlob(
                    (blob) => {
                        if (!blob) reject(new Error('å‹ç¼©å¤±è´¥'));
                        // ç”Ÿæˆå¸¦åŸæ–‡ä»¶åçš„å‹ç¼©æ–‡ä»¶
                        const compressedFile = new File([blob], file.name, { 
                            type: file.type, 
                            lastModified: file.lastModified 
                        });
                        resolve(compressedFile);
                    },
                    file.type || 'image/jpeg',
                    quality // è´¨é‡å‚æ•°ï¼ˆé™ä½è‡³0.6ä»¥å¤§å¹…å‡å°ä½“ç§¯ï¼‰
                );
            };
            img.onerror = (e) => reject(e);
            img.src = URL.createObjectURL(file); // è¯»å–æœ¬åœ°æ–‡ä»¶
        });
    }
    
    // æ‰¹é‡ä¸Šä¼ å›¾ç‰‡å¹¶è‡ªåŠ¨åŒ¹é…
    async function batchUploadImages() {
        const fileInput = document.getElementById('batchImageInput');
        
        if (!fileInput.files || fileInput.files.length === 0) {
            showToast('è¯·é€‰æ‹©è¦ä¸Šä¼ çš„å›¾ç‰‡');
            return;
        }
        
        if (tileCodes.length === 0) {
            showToast('è¯·å…ˆä¸Šä¼ åº“å­˜æ•°æ®ï¼Œæ‰èƒ½åŒ¹é…å›¾ç‰‡');
            return;
        }
        
        // æ˜¾ç¤ºè¿›åº¦æ¡
        const progressContainer = document.getElementById('batchUploadProgressContainer');
        const progressBar = document.getElementById('batchProgressBar');
        const progressPercent = document.getElementById('batchProgressPercent');
        const currentFileEl = document.getElementById('batchCurrentFile');
        const totalFilesEl = document.getElementById('batchTotalFiles');
        const matchedCountEl = document.getElementById('matchedCount');
        const unmatchedCountEl = document.getElementById('unmatchedCount');
        
        progressContainer.style.display = 'block';
        progressBar.style.width = '0%';
        progressPercent.textContent = '0%';
        
        const totalFiles = fileInput.files.length;
        totalFilesEl.textContent = totalFiles;
        totalFilesEl.setAttribute('en', totalFiles);
        currentFileEl.textContent = '0';
        currentFileEl.setAttribute('en', '0');
        
        let matchedCount = 0;
        let unmatchedCount = 0;
        matchedCountEl.textContent = '0';
        matchedCountEl.setAttribute('en', '0');
        unmatchedCountEl.textContent = '0';
        unmatchedCountEl.setAttribute('en', '0');
        
        try {
            // åˆ›å»ºä¸€ä¸ªæ–‡ä»¶å¤„ç†é˜Ÿåˆ—ï¼Œæ§åˆ¶å¹¶å‘æ•°é‡ï¼ˆæå‡é€Ÿåº¦ä½†é¿å…è¿‡è½½ï¼‰
            const concurrency = 3; // åŒæ—¶å¤„ç†3ä¸ªæ–‡ä»¶
            const files = Array.from(fileInput.files);
            const results = [];
            
            // åˆ†æ‰¹æ¬¡å¤„ç†æ–‡ä»¶
            for (let i = 0; i < files.length; i += concurrency) {
                const batch = files.slice(i, i + concurrency);
                const batchPromises = batch.map(async (file, index) => {
                    const fileIndex = i + index;
                    return processFile(file, fileIndex, totalFiles, currentFileEl, progressBar, progressPercent);
                });
                
                const batchResults = await Promise.all(batchPromises);
                results.push(...batchResults);
            }
            
            // ç»Ÿè®¡åŒ¹é…ç»“æœ
            matchedCount = results.filter(r => r.success && r.matchedCode).length;
            unmatchedCount = totalFiles - matchedCount;
            
            matchedCountEl.textContent = matchedCount;
            matchedCountEl.setAttribute('en', matchedCount);
            unmatchedCountEl.textContent = unmatchedCount;
            unmatchedCountEl.setAttribute('en', unmatchedCount);
            
            // å…¨éƒ¨å¤„ç†å®Œæˆ
            showToast(`æ‰¹é‡ä¸Šä¼ å®Œæˆï¼šæˆåŠŸ ${matchedCount} å¼ ï¼ŒæœªåŒ¹é… ${unmatchedCount} å¼ `);
            
            // æ¸…ç©ºé¢„è§ˆå’Œè¾“å…¥
            document.getElementById('batchImagePreviewContainer').innerHTML = '';
            fileInput.value = '';
            
            // 3ç§’åéšè—è¿›åº¦æ¡
            setTimeout(() => {
                progressContainer.style.display = 'none';
            }, 3000);
            
        } catch (error) {
            console.error('æ‰¹é‡ä¸Šä¼ å¤±è´¥', error);
            showToast('ä¸Šä¼ å¤±è´¥: ' + error.message);
            progressContainer.style.display = 'none';
        }
    }
    
    // å¤„ç†å•ä¸ªæ–‡ä»¶çš„ä¸Šä¼ 
    async function processFile(file, fileIndex, totalFiles, currentFileEl, progressBar, progressPercent) {
        try {
            // è·³è¿‡éå›¾ç‰‡æ–‡ä»¶
            if (!file.type.startsWith('image/')) {
                return { success: false, reason: 'éå›¾ç‰‡æ–‡ä»¶' };
            }
            
            // æ›´æ–°å½“å‰æ–‡ä»¶è®¡æ•°
            currentFileEl.textContent = fileIndex + 1;
            currentFileEl.setAttribute('en', fileIndex + 1);
            
            // 1. å¿«é€Ÿå‹ç¼©å›¾ç‰‡ï¼ˆæ¯”ä¹‹å‰æ›´é«˜æ•ˆçš„å‹ç¼©ï¼‰
            const compressedFile = await compressImage(file);
            console.log(`å‹ç¼©å®Œæˆ ${fileIndex+1}/${totalFiles}: `, compressedFile.size / 1024 / 1024, 'MB');
            
            // 2. æŸ¥æ‰¾åŒ¹é…çš„ç“·ç –ç¼–å·
            const matchedCode = findMatchingTileCode(file.name);
            
            // 3. ç”Ÿæˆå­˜å‚¨è·¯å¾„
            const timestamp = new Date().getTime();
            const storagePath = matchedCode 
                ? `tile-images/auto-matched/${matchedCode}/${timestamp}-${file.name}`
                : `tile-images/unmatched/${timestamp}-${file.name}`;
            
            const storageRef = firebase.storageRef(firebase.storage, storagePath);
            
            // 4. ä¸Šä¼ æ–‡ä»¶
            return new Promise((resolve) => {
                const uploadTask = firebase.uploadBytesResumable(storageRef, compressedFile);
                
                // ç›‘å¬å•ä¸ªæ–‡ä»¶ä¸Šä¼ è¿›åº¦
                uploadTask.on('state_changed', 
                    (snapshot) => {
                        // è®¡ç®—æ€»ä½“è¿›åº¦
                        const fileProgress = (snapshot.bytesTransferred / snapshot.totalBytes);
                        const overallProgress = ((fileIndex + fileProgress) / totalFiles) * 100;
                        progressBar.style.width = overallProgress + '%';
                        progressPercent.textContent = Math.round(overallProgress) + '%';
                    },
                    (error) => {
                        console.error(`æ–‡ä»¶ ${fileIndex+1} ä¸Šä¼ å¤±è´¥`, error);
                        resolve({ 
                            success: false, 
                            reason: error.message,
                            matchedCode 
                        });
                    },
                    async () => {
                        try {
                            // ä¸Šä¼ æˆåŠŸï¼Œè·å–ä¸‹è½½URL
                            const downloadURL = await firebase.getDownloadURL(uploadTask.snapshot.ref);
                            
                            // å¦‚æœæ‰¾åˆ°åŒ¹é…çš„ç¼–å·ï¼Œä¿å­˜å…³è”ä¿¡æ¯
                            if (matchedCode) {
                                // å¯¹äºè‡ªåŠ¨åŒ¹é…ï¼Œè‰²å·é»˜è®¤ä¸ºç©ºæˆ–ç¬¬ä¸€ä¸ªåŒ¹é…çš„è‰²å·
                                let matchedColor = '';
                                const matchedItems = stockData.filter(item => item.code === matchedCode);
                                if (matchedItems.length > 0) {
                                    matchedColor = matchedItems[0].color || '';
                                }
                                
                                await saveImageInfo(matchedCode, matchedColor, [downloadURL]);
                            }
                            
                            resolve({ 
                                success: true, 
                                url: downloadURL,
                                matchedCode 
                            });
                        } catch (error) {
                            console.error(`å¤„ç†æ–‡ä»¶ ${fileIndex+1} ç»“æœå¤±è´¥`, error);
                            resolve({ 
                                success: true, // ä¸Šä¼ æˆåŠŸä½†ä¿å­˜ä¿¡æ¯å¤±è´¥
                                url: null,
                                reason: 'ä¸Šä¼ æˆåŠŸä½†ä¿å­˜ä¿¡æ¯å¤±è´¥',
                                matchedCode 
                            });
                        }
                    }
                );
            });
            
        } catch (error) {
            console.error(`å¤„ç†æ–‡ä»¶ ${fileIndex+1} å¤±è´¥`, error);
            return { 
                success: false, 
                reason: error.message,
                matchedCode: null 
            };
        }
    }
    
    // ä¿å­˜å›¾ç‰‡å…³è”ä¿¡æ¯åˆ°æ•°æ®åº“
    async function saveImageInfo(tileCode, tileColor, imageUrls) {
        if (!tileCode || !imageUrls.length) return false;
        
        try {
            // æŸ¥æ‰¾è¯¥ç“·ç –å·²æœ‰çš„å›¾ç‰‡è®°å½•
            let tileIndex = -1;
            if (Array.isArray(tileImages)) {
                tileIndex = tileImages.findIndex(
                    item => item && item.code === tileCode && item.color === tileColor
                );
            } else {
                // å¦‚æœä¸æ˜¯æ•°ç»„ï¼Œåˆå§‹åŒ–
                tileImages = [];
            }
            
            const imageData = {
                code: tileCode,
                color: tileColor || '',
                images: tileIndex >= 0 ? [...tileImages[tileIndex].images, ...imageUrls] : imageUrls,
                updateTime: new Date().toLocaleString()
            };
            
            // æ›´æ–°æˆ–æ–°å¢è®°å½•
            if (tileIndex >= 0) {
                tileImages[tileIndex] = imageData;
            } else {
                tileImages.push(imageData);
            }
            
            // ä¿å­˜åˆ°æ•°æ®åº“
            await firebase.set(firebase.imagesRef, tileImages);
            return true;
        } catch (error) {
            console.error('ä¿å­˜å›¾ç‰‡ä¿¡æ¯å¤±è´¥', error);
            return false;
        }
    }
    
    // æ‰“å¼€å›¾ç‰‡é¢„è§ˆå™¨
    function openImageViewer(code, color) {
        // æŸ¥æ‰¾è¯¥ç“·ç –çš„å›¾ç‰‡
        const tileImageData = tileImages.find(
            item => item && item.code === code && item.color === color
        );
        
        if (!tileImageData || !tileImageData.images || tileImageData.images.length === 0) {
            showToast('è¯¥ç“·ç –æš‚æ— å›¾ç‰‡');
            return;
        }
        
        currentViewerImages = tileImageData.images;
        currentViewerIndex = 0;
        const modal = document.getElementById('imageViewerModal');
        
        // æ˜¾ç¤ºç¬¬ä¸€å¼ å›¾ç‰‡
        updateViewerImage();
        
        // æ›´æ–°æŒ‡ç¤ºå™¨
        updateImagePagination();
        
        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        modal.style.display = 'flex';
    }
    
    // æ›´æ–°é¢„è§ˆå›¾ç‰‡
    function updateViewerImage() {
        const mainImage = document.getElementById('mainViewerImage');
        mainImage.style.opacity = '0.5'; // åŠ è½½ä¸­æ•ˆæœ
        
        // å…ˆåŠ è½½ç¼©ç•¥å›¾ï¼ˆå¿«é€Ÿæ˜¾ç¤ºï¼‰ï¼Œå†åŠ è½½é«˜æ¸…å›¾
        const img = new Image();
        img.onload = function() {
            mainImage.src = currentViewerImages[currentViewerIndex];
            mainImage.style.opacity = '1'; // åŠ è½½å®Œæˆ
        };
        img.src = currentViewerImages[currentViewerIndex];
    }
    
    // æ›´æ–°é¢„è§ˆå™¨åˆ†é¡µæŒ‡ç¤ºå™¨
    function updateImagePagination() {
        const pagination = document.getElementById('imagePagination');
        pagination.innerHTML = '';
        
        currentViewerImages.forEach((_, index) => {
            const dot = document.createElement('span');
            dot.className = `pagination-dot ${index === currentViewerIndex ? 'active' : ''}`;
            dot.onclick = () => {
                currentViewerIndex = index;
                updateViewerImage();
                updateImagePagination();
            };
            pagination.appendChild(dot);
        });
    }
    
    // åˆ‡æ¢é¢„è§ˆå›¾ç‰‡
    function switchViewerImage(direction) {
        currentViewerIndex += direction;
        
        // å¾ªç¯åˆ‡æ¢
        if (currentViewerIndex < 0) {
            currentViewerIndex = currentViewerImages.length - 1;
        } else if (currentViewerIndex >= currentViewerImages.length) {
            currentViewerIndex = 0;
        }
        
        updateViewerImage();
        updateImagePagination();
    }
    
    // å…³é—­å›¾ç‰‡é¢„è§ˆå™¨
    function closeImageViewer() {
        document.getElementById('imageViewerModal').style.display = 'none';
    }
</script>
</body>
</html>
    