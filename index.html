<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>瓷砖库存管理系统 - 最终版 v2</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
import { getDatabase, ref, set, onValue, get } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";
const firebaseConfig = {
  apiKey: "AIzaSyC65DEOgj4WeksRRVmw4ZTrNkCB83SoQpI",
  authDomain: "tile-management-system-f5db8.firebaseapp.com",
  databaseURL: "https://tile-management-system-f5db8-default-rtdb.firebaseio.com",
  projectId: "tile-management-system-f5db8",
  storageBucket: "tile-management-system-f5db8.appspot.com",
  messagingSenderId: "925027091187",
  appId: "1:925027091187:web:a2bb160b629f541abded86"
};
try {
  const app = initializeApp(firebaseConfig);
  const database = getDatabase(app);
  const stockRef = ref(database, 'tileStock');
  window.firebase = { app, database, ref, set, onValue, get, stockRef };
  window.firebaseInitialized = true;
} catch(e){ window.firebaseInitialized=false; window.firebaseError=e.message; }
</script>
<style>
:root{
  --primary:#007AFF;
  --bg:#F8FAFC;
  --card:#fff;
  --radius:14px;
  --shadow:0 6px 18px rgba(0,0,0,0.08);
  --red:#ef4444;
  --orange:#f59e0b;
  --lightgreen:#10b981;
  --green:#047857;
  font-family:-apple-system, BlinkMacSystemFont, "Helvetica Neue", Arial, sans-serif;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);padding:84px 12px 20px;-webkit-font-smoothing:antialiased;color:#111}
.navbar{
  position:fixed;top:0;left:0;right:0;height:72px;
  backdrop-filter: blur(12px);
  background:rgba(0,122,255,0.82);
  display:flex;align-items:center;justify-content:space-between;padding:10px 12px;color:white;z-index:999;border-bottom:1px solid rgba(255,255,255,0.12);
}
.navbar .brand{display:flex;align-items:center;gap:10px}
.navbar h1{font-size:17px;margin:0;font-weight:600}
.nav-tabs{display:flex;gap:6px;align-items:center}
.nav-tabs button{background:transparent;border:0;color:rgba(255,255,255,0.95);font-size:15px;padding:8px 10px;border-radius:10px;display:flex;gap:8px;align-items:center}
.nav-tabs button .icon{font-size:17px}
.nav-tabs button.active{background:rgba(255,255,255,0.12)}
.container{max-width:980px;margin:0 auto}
.card{background:var(--card);border-radius:14px;box-shadow:var(--shadow);padding:14px;margin-bottom:14px}
h3{color:var(--primary);margin:0 0 6px}
.thai{color:#666;font-size:13px;margin-bottom:8px}
.label-small{font-size:13px;color:#666;margin-bottom:6px}
input,select,textarea,button{font-size:15px}
input,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #e6eef9}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
button.primary{background:var(--primary);color:#fff;border:0;padding:10px;border-radius:10px;cursor:pointer;flex:1}
button.ghost{background:#f6f9ff;border:1px solid #e6eef9;color:#111;padding:10px;border-radius:10px;cursor:pointer;flex:1}
button.small{padding:6px 10px;border-radius:8px;font-size:14px}
.table-wrap{overflow:auto;-webkit-overflow-scrolling:touch;margin-top:10px;border-radius:8px}
table{width:100%;border-collapse:collapse;font-size:14px}
th,td{padding:10px;border-bottom:1px solid #f1f5f9;text-align:left}
th{background:var(--primary);color:#fff;position:sticky;top:0}
.item{background:#fbfdff;padding:10px;border-radius:10px;margin-bottom:10px;border:1px solid #eef5ff}
.mini-row{display:flex;gap:8px;align-items:center}
.mini-row input{flex:1}
.mini-row button{flex:0 0 auto}
.mini-res{margin-top:8px}
.qty-badge{display:inline-block;padding:4px 8px;border-radius:999px;color:#fff;font-weight:600;font-size:13px}
.qty-red{background:var(--red)}
.qty-orange{background:var(--orange);color:#fff}
.qty-lightgreen{background:var(--lightgreen)}
.qty-green{background:var(--green)}
.toast{position:fixed;bottom:26px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.78);color:#fff;padding:10px 16px;border-radius:18px;display:none;z-index:2000}
.admin-btn{position:fixed;right:14px;bottom:18px;background:transparent;border:0;z-index:1500}
.admin-btn .gear{background:rgba(0,0,0,0.6);color:#fff;padding:10px;border-radius:10px}
.modal{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.4);display:none;align-items:center;justify-content:center;z-index:2000}
.modal .card{width:92%;max-width:420px}
.footer-note{color:#666;text-align:center;padding:18px 0;font-size:13px}
@media(max-width:600px){body{padding:92px 12px 20px} .nav-tabs button{padding:6px 8px;font-size:14px} th,td{padding:8px;font-size:13px}}
</style>
</head>
<body>
<div class="navbar" role="banner">
  <div class="brand">
    <h1>瓷砖库存管理系统</h1>
  </div>
  <div class="nav-tabs" role="tablist" aria-label="主导航">
    <button class="tabbtn active" data-tab="tab-search"><span class="icon">📊</span><span>库存查询</span></button>
    <button class="tabbtn" data-tab="tab-chuhuo"><span class="icon">📦</span><span>出货计划</span></button>
    <button class="tabbtn" data-tab="tab-haiyun"><span class="icon">🚢</span><span>海运入库</span></button>
  </div>
</div>

<div class="container">
  <!-- 库存查询 -->
  <div id="tab-search" class="card tab" role="tabpanel">
    <h3>📊 库存查询</h3>
    <div class="thai">(ตรวจสอบสต็อกสินค้า)</div>
    <div class="label-small">瓷砖编号 (支持模糊搜索)</div>
    <input id="searchCode" placeholder="输入编号关键词，例如 AB123">
    <div class="controls">
      <button class="primary" id="searchBtn">查询库存<br><span class="thai">(ตรวจสอบสต็อก)</span></button>
      <button class="ghost" id="refreshBtn">刷新数据<br><span class="thai">(รีเฟรชข้อมูล)</span></button>
    </div>
    <div id="lastInfo" style="margin-top:8px;color:#666;font-size:13px">库存最后更新时间：加载中...</div>
    <div class="table-wrap">
      <table id="mainTable" style="display:none">
        <thead><tr><th>编号</th><th>色号</th><th>数量(箱)</th><th>仓库</th></tr></thead>
        <tbody id="mainTbody"></tbody>
      </table>
      <div id="mainMsg" style="padding:12px;color:#888">请输入编号并点击查询</div>
    </div>
  </div>

  <!-- 出货计划 -->
  <div id="tab-chuhuo" class="card tab" style="display:none">
    <h3>📦 出货计划</h3>
    <div class="thai">(แผนการจัดส่งสินค้า)</div>
    <label>日期</label><input id="ch_date" type="date">
    <label>单位或车牌</label><input id="ch_vehicle" type="text">
    <label>客户</label><input id="ch_customer" type="text">
    <div id="ch_items"></div>
    <div class="controls">
      <button class="primary" id="ch_add">+ 添加货项<br><span class='thai'>(+ เพิ่มรายการสินค้า)</span></button>
      <button class="ghost" id="ch_gen">生成文字<br><span class='thai'>(สร้างข้อความ)</span></button>
      <button class="primary" id="ch_copy">复制<br><span class='thai'>(คัดลอก)</span></button>
    </div>
    <pre id="ch_result" style="margin-top:10px">（请先填写表单）</pre>
  </div>

  <!-- 海运入库 -->
  <div id="tab-haiyun" class="card tab" style="display:none">
    <h3>🚢 海运入库</h3>
    <div class="thai">(นำเข้าสินค้าทางเรือ)</div>
    <label>日期</label><input id="hy_date" type="date">
    <label>柜号</label><input id="hy_container" type="text">
    <label>入库仓库（手动输入）</label><input id="hy_warehouse" placeholder="例如：K38仓库">
    <div id="hy_items"></div>
    <div class="controls">
      <button class="primary" id="hy_add">+ 添加货项<br><span class='thai'>(+ เพิ่มรายการสินค้า)</span></button>
      <button class="ghost" id="hy_gen">生成文字<br><span class='thai'>(สร้างข้อความ)</span></button>
      <button class="primary" id="hy_copy">复制<br><span class='thai'>(คัดลอก)</span></button>
    </div>
    <pre id="hy_result" style="margin-top:10px">（请先填写表单）</pre>
  </div>

  <!-- 管理员区域（底部小按钮触发） -->
  <div id="admin_placeholder" style="height:18px"></div>

  <div class="footer-note">仅限内部使用 | Designed by Kyson Li</div>
</div>

<!-- 管理员按钮 -->
<button class="admin-btn" id="adminToggle" title="管理员登录">
  <span class="gear">⚙️ 管理员登录</span>
</button>

<!-- 管理员弹窗 -->
<div class="modal" id="adminModal" role="dialog" aria-modal="true">
  <div class="card">
    <h3>🔐 管理员功能</h3>
    <div class="thai">(สำหรับผู้ดูแลระบบ)</div>
    <label>管理员密码</label>
    <input id="adminPw" type="password" placeholder="输入密码">
    <div class="controls" style="margin-top:8px">
      <button class="primary" id="adminLogin">登录<br><span class='thai'>(เข้าสู่ระบบ)</span></button>
      <button class="ghost" id="adminClose">取消</button>
    </div>
    <div id="adminArea" style="display:none;margin-top:12px">
      <div class="label-small">上传 Excel 文件（B列=编号，C列=色号，J列=数量）</div>
      <input id="excelInput" type="file" accept=".xlsx,.xls">
      <div class="controls" style="margin-top:8px">
        <button class="secondary" id="btnSave">保存并写入 Firebase<br><span class='thai'>(บันทึกข้อมูล)</span></button>
        <button class="ghost" id="btnPreview">预览数据</button>
      </div>
      <div id="previewBox" style="margin-top:10px"></div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
(function(){
  // Tabs
  const tabButtons = document.querySelectorAll('.tabbtn');
  tabButtons.forEach(b=>{
    b.addEventListener('click', ()=> {
      tabButtons.forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      document.querySelectorAll('.tab').forEach(t=>t.style.display='none');
      const id = 'tab-' + b.dataset.tab?.split?.('-')?.pop?.() || b.dataset.tab;
      // mapping: use dataset tab value directly (we set data-tab to tab-search etc.)
      const target = b.dataset.tab;
      document.getElementById(target).style.display='block';
      window.scrollTo({top:0,behavior:'smooth'});
    });
  });

  function showToast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',2400); }

  // Stock data
  let stockData = [];
  async function loadStockData(){
    if(!window.firebase){ showToast('Firebase 未初始化'); return; }
    try{
      const snap = await window.firebase.get(window.firebase.stockRef);
      const val = snap.val();
      if(val && val.stockData){ stockData = val.stockData; document.getElementById('lastInfo').textContent = '库存最后更新时间：' + (val.updateTime || new Date().toLocaleString()); showToast('已加载库存数据'); }
      else { stockData = []; showToast('暂无库存数据'); }
    }catch(e){ console.error(e); showToast('加载库存失败'); }
  }

  // render quantity with color
  function qtyBadge(num){
    const n = Number(num) || 0;
    if(n <= 50) return `<span class="qty-badge qty-red">${n}</span>`;
    if(n <= 200) return `<span class="qty-badge qty-orange">${n}</span>`;
    if(n <= 500) return `<span class="qty-badge qty-lightgreen">${n}</span>`;
    return `<span class="qty-badge qty-green">${n}</span>`;
  }

  // main search
  document.getElementById('searchBtn').addEventListener('click', ()=>{
    const key = document.getElementById('searchCode').value.trim().toLowerCase();
    const table = document.getElementById('mainTable'), tbody = document.getElementById('mainTbody'), msg = document.getElementById('mainMsg');
    tbody.innerHTML=''; table.style.display='none'; msg.textContent='';
    if(!key){ msg.textContent='请输入编号关键词'; return; }
    const res = stockData.filter(i => i.code && String(i.code).toLowerCase().includes(key));
    if(!res.length){ msg.textContent='未找到结果'; return; }
    res.forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${r.code}</td><td>${r.color||'-'}</td><td>${qtyBadge(r.quantity)}</td><td>${r.warehouse||''}</td>`;
      tbody.appendChild(tr);
    });
    table.style.display='table';
  });
  document.getElementById('refreshBtn').addEventListener('click', loadStockData);

  // 出货计划: add item with aligned search button
  const chList = document.getElementById('ch_items');
  function addChItem(v={}) {
    const el = document.createElement('div'); el.className='item';
    el.innerHTML = `
      <div class="mini-row">
        <div style="flex:1">
          <label>ကုဒ်နိပတ်/编号</label>
          <input class="ch-code" placeholder="输入编号">
        </div>
        <button class="small ch-search">查询库存</button>
      </div>
      <div class="mini-res"></div>
      <label>အရောင်ကုဒ်色号</label><input class="ch-color">
      <label>အလျားအနံ/规格</label><input class="ch-spec">
      <label>အရေအတွက်/数量</label><input class="ch-qty">`;
    chList.appendChild(el);
    if(v.code) el.querySelector('.ch-code').value = v.code;
    if(v.color) el.querySelector('.ch-color').value = v.color;
    if(v.spec) el.querySelector('.ch-spec').value = v.spec;
    if(v.qty) el.querySelector('.ch-qty').value = v.qty;

    const btn = el.querySelector('.ch-search');
    const codeInput = el.querySelector('.ch-code');
    const resDiv = el.querySelector('.mini-res');

    btn.addEventListener('click', ()=>{
      const q = codeInput.value.trim().toLowerCase();
      resDiv.innerHTML = '<div style="color:#666;padding:6px">查询中...</div>';
      if(!q){ resDiv.innerHTML = '<div style="color:#c00;padding:6px">请输入编号</div>'; return; }
      const res = stockData.filter(i => i.code && String(i.code).toLowerCase().includes(q));
      if(!res.length){ resDiv.innerHTML = '<div style="color:#666;padding:6px">未找到库存信息</div>'; return; }
      let html = '<div class="table-wrap"><table><thead><tr><th>编号</th><th>色号</th><th>数量(箱)</th><th>仓库</th></tr></thead><tbody>';
      res.forEach(r => html += `<tr><td>${r.code}</td><td>${r.color||'-'}</td><td>${qtyBadge(r.quantity)}</td><td>${r.warehouse||''}</td></tr>`);
      html += '</tbody></table></div>';
      resDiv.innerHTML = html;
    });
  }
  addChItem();
  document.getElementById('ch_add').addEventListener('click', ()=>addChItem());
  document.getElementById('ch_gen').addEventListener('click', ()=>{
    const date = document.getElementById('ch_date').value;
    const vehicle = document.getElementById('ch_vehicle').value;
    const customer = document.getElementById('ch_customer').value;
    let text = `出货计划\n日期：${date}\n单位或车牌：${vehicle}\n客户：${customer}\n\n`;
    Array.from(chList.children).forEach((el,idx)=>{
      const code = el.querySelector('.ch-code').value;
      const color = el.querySelector('.ch-color').value;
      const spec = el.querySelector('.ch-spec').value;
      const qty = el.querySelector('.ch-qty').value;
      text += `${idx+1}.ကုဒ်နိပတ်/编号：${code}\nအရောင်ကုဒ်色号：${color}\nအလျားအနံ/规格：${spec}\nအရေအัพท์/数量：${qty}\n\n`;
    });
    document.getElementById('ch_result').textContent = text.trim();
    showToast('已生成出货计划');
  });
  document.getElementById('ch_copy').addEventListener('click', ()=>{ navigator.clipboard.writeText(document.getElementById('ch_result').textContent); showToast('已复制'); });

  // 海运入库
  const hyList = document.getElementById('hy_items');
  function addHyItem(v={}) {
    const el = document.createElement('div'); el.className='item';
    el.innerHTML = `
      <label>ကုဒ်နိပတ်/编号</label><input class="hy-code">
      <label>规格/အလျားအနံ</label><input class="hy-spec">
      <label>色号/အရောင်ကုဒ်</label><input class="hy-color">
      <label>数量/အရေအတွက်</label><input class="hy-qty">`;
    hyList.appendChild(el);
    if(v.code) el.querySelector('.hy-code').value = v.code;
    if(v.spec) el.querySelector('.hy-spec').value = v.spec;
    if(v.color) el.querySelector('.hy-color').value = v.color;
    if(v.qty) el.querySelector('.hy-qty').value = v.qty;
  }
  addHyItem();
  document.getElementById('hy_add').addEventListener('click', ()=>addHyItem());
  document.getElementById('hy_gen').addEventListener('click', ()=>{
    const date = document.getElementById('hy_date').value;
    const container = document.getElementById('hy_container').value;
    const warehouse = document.getElementById('hy_warehouse').value || '';
    let text = `海运入库：${warehouse}\n日期：${date}\n柜号：${container}\n\n`;
    Array.from(hyList.children).forEach((el,idx)=>{
      const code = el.querySelector('.hy-code').value;
      const spec = el.querySelector('.hy-spec').value;
      const color = el.querySelector('.hy-color').value;
      const qty = el.querySelector('.hy-qty').value;
      text += `${idx+1}.ကုဒ်နိပတ်/编号：${code}\nအလျားအနံ/规格：${spec}\nအရောင်ကုဒ်色号：${color}\nအရေအาสตร์/数量：${qty}\n\n`;
    });
    document.getElementById('hy_result').textContent = text.trim();
    showToast('已生成海运入库');
  });
  document.getElementById('hy_copy').addEventListener('click', ()=>{ navigator.clipboard.writeText(document.getElementById('hy_result').textContent); showToast('已复制'); });

  // Admin modal behavior
  const adminToggle = document.getElementById('adminToggle');
  const adminModal = document.getElementById('adminModal');
  const adminClose = document.getElementById('adminClose');
  adminToggle.addEventListener('click', ()=>{ adminModal.style.display = 'flex'; });
  adminClose.addEventListener('click', ()=>{ adminModal.style.display = 'none'; });
  adminModal.addEventListener('click', (e)=>{ if(e.target === adminModal) adminModal.style.display='none'; });

  document.getElementById('adminLogin').addEventListener('click', ()=>{
    const pw = document.getElementById('adminPw').value.trim();
    if(pw === 'admin'){ document.getElementById('adminArea').style.display='block'; showToast('管理员已登录'); }
    else showToast('密码错误');
  });

  document.getElementById('btnPreview').addEventListener('click', ()=>{
    const f = document.getElementById('excelInput').files[0];
    if(!f){ showToast('请选择 Excel 文件'); return; }
    const reader = new FileReader();
    reader.onload = (e)=>{
      const wb = XLSX.read(new Uint8Array(e.target.result), { type:'array' });
      let items = [];
      wb.SheetNames.forEach(name=>{
        const ws = wb.Sheets[name];
        const rows = XLSX.utils.sheet_to_json(ws, { header:1 });
        for(let r=0;r<rows.length;r++){
          const row = rows[r];
          const check = row[1] ? String(row[1]) : '';
          if(String(check).includes('กระเบื้อง')) {
            const code = row[1] ? String(row[1]).trim() : '';
            const color = row[2] ? String(row[2]).trim() : '';
            const qty = row[9] ? Number(row[9]) : 0;
            if(code) items.push({ code, color, quantity: qty, warehouse: name });
          }
        }
      });
      document.getElementById('previewBox').innerHTML = '<pre style="max-height:280px;overflow:auto">'+JSON.stringify(items.slice(0,200),null,2)+'</pre>';
      showToast('预览已生成');
    };
    reader.readAsArrayBuffer(f);
  });

  document.getElementById('btnSave').addEventListener('click', ()=>{
    const f = document.getElementById('excelInput').files[0];
    if(!f){ showToast('请选择 Excel 文件'); return; }
    const reader = new FileReader();
    reader.onload = async (e)=>{
      const wb = XLSX.read(new Uint8Array(e.target.result), { type:'array' });
      let items = [];
      wb.SheetNames.forEach(name=>{
        const ws = wb.Sheets[name];
        const rows = XLSX.utils.sheet_to_json(ws, { header:1 });
        for(let r=0;r<rows.length;r++){
          const row = rows[r];
          const check = row[1] ? String(row[1]) : '';
          if(String(check).includes('กระเบื้อง')) {
            const code = row[1] ? String(row[1]).trim() : '';
            const color = row[2] ? String(row[2]).trim() : '';
            const qty = row[9] ? Number(row[9]) : 0;
            if(code) items.push({ code, color, quantity: qty, warehouse: name });
          }
        }
      });
      if(!window.firebase){ showToast('Firebase 未就绪'); return; }
      try{
        const updateTime = new Date().toLocaleString();
        await window.firebase.set(window.firebase.stockRef, { stockData: items, updateTime });
        showToast('已保存到 Firebase');
        stockData = items;
        document.getElementById('lastInfo').textContent = '库存最后更新时间：' + updateTime;
        adminModal.style.display='none';
      }catch(err){ console.error(err); showToast('保存失败'); }
    };
    reader.readAsArrayBuffer(f);
  });

  // initial load
  setTimeout(()=>{ if(window.firebaseInitialized) loadStockData(); }, 600);

  // allow enter key for search
  document.getElementById('searchCode').addEventListener('keypress', (e)=>{ if(e.key==='Enter') document.getElementById('searchBtn').click(); });

})();
</script>
</body>
</html>
