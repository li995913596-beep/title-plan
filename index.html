<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>瓷砖出入库管理系统</title>
    <!-- 引入SheetJS库用于处理Excel文件 -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- 引入Firebase模块化版本 -->
    <script type="module">
        // 首先导入所有需要的Firebase函数
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, get, update } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";
        
        // Firebase配置
        const firebaseConfig = {
            apiKey: "AIzaSyC65DEOgj4WeksRRVmw4ZTrNkCB83SoQpI",
            authDomain: "tile-management-system-f5db8.firebaseapp.com",
            databaseURL: "https://tile-management-system-f5db8-default-rtdb.firebaseio.com",
            projectId: "tile-management-system-f5db8",
            storageBucket: "tile-management-system-f5db8.appspot.com",
            messagingSenderId: "925027091187",
            appId: "1:925027091187:web:a2bb160b629f541abded86"
        };

        try {
            // 初始化Firebase应用
            const app = initializeApp(firebaseConfig);
            const database = getDatabase(app);
            
            // 创建数据库引用
            const stockRef = ref(database, 'tileStock');
            
            // 将Firebase相关对象暴露到全局，确保其他脚本可以访问
            window.firebase = {
                app,
                database,
                ref,
                set,
                onValue,
                get,
                update,
                stockRef
            };
            
            // 标记Firebase初始化成功
            window.firebaseInitialized = true;
            console.log('Firebase初始化成功');
        } catch (error) {
            console.error('Firebase初始化失败:', error);
            window.firebaseInitialized = false;
            window.firebaseError = error.message;
        }
    </script>
    <style>
        /* 保持原有样式不变 */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
        body { padding: 15px; background-color: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; }
        .card { background: white; padding: 15px; margin-bottom: 15px; border-radius: 8px; box-shadow: 0 1px 3px #eee; }
        h1, h2 { margin-bottom: 15px; color: #333; }
        h1 { text-align: center; color: #4F46E5; font-size: 20px; padding: 10px 0; }
        .form-group { margin-bottom: 12px; }
        label { display: block; margin-bottom: 5px; font-size: 14px; color: #666; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 15px; }
        button { background-color: #4F46E5; color: white; border: none; padding: 12px; border-radius: 4px; width: 100%; font-size: 16px; margin-top: 5px; cursor: pointer; transition: background-color 0.3s; }
        button:hover { opacity: 0.9; }
        button.secondary { background-color: #10B981; }
        button.gray { background-color: #f0f0f0; color: #666; }
        button.admin { background-color: #f59e0b; }
        .flex-row { display: flex; gap: 10px; }
        .flex-row button { flex: 1; }
        #tiles-list { margin: 10px 0; padding: 10px; border: 1px dashed #ddd; min-height: 60px; }
        .tile-item { padding: 8px; background: #f9f9f9; margin-bottom: 5px; border-radius: 4px; }
        #result { margin: 10px 0; padding: 10px; background: #f9f9f9; border-radius: 4px; white-space: pre-wrap; font-size: 14px; }
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); color: white; padding: 10px 15px; border-radius: 4px; display: none; z-index: 1000; }
        .mode-selector { display: flex; margin-bottom: 15px; flex-wrap: wrap; }
        .mode-selector button { flex: 1; margin: 0; min-width: 120px; }
        .mode-selector button.active { background-color: #4F46E5; color: white; }
        .mode-selector button:not(.active) { background-color: #f0f0f0; color: #666; }
        .mode-content { display: none; }
        .mode-content.active { display: block; }
        .common-content { display: block; }
        .stock-mode .common-content { display: none; }
        
        .import-area {
            border: 2px dashed #ccc;
            border-radius: 6px;
            padding: 20px;
            text-align: center;
            margin-bottom: 15px;
            cursor: pointer;
            transition: border-color 0.3s;
        }
        .import-area:hover {
            border-color: #4F46E5;
        }
        .import-icon {
            font-size: 24px;
            color: #4F46E5;
            margin-bottom: 10px;
        }
        
        .last-update {
            font-size: 13px;
            color: #666;
            margin-top: 10px;
            text-align: right;
        }
        .github-footer {
            text-align: center;
            font-size: 12px;
            color: #666;
            margin-top: 20px;
            padding: 10px;
        }
        .admin-section {
            margin: 15px 0;
            padding: 10px;
            background-color: #fff3cd;
            border-radius: 4px;
            display: none;
        }
        
        .compact-auth {
            margin: 10px 0;
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        .compact-auth .form-group {
            flex: 1;
            margin: 0;
        }
        .compact-auth input {
            padding: 8px;
            font-size: 14px;
        }
        .compact-auth button {
            padding: 8px;
            font-size: 14px;
            white-space: nowrap;
            width: auto;
        }
        .auth-label {
            font-size: 12px;
            color: #888;
            margin-bottom: 3px;
            display: block;
        }
        .error-message {
            color: #dc2626;
            font-size: 12px;
            margin-top: 3px;
            display: none;
        }
        
        .offline-notice {
            background-color: #fff3cd;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 14px;
            display: none;
        }
        .sync-status {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            text-align: right;
        }
        
        .stock-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            box-shadow: 0 2px 3px rgba(0,0,0,0.05);
        }
        .stock-table th {
            padding: 12px 15px;
            text-align: left;
            background-color: #4F46E5;
            color: white;
            font-weight: bold;
            font-size: 15px;
            position: sticky;
            top: 0;
        }
        .stock-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
            font-size: 15px;
        }
        .stock-table tr:hover {
            background-color: #f0f7ff;
            transform: translateX(3px);
            transition: all 0.2s ease;
        }
        .stock-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .stock-high {
            color: #10B981;
            font-weight: bold;
        }
        .stock-medium {
            color: #f59e0b;
            font-weight: bold;
        }
        .stock-low {
            color: #ef4444;
            font-weight: bold;
        }
        .stock-urgent {
            color: white;
            background-color: #ef4444;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: bold;
        }
        
        #stockCode {
            padding: 12px;
            font-size: 16px;
            border: 2px solid #ddd;
            transition: border-color 0.3s;
        }
        #stockCode:focus {
            border-color: #4F46E5;
            outline: none;
        }
        #stock-content button {
            padding: 12px;
            font-weight: 600;
        }
        
        .search-highlight {
            background-color: #fff380;
            padding: 0 3px;
            border-radius: 2px;
        }
        
        .table-container {
            overflow-x: auto;
            margin-top: 10px;
            border-radius: 6px;
            border: 1px solid #eee;
            max-height: 500px;
            overflow-y: auto;
        }
        
        #copyButton, #stockCopyButton {
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
        }
        
        #copyButton.copied, #stockCopyButton.copied {
            background-color: #10B981;
        }
        
        #copyButton.copied::after, #stockCopyButton.copied::after {
            content: "✓ 已复制";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #10B981;
            animation: copySuccess 1.5s;
        }
        
        @keyframes copySuccess {
            0% { opacity: 0; }
            20% { opacity: 1; }
            80% { opacity: 1; }
            100% { opacity: 0; }
        }
        
        .copy-hint {
            font-size: 12px;
            color: #666;
            text-align: center;
            margin-top: 5px;
        }
        
        .upload-instructions {
            font-size: 13px;
            color: #666;
            margin: 10px 0;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        
        .upload-instructions strong {
            color: #4F46E5;
        }
        
        .query-status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-size: 14px;
            display: none;
        }
        
        .status-loading {
            background-color: #e0f2fe;
            color: #0284c7;
            display: block;
        }
        
        .status-error {
            background-color: #fee2e2;
            color: #b91c1c;
            display: block;
        }
        
        .status-info {
            background-color: #eff6ff;
            color: #1e40af;
            display: block;
        }
        
        .troubleshoot {
            margin-top: 8px;
            padding-left: 15px;
            font-size: 13px;
        }
        
        .troubleshoot li {
            margin: 4px 0;
        }
        
        /* 初始化状态提示样式 */
        .initialization-status {
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 6px;
            font-size: 14px;
            text-align: center;
        }
        
        .initialization-loading {
            background-color: #f0fdf4;
            color: #15803d;
        }
        
        .initialization-error {
            background-color: #fee2e2;
            color: #b91c1c;
        }
        
        /* 库存管理选项卡样式 */
        .stock-tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid #ddd;
        }
        
        .stock-tab {
            padding: 8px 15px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-right: 10px;
        }
        
        .stock-tab.active {
            border-bottom-color: #4F46E5;
            color: #4F46E5;
            font-weight: bold;
        }
        
        .stock-tab-content {
            display: none;
        }
        
        .stock-tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
<div class="container">
    <!-- 初始化状态提示 -->
    <div id="initializationStatus" class="initialization-status initialization-loading">
        系统正在初始化，请稍候...
    </div>

    <h1>瓷砖出入库管理系统</h1>
    
    <!-- 离线模式提示 -->
    <div class="offline-notice" id="offlineNotice">
        注意：系统正以离线模式运行，库存数据可能不是最新的
    </div>

    <div class="mode-selector">
        <button id="outbound-mode" class="active" onclick="switchMode('outbound')">出货计划</button>
        <button id="inbound-mode" onclick="switchMode('inbound')">海运入库</button>
        <button id="stock-mode" onclick="switchMode('stock')">库存管理</button>
    </div>
    <div class="card"><div id="date"></div></div>

    <div id="outbound-content" class="mode-content active">
        <div class="card">
            <h2>订单信息</h2>
            <div class="form-group"><label>客户 (可选)</label><input type="text" id="customer" oninput="saveData()"></div>
            <div class="form-group">
                <label>是否付款</label>
                <select id="payment" onchange="saveData()">
                    <option value="">请选择</option>
                    <option value="yes">是</option>
                    <option value="no">否</option>
                </select>
            </div>
            <div class="form-group"><label>单位或车牌</label><input type="text" id="unit" oninput="saveData()"></div>
        </div>
    </div>

    <div id="inbound-content" class="mode-content">
        <div class="card">
            <h2>入库信息</h2>
            <div class="form-group"><label>柜号 *</label><input type="text" id="containerNo" oninput="saveData()"></div>
            <div class="form-group">
                <label>入库仓库 *</label>
                <select id="warehouse" onchange="saveData()">
                    <option value="">请选择</option>
                    <option value="1号仓库">1号仓库</option>
                    <option value="k38仓库">k38仓库</option>
                    <option value="k39仓库">k39仓库</option>
                </select>
            </div>
        </div>
    </div>

    <div id="stock-content" class="mode-content">
        <div class="card">
            <h2>库存管理</h2>
            
            <!-- 库存管理选项卡 -->
            <div class="stock-tabs">
                <div class="stock-tab active" onclick="switchStockTab('search')">库存查询</div>
                <div class="stock-tab" onclick="switchStockTab('full')">完整库存表</div>
            </div>
            
            <!-- 库存查询内容 -->
            <div id="search-tab-content" class="stock-tab-content active">
                <div class="form-group">
                    <label>瓷砖编号 (支持模糊查询)</label>
                    <input type="text" id="stockCode" placeholder="输入编号关键词">
                </div>
                <div class="flex-row">
                    <button onclick="searchStock()">查询库存</button>
                    <button class="secondary" onclick="refreshStockData()">刷新数据</button>
                </div>
                <button class="gray" id="stockCopyButton" style="margin-top: 10px;" onclick="copyStockResults()">复制查询结果</button>
                
                <!-- 查询状态提示区域 -->
                <div id="queryStatus" class="query-status"></div>
                
                <div class="last-update" id="last-update-time">
                    库存最后更新时间：加载中...
                </div>
                
                <div class="card" style="margin-top: 15px;">
                    <h3>查询结果</h3>
                    <div class="table-container">
                        <table class="stock-table" id="stock-result-table" style="display: none;">
                            <thead>
                                <tr>
                                    <th>编号</th>
                                    <th>色号</th>
                                    <th>数量(箱)</th>
                                    <th>仓库</th>
                                </tr>
                            </thead>
                            <tbody id="stock-result-body">
                                <!-- 结果将在这里动态填充 -->
                            </tbody>
                        </table>
                        <div id="stock-result-message">请输入编号并点击查询</div>
                    </div>
                </div>
            </div>
            
            <!-- 完整库存表内容 -->
            <div id="full-tab-content" class="stock-tab-content">
                <button class="secondary" onclick="refreshStockData()">刷新库存数据</button>
                <div class="last-update" id="full-last-update-time">
                    库存最后更新时间：加载中...
                </div>
                
                <div class="card" style="margin-top: 15px;">
                    <h3>完整库存表（按数量从多到少排列）</h3>
                    <div class="table-container">
                        <table class="stock-table" id="full-stock-table" style="display: none;">
                            <thead>
                                <tr>
                                    <th>编号</th>
                                    <th>色号</th>
                                    <th>数量(箱)</th>
                                    <th>仓库</th>
                                </tr>
                            </thead>
                            <tbody id="full-stock-body">
                                <!-- 完整库存数据将在这里动态填充 -->
                            </tbody>
                        </table>
                        <div id="full-stock-message">加载库存数据中...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 公共内容区域 -->
    <div class="common-content">
        <div class="card">
            <h2>瓷砖信息</h2>
            <div class="form-group"><label>编号 *</label><input type="text" id="code"></div>
            <div class="form-group">
                <label>规格 *</label>
                <select id="size" onchange="handleSizeChange()">
                    <option value="">请选择</option>
                    <option value="300*300">300*300</option>
                    <option value="300*600">300*600</option>
                    <option value="400*400">400*400</option>
                    <option value="400*800">400*800</option>
                    <option value="470*1200">470*1200</option>
                    <option value="470*1350">470*1350</option>
                    <option value="600*600">600*600</option>
                    <option value="600*1200">600*1200</option>
                    <option value="750*1500">750*1500</option>
                    <option value="800*800">800*800</option>
                    <option value="200*1200">200*1200</option>
                    <option value="custom">自定义</option>
                </select>
                <input type="text" id="customSize" placeholder="请输入自定义规格" style="margin-top:5px; display:none;" oninput="saveData()">
            </div>
            <div class="form-group"><label>数量 *</label><input type="text" id="quantity" oninput="this.value=this.value.replace(/\D/g,''); saveData();"></div>
            <div class="form-group"><label>色号 (可选)</label><input type="text" id="color"></div>
            <button onclick="addTile()">添加到列表</button>
        </div>

        <div class="card">
            <h2>已添加的瓷砖</h2>
            <div id="tiles-list">尚未添加瓷砖</div>
            <div class="flex-row">
                <button class="gray" id="clearButton" onclick="clearAll()">清空</button>
                <button class="secondary" onclick="generatePlan()">生成计划</button>
            </div>
        </div>

        <div class="card">
            <h2>计划结果</h2>
            <div id="result"></div>
            <button id="copyButton" onclick="copyResult()">复制内容</button>
            <div class="copy-hint">点击按钮即可复制，无需手动选择</div>
        </div>
    </div>
    
    <!-- 紧凑的管理员登录区域 -->
    <div class="compact-auth">
        <div class="form-group">
            <span class="auth-label">管理员入口</span>
            <input type="password" id="adminPassword" placeholder="输入密码">
            <div class="error-message" id="adminError"></div>
        </div>
        <button class="admin" id="adminLoginBtn">登录</button>
    </div>
    
    <!-- 管理员功能区域（默认隐藏） -->
    <div class="admin-section" id="adminSection">
        <h2>管理员功能</h2>
        
        <!-- 上传说明 -->
        <div class="upload-instructions">
            <strong>库存表格式要求：</strong><br>
            - 编号请放在 <strong>B列</strong><br>
            - 色号请放在 <strong>C列</strong>（无内容可留空）<br>
            - 库存数量请放在 <strong>J列</strong><br>
            - 支持 .xlsx 和 .xls 格式
        </div>
        
        <div class="import-area" onclick="document.getElementById('adminFileInput').click()">
            <div class="import-icon">📂</div>
            <p>点击或拖拽Excel文件到此处更新公共库存数据</p>
            <input type="file" id="adminFileInput" accept=".xlsx,.xls" onchange="handleAdminFileUpload(event)">
        </div>
        
        <div class="sync-status" id="syncStatus"></div>
        <button class="gray" onclick="logoutAdmin()">退出管理员模式</button>
    </div>
    
    <div class="github-footer">
        瓷砖出入库管理系统 &copy; 2023
    </div>
</div>
<div class="toast" id="toast"></div>

<script>
    // 等待Firebase初始化完成后再执行系统初始化
    function waitForFirebase() {
        const statusElement = document.getElementById('initializationStatus');
        
        // 检查Firebase是否已初始化
        if (window.firebaseInitialized !== undefined) {
            if (window.firebaseInitialized) {
                // 初始化成功，隐藏状态提示
                statusElement.style.display = 'none';
                // 继续系统初始化
                initSystem();
            } else {
                // 初始化失败，显示错误信息
                statusElement.className = 'initialization-status initialization-error';
                statusElement.innerHTML = `
                    系统初始化失败: ${window.firebaseError || '未知错误'}<br><br>
                    <strong>请尝试：</strong><br>
                    1. 刷新页面重新加载<br>
                    2. 检查网络连接<br>
                    3. 稍后再试
                `;
            }
            return;
        }
        
        // 如果还未初始化，继续等待
        setTimeout(waitForFirebase, 100);
    }
    
    // 启动等待机制
    waitForFirebase();

    // 全局变量
    let tiles = [];
    let tileIndex = 0;
    let currentMode = 'outbound';
    let currentStockTab = 'search'; // 库存管理中的当前选项卡
    let stockData = [];
    let isAdmin = false;
    let isOfflineMode = false;
    let isStockDataLoading = false;
    const ADMIN_PASSWORD = "admin"; // 请修改为安全密码
    
    // 库存阈值设置
    const STOCK_THRESHOLDS = {
        urgent: 10,   // 紧急库存（<=10箱）
        low: 50,      // 低库存（<=50箱）
        medium: 100   // 中等库存（<=100箱）
    };

    // 系统初始化函数
    function initSystem() {
        // 显示当前日期
        const now = new Date();
        document.getElementById('date').textContent = 
            `${now.getFullYear()}/${(now.getMonth()+1).toString().padStart(2, '0')}/${now.getDate().toString().padStart(2, '0')}`;

        // 绑定管理员登录按钮事件
        document.getElementById('adminLoginBtn').addEventListener('click', authenticateAdmin);
        
        // 为清空按钮添加额外的事件监听器，确保能响应
        document.getElementById('clearButton').addEventListener('click', clearAll);
        
        // 检查网络状态
        isOfflineMode = !navigator.onLine;
        if (isOfflineMode) {
            document.getElementById('offlineNotice').style.display = 'block';
        }

        // 优先加载库存数据
        loadStockData();

        // 恢复本地计划数据
        restoreSavedData();
        
        // 设置实时监听，当库存数据变化时自动更新所有用户
        firebase.onValue(firebase.stockRef, (snapshot) => {
            const data = snapshot.val();
            if (data && data.stockData) {
                stockData = data.stockData;
                updateLastUpdateTime(data.updateTime);
                
                // 缓存到本地
                localStorage.setItem('cachedStockData', JSON.stringify(stockData));
                localStorage.setItem('cachedStockTime', data.updateTime);
                
                // 如果当前在库存管理页面，刷新数据
                if (currentMode === 'stock') {
                    if (currentStockTab === 'search') {
                        // 如果在查询页面且有查询内容，重新查询
                        const currentSearch = document.getElementById('stockCode').value.trim();
                        if (currentSearch) {
                            searchStock();
                        }
                    } else {
                        // 如果在完整库存表页面，刷新表格
                        displayFullStockTable();
                    }
                }
                
                showToast('库存数据已更新');
            }
        });
    }

    // 切换库存管理选项卡
    function switchStockTab(tabName) {
        currentStockTab = tabName;
        
        // 更新选项卡样式
        document.querySelectorAll('.stock-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelector(`.stock-tab[onclick="switchStockTab('${tabName}')"]`).classList.add('active');
        
        // 更新内容显示
        document.querySelectorAll('.stock-tab-content').forEach(content => {
            content.classList.remove('active');
        });
        document.getElementById(`${tabName}-tab-content`).classList.add('active');
        
        // 如果切换到完整库存表，确保数据已加载并显示
        if (tabName === 'full') {
            if (stockData.length === 0 && !isStockDataLoading) {
                loadStockData();
            } else {
                displayFullStockTable();
            }
        }
    }

    // 显示完整库存表（按数量从多到少排列）
    function displayFullStockTable() {
        const table = document.getElementById('full-stock-table');
        const tbody = document.getElementById('full-stock-body');
        const message = document.getElementById('full-stock-message');
        
        // 清空之前的结果
        table.style.display = 'none';
        tbody.innerHTML = '';
        message.textContent = '';
        
        // 检查数据加载状态
        if (isStockDataLoading) {
            message.textContent = '正在加载库存数据...';
            return;
        }
        
        // 检查是否有库存数据
        if (stockData.length === 0) {
            message.textContent = '暂无库存数据，请管理员上传';
            return;
        }
        
        try {
            // 验证库存数据格式
            if (!Array.isArray(stockData)) {
                throw new Error('库存数据格式错误，不是有效的数组');
            }
            
            // 复制并按数量从多到少排序
            const sortedData = [...stockData].sort((a, b) => {
                // 确保数量是数字
                const qtyA = Number(a.quantity) || 0;
                const qtyB = Number(b.quantity) || 0;
                return qtyB - qtyA; // 降序排列
            });
            
            // 显示表格
            table.style.display = 'table';
            message.textContent = '';
            
            // 填充表格内容
            sortedData.forEach(item => {
                const row = document.createElement('tr');
                
                // 根据库存数量设置样式
                let quantityHtml = item.quantity || 0;
                if (quantityHtml <= STOCK_THRESHOLDS.urgent) {
                    quantityHtml = `<span class="stock-urgent">${quantityHtml}</span>`;
                } else if (quantityHtml <= STOCK_THRESHOLDS.low) {
                    quantityHtml = `<span class="stock-low">${quantityHtml}</span>`;
                } else if (quantityHtml <= STOCK_THRESHOLDS.medium) {
                    quantityHtml = `<span class="stock-medium">${quantityHtml}</span>`;
                } else {
                    quantityHtml = `<span class="stock-high">${quantityHtml}</span>`;
                }
                
                row.innerHTML = `
                    <td>${item.code || ''}</td>
                    <td>${item.color || '-'}</td>
                    <td>${quantityHtml}</td>
                    <td>${item.warehouse || '-'}</td>
                `;
                tbody.appendChild(row);
            });
            
        } catch (error) {
            console.error('显示完整库存表时发生错误:', error);
            message.textContent = `显示失败: ${error.message}`;
        }
    }

    // 手动刷新库存数据
    function refreshStockData() {
        if (isStockDataLoading) {
            showToast('数据正在加载中，请稍候');
            return;
        }
        
        if (isOfflineMode) {
            showQueryStatus('info', '当前离线模式', [
                '将尝试加载本地缓存数据',
                '请检查网络连接以获取最新数据'
            ]);
        } else {
            showToast('正在刷新库存数据...');
        }
        
        // 强制从服务器重新加载数据
        stockData = [];
        loadStockData(true);
    }

    // 加载库存数据
    function loadStockData(forceRefresh = false) {
        // 标记数据加载中
        isStockDataLoading = true;
        showQueryStatus('loading', '正在加载库存数据...');
        
        // 显示加载状态
        document.getElementById('last-update-time').textContent = '库存最后更新时间：加载中...';
        document.getElementById('full-last-update-time').textContent = '库存最后更新时间：加载中...';
        
        // 如果不是强制刷新，先尝试从本地缓存加载
        if (!forceRefresh) {
            const cachedStock = localStorage.getItem('cachedStockData');
            const cachedTime = localStorage.getItem('cachedStockTime');
            
            if (cachedStock) {
                try {
                    stockData = JSON.parse(cachedStock);
                    updateLastUpdateTime(cachedTime);
                    
                    // 标记加载完成
                    isStockDataLoading = false;
                    hideQueryStatus();
                    
                    // 如果有缓存数据，更新当前显示的库存页面
                    if (currentMode === 'stock') {
                        if (currentStockTab === 'search') {
                            // 如果在查询页面且有查询内容，重新查询
                            const currentSearch = document.getElementById('stockCode').value.trim();
                            if (currentSearch) {
                                searchStock();
                            }
                        } else {
                            // 如果在完整库存表页面，显示表格
                            displayFullStockTable();
                        }
                    }
                    
                    // 如果是离线模式，提示使用缓存
                    if (isOfflineMode) {
                        showQueryStatus('info', '使用本地缓存数据', [
                            '数据可能不是最新的',
                            '联网后可点击"刷新库存数据"获取更新'
                        ]);
                    }
                    return; // 成功加载缓存后直接返回
                } catch (e) {
                    console.error('解析缓存的库存数据失败', e);
                    stockData = [];
                    showQueryStatus('error', '缓存数据损坏', [
                        '将尝试重新加载数据',
                        '请确保网络连接正常'
                    ]);
                }
            }
        }

        // 如果在线，尝试从Firebase加载最新数据
        if (!isOfflineMode) {
            firebase.get(firebase.stockRef).then((snapshot) => {
                // 标记加载完成
                isStockDataLoading = false;
                
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    if (data && data.stockData) {
                        // 只有当数据不同时才更新
                        const newDataStr = JSON.stringify(data.stockData);
                        const oldDataStr = JSON.stringify(stockData);
                        
                        if (newDataStr !== oldDataStr || forceRefresh) {
                            stockData = data.stockData;
                            showToast('已获取最新库存数据');
                            
                            // 更新当前显示的库存页面
                            if (currentMode === 'stock') {
                                if (currentStockTab === 'search') {
                                    // 如果在查询页面且有查询内容，重新查询
                                    const currentSearch = document.getElementById('stockCode').value.trim();
                                    if (currentSearch) {
                                        searchStock();
                                    }
                                } else {
                                    // 如果在完整库存表页面，显示表格
                                    displayFullStockTable();
                                }
                            }
                        } else {
                            showToast('库存数据已是最新');
                        }
                        
                        updateLastUpdateTime(data.updateTime);
                        
                        // 缓存到本地
                        localStorage.setItem('cachedStockData', newDataStr);
                        localStorage.setItem('cachedStockTime', data.updateTime);
                        
                        hideQueryStatus();
                    } else {
                        showToast('库存数据格式不正确');
                        document.getElementById('last-update-time').textContent = '库存最后更新时间：数据格式错误';
                        document.getElementById('full-last-update-time').textContent = '库存最后更新时间：数据格式错误';
                        showQueryStatus('error', '库存数据格式错误', [
                            '请联系管理员重新上传数据',
                            '确认上传的Excel文件符合格式要求'
                        ]);
                    }
                } else {
                    showToast('尚未有库存数据，请管理员上传');
                    document.getElementById('last-update-time').textContent = '库存最后更新时间：暂无数据';
                    document.getElementById('full-last-update-time').textContent = '库存最后更新时间：暂无数据';
                    showQueryStatus('info', '暂无库存数据', [
                        '请联系管理员上传库存Excel文件',
                        '文件需按指定格式准备（B列=编号，C列=色号，J列=库存）'
                    ]);
                }
            }).catch((error) => {
                console.error('加载库存数据失败', error);
                isStockDataLoading = false; // 标记加载完成
                showToast('加载库存数据失败，请稍后重试');
                document.getElementById('last-update-time').textContent = '库存最后更新时间：加载失败';
                document.getElementById('full-last-update-time').textContent = '库存最后更新时间：加载失败';
                showQueryStatus('error', '加载数据失败', [
                    '检查网络连接是否正常',
                    '尝试点击"刷新库存数据"重新加载',
                    '如果问题持续，请联系系统管理员'
                ]);
            });
        } else {
            // 离线且无缓存数据的情况
            isStockDataLoading = false;
            showQueryStatus('error', '无可用数据', [
                '当前处于离线状态',
                '没有找到缓存的库存数据',
                '请联网后刷新数据'
            ]);
            document.getElementById('last-update-time').textContent = '库存最后更新时间：无数据';
            document.getElementById('full-last-update-time').textContent = '库存最后更新时间：无数据';
        }
    }

    // 更新最后更新时间显示
    function updateLastUpdateTime(timeString) {
        if (timeString) {
            document.getElementById('last-update-time').textContent = `库存最后更新时间：${timeString}`;
            document.getElementById('full-last-update-time').textContent = `库存最后更新时间：${timeString}`;
        } else {
            document.getElementById('last-update-time').textContent = '库存最后更新时间：从未更新';
            document.getElementById('full-last-update-time').textContent = '库存最后更新时间：从未更新';
        }
    }

    // 切换模式
    function switchMode(mode) {
        currentMode = mode;
        
        // 隐藏所有模式内容
        document.querySelectorAll('.mode-content').forEach(el => {
            el.classList.remove('active');
        });
        // 移除所有模式按钮的激活状态
        document.querySelectorAll('.mode-selector button').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // 显示选中的模式
        document.getElementById(`${mode}-content`).classList.add('active');
        document.getElementById(`${mode}-mode`).classList.add('active');
        
        // 控制公共内容区域显示
        const commonContent = document.querySelector('.common-content');
        if (mode === 'stock') {
            commonContent.style.display = 'none';
            // 切换到库存页面时，确保数据已加载
            if (stockData.length === 0 && !isStockDataLoading) {
                loadStockData();
            } else if (currentStockTab === 'full') {
                // 如果当前是完整库存表选项卡，显示表格
                displayFullStockTable();
            }
        } else {
            commonContent.style.display = 'block';
        }
        
        // 保存当前模式
        localStorage.setItem('currentMode', mode);
    }

    // 处理规格选择变化
    function handleSizeChange() {
        const sizeSelect = document.getElementById('size');
        const customSizeInput = document.getElementById('customSize');
        
        if (sizeSelect.value === 'custom') {
            customSizeInput.style.display = 'block';
        } else {
            customSizeInput.style.display = 'none';
        }
    }

    // 添加瓷砖到列表
    function addTile() {
        const code = document.getElementById('code').value.trim();
        const sizeSelect = document.getElementById('size');
        let size = sizeSelect.value === 'custom' 
            ? document.getElementById('customSize').value.trim() 
            : sizeSelect.value;
        const quantity = document.getElementById('quantity').value.trim();
        const color = document.getElementById('color').value.trim();
        
        // 验证必填字段
        if (!code) {
            showToast('请输入瓷砖编号');
            return;
        }
        if (!size) {
            showToast('请选择或输入规格');
            return;
        }
        if (!quantity || isNaN(quantity) || parseInt(quantity) <= 0) {
            showToast('请输入有效的数量');
            return;
        }
        
        // 添加到列表
        tileIndex++;
        const tile = {
            id: tileIndex,
            code,
            size,
            quantity: parseInt(quantity),
            color
        };
        
        tiles.push(tile);
        renderTilesList();
        
        // 保存数据
        saveData();
        
        // 清空输入框
        document.getElementById('code').value = '';
        document.getElementById('quantity').value = '';
        document.getElementById('color').value = '';
        document.getElementById('code').focus();
        
        showToast('已添加到列表');
    }

    // 渲染瓷砖列表
    function renderTilesList() {
        const tilesListElement = document.getElementById('tiles-list');
        
        if (tiles.length === 0) {
            tilesListElement.innerHTML = '尚未添加瓷砖';
            return;
        }
        
        let html = '';
        tiles.forEach(tile => {
            html += `
                <div class="tile-item" data-id="${tile.id}">
                    <strong>${tile.code}</strong> ${tile.size} ${tile.color ? `(${tile.color})` : ''} 
                    数量: ${tile.quantity}箱
                    <button class="gray" style="width: auto; padding: 3px 8px; font-size: 12px; float: right;" 
                            onclick="removeTile(${tile.id})">删除</button>
                </div>
            `;
        });
        
        tilesListElement.innerHTML = html;
    }

    // 从列表中移除瓷砖
    function removeTile(id) {
        tiles = tiles.filter(tile => tile.id !== id);
        renderTilesList();
        saveData();
        showToast('已从列表中移除');
    }

    // 清空所有瓷砖（确保此函数能被正确调用）
    function clearAll() {
        try {
            if (tiles.length === 0) {
                showToast('列表已为空');
                return;
            }
            
            if (confirm('确定要清空所有瓷砖吗？')) {
                // 清空瓷砖数组
                tiles = [];
                // 重新渲染列表
                renderTilesList();
                // 保存清空状态
                saveData();
                // 显示成功提示
                showToast('已清空所有瓷砖');
            }
        } catch (error) {
            console.error('清空操作失败:', error);
            showToast('清空失败，请重试');
        }
    }

    // 生成计划
    function generatePlan() {
        if (tiles.length === 0) {
            showToast('请先添加瓷砖信息');
            return;
        }

        let result = '';
        const date = document.getElementById('date').textContent;

        if (currentMode === 'outbound') {
            // 出货计划模板（缅甸语+中文）
            const unit = document.getElementById('unit').value || '未填写';
            const customer = document.getElementById('customer').value || '未填写';
            const paymentStatus = document.getElementById('payment').value === 'yes' ? '已付款' : '未付款';
            
            result += `单位或车牌：${unit}\n`;
            result += `日期：${date}\n`;
            result += `客户：${customer}，${paymentStatus}。\n\n`;
            
            tiles.forEach((tile, index) => {
                result += `${index + 1}.ကုဒ်နိပတ်/编号：${tile.code}\n`;
                result += `   အလျားအနံ/规格：${tile.size}\n`;
                result += `   အရောင်ကုဒ်色号：${tile.color || '无'}\n`;
                result += `   အရေအတွက်/数量：${tile.quantity}箱\n\n`;
            });
        } else if (currentMode === 'inbound') {
            // 海运入库模板（移除了柜号、入库仓库和日期的缅甸语前缀）
            const containerNo = document.getElementById('containerNo').value || '未填写';
            const warehouse = document.getElementById('warehouse').value || '未填写';
            
            result += `柜号：${containerNo}\n`;
            result += `入库仓库：${warehouse}\n`;
            result += `日期：${date}\n\n`;
            
            tiles.forEach((tile, index) => {
                result += `${index + 1}.ကုဒ်နိပတ်/编号：${tile.code}\n`;
                result += `   အလျားအနံ/规格：${tile.size}\n`;
                result += `   အရောင်ကုဒ်色号：${tile.color || '无'}\n`;
                result += `   အရေအတွက်/数量：${tile.quantity}箱\n\n`;
            });
        }

        document.getElementById('result').textContent = result;
        showToast('计划生成成功');
    }

    // 复制计划结果
    function copyResult() {
        const resultElement = document.getElementById('result');
        const result = resultElement.textContent;
        const copyButton = document.getElementById('copyButton');
        
        if (!result) {
            showToast('没有可复制的内容');
            return;
        }
        
        // 重置按钮状态
        copyButton.classList.remove('copied');
        
        // 方法1：尝试使用现代剪贴板API
        if (navigator.clipboard) {
            navigator.clipboard.writeText(result).then(() => {
                confirmCopySuccess(copyButton);
            }).catch(err => {
                console.log('剪贴板API失败，尝试备选方法', err);
                fallbackCopyMethod(resultElement, copyButton);
            });
        } else {
            // 直接使用备选方法
            fallbackCopyMethod(resultElement, copyButton);
        }
    }
    
    // 复制库存查询结果（按指定格式）
    function copyStockResults() {
        const table = document.getElementById('stock-result-table');
        const copyButton = document.getElementById('stockCopyButton');
        
        // 重置按钮状态
        copyButton.classList.remove('copied');
        
        // 检查是否有查询结果
        if (table.style.display !== 'table') {
            showToast('请先查询库存数据');
            return;
        }
        
        // 获取表格中的所有行
        const rows = table.querySelectorAll('tbody tr');
        if (rows.length === 0) {
            showToast('没有可复制的查询结果');
            return;
        }
        
        // 构建复制内容
        let copyContent = '';
        rows.forEach((row, index) => {
            // 如果是多条记录，添加分隔符
            if (index > 0) {
                copyContent += '\n--------------------\n';
            }
            
            // 获取每行的数据
            const cells = row.querySelectorAll('td');
            if (cells.length >= 4) {
                // 提取纯文本内容（去除HTML标签）
                const code = cells[0].textContent.trim();
                const color = cells[1].textContent.trim() || '无';
                const quantity = cells[2].textContent.trim();
                const warehouse = cells[3].textContent.trim() || '未指定';
                
                // 按指定格式拼接
                copyContent += `编号：${code}\n`;
                copyContent += `色号：${color}\n`;
                copyContent += `数量：${quantity}箱\n`;
                copyContent += `所在仓库：${warehouse}\n`;
            }
        });
        
        // 复制到剪贴板
        if (navigator.clipboard) {
            navigator.clipboard.writeText(copyContent).then(() => {
                confirmCopySuccess(copyButton);
                showToast(`已复制 ${rows.length} 条记录`);
            }).catch(err => {
                console.log('剪贴板API失败，尝试备选方法', err);
                // 创建临时元素用于复制
                const tempElement = document.createElement('textarea');
                tempElement.value = copyContent;
                document.body.appendChild(tempElement);
                tempElement.select();
                document.execCommand('copy');
                document.body.removeChild(tempElement);
                
                confirmCopySuccess(copyButton);
                showToast(`已复制 ${rows.length} 条记录`);
            });
        }
    }
    
    // 备选复制方法（兼容旧浏览器）
    function fallbackCopyMethod(element, button) {
        // 选中内容
        const range = document.createRange();
        range.selectNode(element);
        const selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(range);
        
        try {
            // 尝试执行复制命令
            const successful = document.execCommand('copy');
            if (successful) {
                confirmCopySuccess(button);
            } else {
                throw new Error('复制命令执行失败');
            }
        } catch (err) {
            console.error('所有复制方法都失败了', err);
            showToast('复制失败，请手动复制 (Ctrl+C)');
        } finally {
            // 清除选中状态
            selection.removeAllRanges();
        }
    }
    
    // 确认复制成功并提供视觉反馈
    function confirmCopySuccess(button) {
        // 添加成功样式
        button.classList.add('copied');
        
        // 3秒后移除成功样式
        setTimeout(() => {
            button.classList.remove('copied');
        }, 3000);
    }

    // 搜索库存
    function searchStock() {
        // 重置所有状态
        const queryStatus = document.getElementById('queryStatus');
        const table = document.getElementById('stock-result-table');
        const tbody = document.getElementById('stock-result-body');
        const message = document.getElementById('stock-result-message');
        const searchCode = document.getElementById('stockCode').value.trim().toLowerCase();
        
        // 清空之前的结果
        table.style.display = 'none';
        tbody.innerHTML = '';
        message.textContent = '';
        
        // 显示查询中状态
        showQueryStatus('loading', `正在查询包含"${searchCode}"的库存...`);
        
        // 1. 验证查询条件
        if (!searchCode) {
            showQueryStatus('error', '查询条件为空', [
                '请在输入框中填写瓷砖编号关键词',
                '支持模糊查询，只需输入部分编号即可'
            ]);
            return;
        }
        
        // 2. 检查数据加载状态
        if (isStockDataLoading) {
            showQueryStatus('info', '数据正在加载中', [
                '请稍候片刻再尝试查询',
                '等待库存数据加载完成'
            ]);
            return;
        }
        
        // 3. 检查是否有库存数据
        if (stockData.length === 0) {
            showQueryStatus('error', '无库存数据可查询', [
                '请确认管理员已上传库存数据',
                '点击"刷新库存数据"按钮尝试重新加载',
                '检查网络连接是否正常'
            ]);
            return;
        }
        
        try {
            // 4. 验证库存数据格式
            if (!Array.isArray(stockData)) {
                throw new Error('库存数据格式错误，不是有效的数组');
            }
            
            // 5. 执行查询逻辑
            const matchedItems = stockData.filter(item => {
                // 确保item是对象且包含code属性
                if (typeof item !== 'object' || item === null || !item.code) {
                    return false;
                }
                // 执行模糊匹配
                return item.code.toString().toLowerCase().includes(searchCode);
            });
            
            // 6. 处理查询结果
            if (matchedItems.length === 0) {
                hideQueryStatus();
                message.textContent = `未找到包含"${searchCode}"的瓷砖`;
                showToast('未找到匹配的瓷砖');
                
                // 提供进一步排查建议
                if (searchCode.length < 2) {
                    showQueryStatus('info', '查询结果为空', [
                        '尝试输入更长的编号片段',
                        '检查输入的编号是否正确',
                        '确认库存中是否存在该编号'
                    ]);
                }
                return;
            }
            
            // 7. 显示查询成功结果
            hideQueryStatus();
            table.style.display = 'table';
            message.textContent = '';
            
            // 填充表格内容
            matchedItems.forEach(item => {
                const row = document.createElement('tr');
                
                // 高亮显示匹配的文本
                let codeHtml = item.code || '';
                const index = codeHtml.toLowerCase().indexOf(searchCode);
                if (index !== -1) {
                    const before = codeHtml.substring(0, index);
                    const match = codeHtml.substring(index, index + searchCode.length);
                    const after = codeHtml.substring(index + searchCode.length);
                    codeHtml = `${before}<span class="search-highlight">${match}</span>${after}`;
                }
                
                // 根据库存数量设置样式
                let quantityHtml = item.quantity || 0;
                if (quantityHtml <= STOCK_THRESHOLDS.urgent) {
                    quantityHtml = `<span class="stock-urgent">${quantityHtml}</span>`;
                } else if (quantityHtml <= STOCK_THRESHOLDS.low) {
                    quantityHtml = `<span class="stock-low">${quantityHtml}</span>`;
                } else if (quantityHtml <= STOCK_THRESHOLDS.medium) {
                    quantityHtml = `<span class="stock-medium">${quantityHtml}</span>`;
                } else {
                    quantityHtml = `<span class="stock-high">${quantityHtml}</span>`;
                }
                
                row.innerHTML = `
                    <td>${codeHtml}</td>
                    <td>${item.color || '-'}</td>
                    <td>${quantityHtml}</td>
                    <td>${item.warehouse || '-'}</td>
                `;
                tbody.appendChild(row);
            });
            
            showToast(`找到 ${matchedItems.length} 条匹配结果`);
            
        } catch (error) {
            // 8. 处理查询过程中的错误
            console.error('查询库存时发生错误:', error);
            showQueryStatus('error', '查询过程中发生错误', [
                `错误详情: ${error.message}`,
                '请尝试刷新页面后重新查询',
                '如果问题持续，请联系管理员'
            ]);
            message.textContent = '查询失败，请参考上方提示解决';
        }
    }

    // 显示查询状态提示
    function showQueryStatus(type, message, troubleshooting = []) {
        const statusElement = document.getElementById('queryStatus');
        
        // 清除所有状态类
        statusElement.className = 'query-status';
        
        // 添加当前状态类
        statusElement.classList.add(`status-${type}`);
        
        // 构建状态HTML
        let html = `<strong>${message}</strong>`;
        
        // 添加排查步骤（如果有）
        if (troubleshooting && troubleshooting.length > 0) {
            html += '<div class="troubleshoot"><strong>排查建议：</strong><ul>';
            troubleshooting.forEach(step => {
                html += `<li>${step}</li>`;
            });
            html += '</ul></div>';
        }
        
        statusElement.innerHTML = html;
    }

    // 隐藏查询状态提示
    function hideQueryStatus() {
        const statusElement = document.getElementById('queryStatus');
        statusElement.className = 'query-status';
        statusElement.innerHTML = '';
    }

    // 管理员认证
    function authenticateAdmin() {
        const password = document.getElementById('adminPassword').value;
        const errorElement = document.getElementById('adminError');
        
        if (!password) {
            errorElement.textContent = '请输入密码';
            errorElement.style.display = 'block';
            return;
        }
        
        if (password === ADMIN_PASSWORD) {
            // 登录成功
            isAdmin = true;
            document.getElementById('adminSection').style.display = 'block';
            document.getElementById('adminPassword').value = '';
            errorElement.style.display = 'none';
            showToast('管理员登录成功');
        } else {
            // 密码错误
            errorElement.textContent = '密码错误';
            errorElement.style.display = 'block';
        }
    }

    // 退出管理员模式
    function logoutAdmin() {
        isAdmin = false;
        document.getElementById('adminSection').style.display = 'none';
        showToast('已退出管理员模式');
    }

    // 处理管理员上传的Excel文件
    function handleAdminFileUpload(event) {
        if (!isAdmin) {
            showToast('请先以管理员身份登录');
            return;
        }
        
        if (isOfflineMode) {
            showToast('当前离线，无法更新库存数据');
            return;
        }
        
        const file = event.target.files[0];
        if (!file) return;
        
        const syncStatus = document.getElementById('syncStatus');
        syncStatus.textContent = '正在解析文件...';
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                
                // 获取所有单元格
                const range = XLSX.utils.decode_range(worksheet['!ref'] || 'A1:A1');
                const stockData = [];
                let validRowCount = 0;
                let invalidRowCount = 0;
                
                // 从第二行开始读取（跳过表头）
                for (let row = range.s.r + 1; row <= range.e.r; row++) {
                    try {
                        // 按指定列读取数据（B列=1, C列=2, J列=9，Excel列从0开始计数）
                        const codeCell = worksheet[XLSX.utils.encode_cell({ r: row, c: 1 })]; // B列
                        const colorCell = worksheet[XLSX.utils.encode_cell({ r: row, c: 2 })]; // C列
                        const quantityCell = worksheet[XLSX.utils.encode_cell({ r: row, c: 9 })]; // J列
                        
                        // 获取单元格值
                        const code = codeCell ? (codeCell.v || '').toString().trim() : '';
                        const color = colorCell ? (colorCell.v || '').toString().trim() : '';
                        const quantity = quantityCell ? Number(quantityCell.v) : 0;
                        
                        // 验证必要数据
                        if (!code || isNaN(quantity) || quantity < 0) {
                            invalidRowCount++;
                            continue; // 跳过无效行
                        }
                        
                        // 添加到库存数据
                        stockData.push({
                            code,
                            color,
                            quantity,
                            warehouse: '1号仓库'
                        });
                        
                        validRowCount++;
                    } catch (rowError) {
                        invalidRowCount++;
                        console.error(`处理行 ${row + 1} 时出错:`, rowError);
                    }
                }
                
                // 检查是否有有效数据
                if (validRowCount === 0) {
                    syncStatus.textContent = `未找到有效数据，共跳过 ${invalidRowCount} 行`;
                    showToast('未找到有效数据，请检查文件格式');
                    return;
                }
                
                syncStatus.textContent = `解析完成：有效数据 ${validRowCount} 行，正在同步到服务器...`;
                
                // 准备要保存的数据（包含时间戳）
                const saveData = {
                    stockData: stockData,
                    updateTime: new Date().toLocaleString()
                };
                
                // 保存到Firebase
                firebase.set(firebase.stockRef, saveData).then(() => {
                    syncStatus.textContent = `库存数据已成功更新，共导入 ${validRowCount} 条记录`;
                    showToast(`库存数据更新成功，导入 ${validRowCount} 条记录`);
                    
                    // 更新本地缓存
                    localStorage.setItem('cachedStockData', JSON.stringify(stockData));
                    localStorage.setItem('cachedStockTime', saveData.updateTime);
                    
                    // 更新当前内存中的库存数据
                    window.stockData = stockData;
                    
                    // 如果在库存管理页面，刷新显示
                    if (currentMode === 'stock') {
                        if (currentStockTab === 'search') {
                            // 如果在查询页面且有查询内容，重新查询
                            const currentSearch = document.getElementById('stockCode').value.trim();
                            if (currentSearch) {
                                searchStock();
                            }
                        } else {
                            // 如果在完整库存表页面，刷新表格
                            displayFullStockTable();
                        }
                    }
                    
                    // 重置文件输入
                    document.getElementById('adminFileInput').value = '';
                }).catch((error) => {
                    console.error('更新库存数据失败', error);
                    syncStatus.textContent = '更新失败，请重试';
                    showToast('更新库存数据失败');
                });
                
            } catch (error) {
                console.error('解析Excel文件失败', error);
                syncStatus.textContent = `文件解析失败: ${error.message}`;
                showToast('文件解析失败');
            }
        };
        
        reader.readAsArrayBuffer(file);
    }

    // 保存数据到本地存储
    function saveData() {
        const saveData = {
            tiles,
            tileIndex,
            customer: document.getElementById('customer').value,
            payment: document.getElementById('payment').value,
            unit: document.getElementById('unit').value,
            containerNo: document.getElementById('containerNo').value,
            warehouse: document.getElementById('warehouse').value,
            currentMode
        };
        
        localStorage.setItem('tileManagementData', JSON.stringify(saveData));
    }

    // 从本地存储恢复数据
    function restoreSavedData() {
        const savedData = localStorage.getItem('tileManagementData');
        
        if (savedData) {
            try {
                const data = JSON.parse(savedData);
                
                // 恢复瓷砖列表
                if (data.tiles && Array.isArray(data.tiles)) {
                    tiles = data.tiles;
                    renderTilesList();
                }
                
                // 恢复其他数据
                if (data.tileIndex) tileIndex = data.tileIndex;
                if (data.customer) document.getElementById('customer').value = data.customer;
                if (data.payment) document.getElementById('payment').value = data.payment;
                if (data.unit) document.getElementById('unit').value = data.unit;
                if (data.containerNo) document.getElementById('containerNo').value = data.containerNo;
                if (data.warehouse) document.getElementById('warehouse').value = data.warehouse;
                
                // 恢复模式
                if (data.currentMode) {
                    switchMode(data.currentMode);
                }
                
            } catch (e) {
                console.error('恢复保存的数据失败', e);
            }
        }
    }

    // 显示提示信息
    function showToast(message) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.style.display = 'block';
        
        setTimeout(() => {
            toast.style.display = 'none';
        }, 3000);
    }
</script>
</body>
</html>
