<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç“·ç –å‡ºå…¥åº“ç®¡ç†ç³»ç»Ÿ</title>
    <!-- å¼•å…¥SheetJSåº“ç”¨äºå¤„ç†Excelæ–‡ä»¶ -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- å¼•å…¥Firebaseç”¨äºåç«¯å­˜å‚¨ -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js"></script>
    <style>
        /* åŸæœ‰æ ·å¼ä¿æŒä¸å˜ */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
        body { padding: 15px; background-color: #f5f5f5; }
        .container { max-width: 500px; margin: 0 auto; }
        .card { background: white; padding: 15px; margin-bottom: 15px; border-radius: 8px; box-shadow: 0 1px 3px #eee; }
        h1, h2 { margin-bottom: 15px; color: #333; }
        h1 { text-align: center; color: #4F46E5; font-size: 20px; padding: 10px 0; }
        .form-group { margin-bottom: 12px; }
        label { display: block; margin-bottom: 5px; font-size: 14px; color: #666; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 15px; }
        button { background-color: #4F46E5; color: white; border: none; padding: 12px; border-radius: 4px; width: 100%; font-size: 16px; margin-top: 5px; cursor: pointer; transition: background-color 0.3s; }
        button:hover { opacity: 0.9; }
        button.secondary { background-color: #10B981; }
        button.gray { background-color: #f0f0f0; color: #666; }
        button.admin { background-color: #f59e0b; }
        .flex-row { display: flex; gap: 10px; }
        .flex-row button { flex: 1; }
        #tiles-list { margin: 10px 0; padding: 10px; border: 1px dashed #ddd; min-height: 60px; }
        .tile-item { padding: 8px; background: #f9f9f9; margin-bottom: 5px; border-radius: 4px; }
        #result { margin: 10px 0; padding: 10px; background: #f9f9f9; border-radius: 4px; white-space: pre-wrap; font-size: 14px; }
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); color: white; padding: 10px 15px; border-radius: 4px; display: none; z-index: 1000; }
        .mode-selector { display: flex; margin-bottom: 15px; flex-wrap: wrap; }
        .mode-selector button { flex: 1; margin: 0; min-width: 120px; }
        .mode-selector button.active { background-color: #4F46E5; color: white; }
        .mode-selector button:not(.active) { background-color: #f0f0f0; color: #666; }
        .mode-content { display: none; }
        .mode-content.active { display: block; }
        .stock-item { padding: 10px; border-bottom: 1px solid #eee; }
        .stock-item:last-child { border-bottom: none; }
        .common-content { display: block; }
        .stock-mode .common-content { display: none; }
        
        /* å¯¼å…¥åŒºåŸŸæ ·å¼ */
        .import-area {
            border: 2px dashed #ccc;
            border-radius: 6px;
            padding: 20px;
            text-align: center;
            margin-bottom: 15px;
            cursor: pointer;
            transition: border-color 0.3s;
        }
        .import-area:hover {
            border-color: #4F46E5;
        }
        .import-icon {
            font-size: 24px;
            color: #4F46E5;
            margin-bottom: 10px;
        }
        #file-input {
            display: none;
        }
        .last-update {
            font-size: 13px;
            color: #666;
            margin-top: 10px;
            text-align: right;
        }
        .github-footer {
            text-align: center;
            font-size: 12px;
            color: #666;
            margin-top: 20px;
            padding: 10px;
        }
        .admin-section {
            margin: 15px 0;
            padding: 10px;
            background-color: #fff3cd;
            border-radius: 4px;
            display: none;
        }
        .auth-section {
            margin-bottom: 15px;
        }
        .error-message {
            color: #dc2626;
            font-size: 13px;
            margin-top: 5px;
            display: none;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>ç“·ç –å‡ºå…¥åº“ç®¡ç†ç³»ç»Ÿ</h1>
    
    <!-- ç®¡ç†å‘˜è®¤è¯åŒºåŸŸ -->
    <div class="card auth-section">
        <div class="form-group">
            <label>ç®¡ç†å‘˜å¯†ç </label>
            <input type="password" id="adminPassword" placeholder="è¾“å…¥ç®¡ç†å‘˜å¯†ç ">
            <div class="error-message" id="adminError"></div>
        </div>
        <button class="admin" id="adminLoginBtn">ç®¡ç†å‘˜ç™»å½•</button>
    </div>
    
    <!-- ç®¡ç†å‘˜åŠŸèƒ½åŒºåŸŸï¼ˆé»˜è®¤éšè—ï¼‰ -->
    <div class="card admin-section" id="adminSection">
        <h2>ç®¡ç†å‘˜åŠŸèƒ½</h2>
        <div class="import-area" onclick="document.getElementById('adminFileInput').click()">
            <div class="import-icon">ğŸ“‚</div>
            <p>ç‚¹å‡»æˆ–æ‹–æ‹½Excelæ–‡ä»¶åˆ°æ­¤å¤„æ›´æ–°å…¬å…±åº“å­˜æ•°æ®</p>
            <p style="font-size: 12px; color: #666; margin-top: 5px;">æ”¯æŒ .xlsx å’Œ .xls æ ¼å¼</p>
            <input type="file" id="adminFileInput" accept=".xlsx,.xls" onchange="handleAdminFileUpload(event)">
        </div>
        <button class="gray" onclick="logoutAdmin()">é€€å‡ºç®¡ç†å‘˜æ¨¡å¼</button>
    </div>

    <div class="mode-selector">
        <button id="outbound-mode" class="active" onclick="switchMode('outbound')">å‡ºè´§è®¡åˆ’</button>
        <button id="inbound-mode" onclick="switchMode('inbound')">æµ·è¿å…¥åº“</button>
        <button id="stock-mode" onclick="switchMode('stock')">åº“å­˜æŸ¥è¯¢</button>
    </div>
    <div class="card"><div id="date"></div></div>

    <div id="outbound-content" class="mode-content active">
        <div class="card">
            <h2>è®¢å•ä¿¡æ¯</h2>
            <div class="form-group"><label>å®¢æˆ· (å¯é€‰)</label><input type="text" id="customer" oninput="saveData()"></div>
            <div class="form-group">
                <label>æ˜¯å¦ä»˜æ¬¾</label>
                <select id="payment" onchange="saveData()">
                    <option value="">è¯·é€‰æ‹©</option>
                    <option value="yes">æ˜¯</option>
                    <option value="no">å¦</option>
                </select>
            </div>
            <div class="form-group"><label>å•ä½æˆ–è½¦ç‰Œ</label><input type="text" id="unit" oninput="saveData()"></div>
        </div>
    </div>

    <div id="inbound-content" class="mode-content">
        <div class="card">
            <h2>å…¥åº“ä¿¡æ¯</h2>
            <div class="form-group"><label>æŸœå· *</label><input type="text" id="containerNo" oninput="saveData()"></div>
            <div class="form-group">
                <label>å…¥åº“ä»“åº“ *</label>
                <select id="warehouse" onchange="saveData()">
                    <option value="">è¯·é€‰æ‹©</option>
                    <option value="1å·ä»“åº“">1å·ä»“åº“</option>
                    <option value="k38ä»“åº“">k38ä»“åº“</option>
                    <option value="k39ä»“åº“">k39ä»“åº“</option>
                </select>
            </div>
        </div>
    </div>

    <div id="stock-content" class="mode-content">
        <div class="card">
            <h2>åº“å­˜æŸ¥è¯¢</h2>
            <div class="form-group">
                <label>ç“·ç –ç¼–å· (æ”¯æŒæ¨¡ç³ŠæŸ¥è¯¢)</label>
                <input type="text" id="stockCode" placeholder="è¾“å…¥ç¼–å·å…³é”®è¯">
            </div>
            <button onclick="searchStock()">æŸ¥è¯¢åº“å­˜</button>
            
            <div class="last-update" id="last-update-time">
                åº“å­˜æœ€åæ›´æ–°æ—¶é—´ï¼šåŠ è½½ä¸­...
            </div>
        </div>
        
        <div class="card">
            <h2>æŸ¥è¯¢ç»“æœ</h2>
            <div id="stock-result">è¯·è¾“å…¥ç¼–å·å¹¶ç‚¹å‡»æŸ¥è¯¢</div>
        </div>
    </div>

    <!-- å…¬å…±å†…å®¹åŒºåŸŸ -->
    <div class="common-content">
        <div class="card">
            <h2>ç“·ç –ä¿¡æ¯</h2>
            <div class="form-group"><label>ç¼–å· *</label><input type="text" id="code"></div>
            <div class="form-group">
                <label>è§„æ ¼ *</label>
                <select id="size" onchange="handleSizeChange()">
                    <option value="">è¯·é€‰æ‹©</option>
                    <option value="300*300">300*300</option>
                    <option value="300*600">300*600</option>
                    <option value="400*400">400*400</option>
                    <option value="400*800">400*800</option>
                    <option value="470*1200">470*1200</option>
                    <option value="470*1350">470*1350</option>
                    <option value="600*600">600*600</option>
                    <option value="600*1200">600*1200</option>
                    <option value="750*1500">750*1500</option>
                    <option value="800*800">800*800</option>
                    <option value="200*1200">200*1200</option>
                    <option value="custom">è‡ªå®šä¹‰</option>
                </select>
                <input type="text" id="customSize" placeholder="è¯·è¾“å…¥è‡ªå®šä¹‰è§„æ ¼" style="margin-top:5px; display:none;" oninput="saveData()">
            </div>
            <div class="form-group"><label>æ•°é‡ *</label><input type="text" id="quantity" oninput="this.value=this.value.replace(/\D/g,''); saveData();"></div>
            <div class="form-group"><label>è‰²å· (å¯é€‰)</label><input type="text" id="color"></div>
            <button onclick="addTile()">æ·»åŠ åˆ°åˆ—è¡¨</button>
        </div>

        <div class="card">
            <h2>å·²æ·»åŠ çš„ç“·ç –</h2>
            <div id="tiles-list">å°šæœªæ·»åŠ ç“·ç –</div>
            <div class="flex-row">
                <button class="gray" onclick="clearAll()">æ¸…ç©º</button>
                <button class="secondary" onclick="generatePlan()">ç”Ÿæˆè®¡åˆ’</button>
            </div>
        </div>

        <div class="card">
            <h2>è®¡åˆ’ç»“æœ</h2>
            <div id="result"></div>
            <button onclick="copyResult()">å¤åˆ¶å†…å®¹</button>
        </div>
    </div>
    
    <div class="github-footer">
        ç“·ç –å‡ºå…¥åº“ç®¡ç†ç³»ç»Ÿ &copy; 2023
    </div>
</div>
<div class="toast" id="toast"></div>

<script>
    // å…¨å±€é”™è¯¯å¤„ç†
    window.addEventListener('error', function(error) {
        console.error('å…¨å±€é”™è¯¯æ•è·:', error);
        showToast('ç³»ç»Ÿå‘ç”Ÿé”™è¯¯: ' + error.message);
    });

    // Firebaseé…ç½®
    const firebaseConfig = {
        apiKey: "AIzaSyC65DEOgj4WeksRRVmw4ZTrNkCB83SoQpI",
        authDomain: "tile-management-system-f5db8.firebaseapp.com",
        databaseURL: "https://tile-management-system-f5db8-default-rtdb.firebaseio.com",
        projectId: "tile-management-system-f5db8",
        storageBucket: "tile-management-system-f5db8.appspot.com",
        messagingSenderId: "925027091187",
        appId: "1:925027091187:web:a2bb160b629f541abded86"
    };

    // åˆå§‹åŒ–Firebase
    let firebaseApp = null;
    let database = null;
    let stockRef = null;
    
    try {
        if (!firebase.apps.length) {
            firebaseApp = firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            stockRef = database.ref('tileStock');
        } else {
            firebaseApp = firebase.apps[0];
            database = firebase.database();
            stockRef = database.ref('tileStock');
        }
    } catch (error) {
        console.error("Firebaseåˆå§‹åŒ–é”™è¯¯:", error);
        showToast("ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•");
    }
    
    var tiles = [], tileIndex = 0, currentMode = 'outbound';
    var stockData = [];
    var isAdmin = false;
    // ç®¡ç†å‘˜å¯†ç  - è¯·åŠ¡å¿…ä¿®æ”¹ä¸ºå®‰å…¨çš„å¯†ç 
    const ADMIN_PASSWORD = "admin"; 

    // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
    window.addEventListener('DOMContentLoaded', function() {
        // æ˜¾ç¤ºå½“å‰æ—¥æœŸ
        const now = new Date();
        document.getElementById('date').textContent = 
            `${now.getFullYear()}/${(now.getMonth()+1).toString().padStart(2, '0')}/${now.getDate().toString().padStart(2, '0')}`;

        // ç»‘å®šç®¡ç†å‘˜ç™»å½•æŒ‰é’®äº‹ä»¶
        const adminLoginBtn = document.getElementById('adminLoginBtn');
        if (adminLoginBtn) {
            adminLoginBtn.addEventListener('click', authenticateAdmin);
        }

        // ä»FirebaseåŠ è½½å…¬å…±åº“å­˜æ•°æ®
        loadPublicStockData();

        // æ¢å¤æœ¬åœ°è®¡åˆ’æ•°æ®
        restoreSavedData();
    });

    // æ¢å¤ä¿å­˜çš„æ•°æ®
    function restoreSavedData() {
        try {
            const saved = localStorage.getItem('tilePlanData');
            if (saved) {
                const data = JSON.parse(saved);
                tiles = data.tiles || [];
                currentMode = data.currentMode || 'outbound';
                
                // æ¢å¤è¡¨å•æ•°æ®
                document.getElementById('customer').value = data.customer || '';
                document.getElementById('payment').value = data.payment || '';
                document.getElementById('unit').value = data.unit || '';
                document.getElementById('containerNo').value = data.containerNo || '';
                document.getElementById('warehouse').value = data.warehouse || '';
                document.getElementById('result').textContent = data.result || '';
                document.getElementById('customSize').value = data.customSize || '';
                
                updateTilesList();
                switchMode(currentMode);
                handleSizeChange();
            }
        } catch (e) {
            console.error('è§£æè®¡åˆ’æ•°æ®å¤±è´¥', e);
            // æ¸…é™¤æŸåçš„æ•°æ®
            localStorage.removeItem('tilePlanData');
        }
    }

    // ä»FirebaseåŠ è½½å…¬å…±åº“å­˜æ•°æ®
    function loadPublicStockData() {
        if (!firebaseApp) {
            return;
        }
        
        try {
            stockRef.once('value').then(snapshot => {
                const data = snapshot.val();
                if (data && data.stockData) {
                    stockData = data.stockData;
                    updateLastUpdateTime(data.updateTime);
                    showToast('åº“å­˜æ•°æ®åŠ è½½æˆåŠŸ');
                } else {
                    // ä½¿ç”¨é»˜è®¤æ•°æ®
                    stockData = [
                        { code: "TC001", color: "ç™½è‰²", warehouse: "1å·ä»“åº“", quantity: 150 },
                        { code: "TC002", color: "ç°è‰²", warehouse: "k38ä»“åº“", quantity: 80 },
                        { code: "TC003", color: "ç±³é»„", warehouse: "k39ä»“åº“", quantity: 200 }
                    ];
                    updateLastUpdateTime(null);
                    showToast('ä½¿ç”¨é»˜è®¤åº“å­˜æ•°æ®');
                }
            }).catch(error => {
                console.error('åŠ è½½åº“å­˜æ•°æ®å¤±è´¥', error);
                showToast('åº“å­˜æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            });
        } catch (error) {
            console.error('åŠ è½½åº“å­˜æ•°æ®æ—¶å‘ç”Ÿå¼‚å¸¸', error);
        }
    }

    // ç®¡ç†å‘˜è®¤è¯
    function authenticateAdmin() {
        try {
            const passwordInput = document.getElementById('adminPassword');
            const errorElement = document.getElementById('adminError');
            
            // æ¸…é™¤ä¹‹å‰çš„é”™è¯¯æç¤º
            errorElement.style.display = 'none';
            
            const password = passwordInput.value.trim();
            
            if (!password) {
                errorElement.textContent = 'è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ';
                errorElement.style.display = 'block';
                passwordInput.focus();
                return;
            }
            
            // éªŒè¯å¯†ç 
            if (password === ADMIN_PASSWORD) {
                isAdmin = true;
                const adminSection = document.getElementById('adminSection');
                if (adminSection) {
                    adminSection.style.display = 'block';
                    passwordInput.value = '';
                    showToast('ç®¡ç†å‘˜ç™»å½•æˆåŠŸ');
                } else {
                    throw new Error('æœªæ‰¾åˆ°ç®¡ç†å‘˜åŠŸèƒ½åŒºåŸŸ');
                }
            } else {
                errorElement.textContent = 'å¯†ç é”™è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥';
                errorElement.style.display = 'block';
                passwordInput.select();
            }
        } catch (error) {
            console.error('ç®¡ç†å‘˜ç™»å½•è¿‡ç¨‹å‡ºé”™:', error);
            showToast('ç™»å½•è¿‡ç¨‹å‡ºé”™: ' + error.message);
        }
    }

    // ç®¡ç†å‘˜é€€å‡º
    function logoutAdmin() {
        try {
            isAdmin = false;
            const adminSection = document.getElementById('adminSection');
            if (adminSection) {
                adminSection.style.display = 'none';
                showToast('å·²é€€å‡ºç®¡ç†å‘˜æ¨¡å¼');
            }
        } catch (error) {
            console.error('é€€å‡ºç®¡ç†å‘˜æ¨¡å¼å‡ºé”™:', error);
            showToast('é€€å‡ºè¿‡ç¨‹å‡ºé”™: ' + error.message);
        }
    }

    // ç®¡ç†å‘˜ä¸Šä¼ æ–‡ä»¶å¤„ç†
    function handleAdminFileUpload(event) {
        try {
            if (!isAdmin) {
                showToast('è¯·å…ˆä»¥ç®¡ç†å‘˜èº«ä»½ç™»å½•');
                return;
            }

            const file = event.target.files[0];
            if (!file) return;
            
            const fileExtension = file.name.split('.').pop().toLowerCase();
            if (fileExtension !== 'xlsx' && fileExtension !== 'xls') {
                showToast('è¯·ä¸Šä¼ Excelæ–‡ä»¶ï¼ˆ.xlsxæˆ–.xlsæ ¼å¼ï¼‰');
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // å¤„ç†æ‰€æœ‰å·¥ä½œè¡¨
                    const newStockData = [];
                    let totalValidCount = 0;
                    
                    // éå†æ¯ä¸ªå·¥ä½œè¡¨
                    workbook.SheetNames.forEach(warehouseName => {
                        const worksheet = workbook.Sheets[warehouseName];
                        const range = XLSX.utils.decode_range(worksheet['!ref'] || 'A1:A1');
                        
                        if (range.e.c < 9) {
                            showToast(`å·¥ä½œè¡¨ "${warehouseName}" åˆ—æ•°ä¸è¶³`);
                            return;
                        }
                        
                        let sheetValidCount = 0;
                        
                        for (let row = range.s.r + 1; row <= range.e.r; row++) {
                            const codeCell = worksheet[XLSX.utils.encode_cell({r: row, c: 1})];
                            const colorCell = worksheet[XLSX.utils.encode_cell({r: row, c: 2})];
                            const quantityCell = worksheet[XLSX.utils.encode_cell({r: row, c: 9})];
                            
                            let code = codeCell ? (codeCell.v || '').toString().trim() : '';
                            const color = colorCell ? (colorCell.v || '').toString().trim() : '';
                            const quantity = quantityCell ? parseInt(quantityCell.v || 0) : 0;
                            
                            // å»é™¤æ³°è¯­å‰ç¼€
                            code = removeThaiPrefix(code);
                            
                            if (code) {
                                newStockData.push({
                                    code: code,
                                    color: color,
                                    warehouse: warehouseName,
                                    quantity: isNaN(quantity) ? 0 : quantity
                                });
                                sheetValidCount++;
                                totalValidCount++;
                            }
                        }
                    });
                    
                    if (totalValidCount === 0) {
                        showToast('æœªæ‰¾åˆ°æœ‰æ•ˆçš„åº“å­˜æ•°æ®');
                        return;
                    }
                    
                    // ä¿å­˜åˆ°Firebase
                    const updateTime = new Date().toISOString();
                    stockRef.set({
                        stockData: newStockData,
                        updateTime: updateTime
                    }).then(() => {
                        stockData = newStockData;
                        updateLastUpdateTime(updateTime);
                        showToast(`æˆåŠŸæ›´æ–° ${totalValidCount} æ¡åº“å­˜è®°å½•`);
                        document.getElementById('adminFileInput').value = '';
                    }).catch(error => {
                        console.error('æ›´æ–°åº“å­˜å¤±è´¥', error);
                        showToast('æ›´æ–°åº“å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
                    });
                    
                } catch (error) {
                    console.error('æ–‡ä»¶å¤„ç†å¤±è´¥:', error);
                    showToast('æ–‡ä»¶å¤„ç†å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼');
                }
            };
            
            reader.readAsArrayBuffer(file);
        } catch (error) {
            console.error('æ–‡ä»¶ä¸Šä¼ å¤„ç†å‡ºé”™:', error);
            showToast('æ–‡ä»¶å¤„ç†å‡ºé”™: ' + error.message);
        }
    }
    
    // å»é™¤ç¼–å·ä¸­çš„æ³°è¯­å‰ç¼€
    function removeThaiPrefix(code) {
        if (!code) return code;
        const thaiRegex = /^[\u0E00-\u0E7F]+/;
        return code.replace(thaiRegex, '').trim();
    }
    
    // æ›´æ–°ä¸Šæ¬¡æ›´æ–°æ—¶é—´æ˜¾ç¤º
    function updateLastUpdateTime(timestamp) {
        const element = document.getElementById('last-update-time');
        if (!element) return;
        
        if (!timestamp) {
            element.textContent = 'åº“å­˜æœ€åæ›´æ–°æ—¶é—´ï¼šä»æœªæ›´æ–°';
            return;
        }
        
        const date = new Date(timestamp);
        const formattedTime = `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
        element.textContent = `åº“å­˜æœ€åæ›´æ–°æ—¶é—´ï¼š${formattedTime}`;
    }

    // åˆ‡æ¢æ¨¡å¼
    function switchMode(mode){
        currentMode = mode;
        document.getElementById('outbound-mode').classList.remove('active');
        document.getElementById('inbound-mode').classList.remove('active');
        document.getElementById('stock-mode').classList.remove('active');
        document.getElementById(mode + '-mode').classList.add('active');
        
        document.getElementById('outbound-content').classList.remove('active');
        document.getElementById('inbound-content').classList.remove('active');
        document.getElementById('stock-content').classList.remove('active');
        document.getElementById(mode + '-content').classList.add('active');
        
        // æ§åˆ¶å…¬å…±å†…å®¹åŒºåŸŸæ˜¾ç¤º
        document.body.classList.toggle('stock-mode', mode === 'stock');
        
        saveData();
    }
    
    // å¤„ç†è§„æ ¼é€‰æ‹©å˜åŒ–
    function handleSizeChange() {
        const sizeSelect = document.getElementById('size');
        const customSizeInput = document.getElementById('customSize');
        
        if (sizeSelect.value === 'custom') {
            customSizeInput.style.display = 'block';
        } else {
            customSizeInput.style.display = 'none';
        }
    }
    
    // æ·»åŠ ç“·ç –åˆ°åˆ—è¡¨
    function addTile() {
        const code = document.getElementById('code').value.trim();
        const sizeSelect = document.getElementById('size');
        const quantity = document.getElementById('quantity').value.trim();
        const color = document.getElementById('color').value.trim();
        
        // éªŒè¯å¿…å¡«å­—æ®µ
        if (!code) {
            showToast('è¯·è¾“å…¥ç“·ç –ç¼–å·');
            return;
        }
        
        if (sizeSelect.value === '' || (sizeSelect.value === 'custom' && !document.getElementById('customSize').value.trim())) {
            showToast('è¯·é€‰æ‹©æˆ–è¾“å…¥ç“·ç –è§„æ ¼');
            return;
        }
        
        if (!quantity || isNaN(quantity) || parseInt(quantity) <= 0) {
            showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°é‡');
            return;
        }
        
        // è·å–è§„æ ¼å€¼
        const size = sizeSelect.value === 'custom' 
            ? document.getElementById('customSize').value.trim() 
            : sizeSelect.value;
        
        // æ·»åŠ åˆ°åˆ—è¡¨
        tiles.push({
            id: tileIndex++,
            code: code,
            size: size,
            quantity: parseInt(quantity),
            color: color
        });
        
        // æ›´æ–°æ˜¾ç¤º
        updateTilesList();
        
        // æ¸…ç©ºè¾“å…¥
        document.getElementById('code').value = '';
        document.getElementById('quantity').value = '';
        document.getElementById('color').value = '';
        
        saveData();
        showToast('å·²æ·»åŠ åˆ°åˆ—è¡¨');
    }
    
    // æ›´æ–°ç“·ç –åˆ—è¡¨æ˜¾ç¤º
    function updateTilesList() {
        const listElement = document.getElementById('tiles-list');
        
        if (tiles.length === 0) {
            listElement.innerHTML = 'å°šæœªæ·»åŠ ç“·ç –';
            return;
        }
        
        let html = '';
        tiles.forEach(tile => {
            html += `
                <div class="tile-item">
                    <strong>${tile.code}</strong> ${tile.size} ${tile.color ? '(' + tile.color + ')' : ''}
                    <br>æ•°é‡: ${tile.quantity}
                    <button class="gray" style="width: auto; padding: 3px 8px; font-size: 12px; margin-top: 5px;" 
                            onclick="removeTile(${tile.id})">åˆ é™¤</button>
                </div>
            `;
        });
        
        listElement.innerHTML = html;
    }
    
    // ä»åˆ—è¡¨ä¸­ç§»é™¤ç“·ç –
    function removeTile(id) {
        tiles = tiles.filter(tile => tile.id !== id);
        updateTilesList();
        saveData();
        showToast('å·²ä»åˆ—è¡¨ä¸­ç§»é™¤');
    }
    
    // æ¸…ç©ºåˆ—è¡¨
    function clearAll() {
        if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å·²æ·»åŠ çš„ç“·ç –å—ï¼Ÿ')) {
            tiles = [];
            updateTilesList();
            saveData();
            showToast('å·²æ¸…ç©ºåˆ—è¡¨');
        }
    }
    
    // ç”Ÿæˆè®¡åˆ’
    function generatePlan() {
        if (tiles.length === 0) {
            showToast('è¯·å…ˆæ·»åŠ ç“·ç –');
            return;
        }
        
        let result = '';
        const now = new Date();
        const dateStr = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')}`;
        
        if (currentMode === 'outbound') {
            // å‡ºè´§è®¡åˆ’
            const customer = document.getElementById('customer').value.trim() || 'æœªæŒ‡å®šå®¢æˆ·';
            const payment = document.getElementById('payment').value === 'yes' ? 'å·²ä»˜æ¬¾' : 
                           (document.getElementById('payment').value === 'no' ? 'æœªä»˜æ¬¾' : 'æœªé€‰æ‹©');
            const unit = document.getElementById('unit').value.trim() || 'æœªæŒ‡å®š';
            
            result += `å‡ºè´§è®¡åˆ’ - ${dateStr}\n`;
            result += `å®¢æˆ·: ${customer}\n`;
            result += `ä»˜æ¬¾çŠ¶æ€: ${payment}\n`;
            result += `å•ä½/è½¦ç‰Œ: ${unit}\n\n`;
            result += `ç“·ç –æ¸…å•:\n`;
            
            tiles.forEach((tile, index) => {
                result += `${index + 1}. ${tile.code} ${tile.size} ${tile.color ? '(' + tile.color + ')' : ''} - ${tile.quantity}ç®±\n`;
                
                // æ£€æŸ¥åº“å­˜
                const stockItems = stockData.filter(item => 
                    item.code.toLowerCase().includes(tile.code.toLowerCase())
                );
                
                if (stockItems.length > 0) {
                    result += `   åº“å­˜: ${stockItems.reduce((sum, item) => sum + item.quantity, 0)}ç®± `;
                    result += `(åˆ†å¸ƒ: ${stockItems.map(item => `${item.warehouse}: ${item.quantity}ç®±`).join('; ')})\n`;
                } else {
                    result += `   åº“å­˜: æœªæ‰¾åˆ°è¯¥ç¼–å·çš„åº“å­˜è®°å½•\n`;
                }
            });
        } else if (currentMode === 'inbound') {
            // æµ·è¿å…¥åº“
            const containerNo = document.getElementById('containerNo').value.trim() || 'æœªæŒ‡å®š';
            const warehouse = document.getElementById('warehouse').value || 'æœªé€‰æ‹©';
            
            result += `æµ·è¿å…¥åº“è®¡åˆ’ - ${dateStr}\n`;
            result += `æŸœå·: ${containerNo}\n`;
            result += `å…¥åº“ä»“åº“: ${warehouse}\n\n`;
            result += `ç“·ç –æ¸…å•:\n`;
            
            tiles.forEach((tile, index) => {
                result += `${index + 1}. ${tile.code} ${tile.size} ${tile.color ? '(' + tile.color + ')' : ''} - ${tile.quantity}ç®±\n`;
            });
        }
        
        document.getElementById('result').textContent = result;
        showToast('è®¡åˆ’å·²ç”Ÿæˆ');
        saveData();
    }
    
    // å¤åˆ¶ç»“æœ
    function copyResult() {
        const result = document.getElementById('result').textContent;
        if (!result) {
            showToast('æ²¡æœ‰å¯å¤åˆ¶çš„å†…å®¹');
            return;
        }
        
        navigator.clipboard.writeText(result).then(() => {
            showToast('å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
        }).catch(err => {
            console.error('å¤åˆ¶å¤±è´¥:', err);
            showToast('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
        });
    }
    
    // æœç´¢åº“å­˜
    function searchStock() {
        const code = document.getElementById('stockCode').value.trim().toLowerCase();
        if (!code) {
            showToast('è¯·è¾“å…¥è¦æŸ¥è¯¢çš„ç“·ç –ç¼–å·');
            return;
        }
        
        // æ¨¡ç³Šæœç´¢
        const results = stockData.filter(item => 
            item.code.toLowerCase().includes(code)
        );
        
        const resultElement = document.getElementById('stock-result');
        
        if (results.length === 0) {
            resultElement.innerHTML = `æœªæ‰¾åˆ°åŒ…å«"${code}"çš„åº“å­˜è®°å½•`;
            return;
        }
        
        let html = '';
        results.forEach((item, index) => {
            html += `
                <div class="stock-item">
                    <strong>${item.code}</strong> ${item.color ? '(' + item.color + ')' : ''}
                    <br>ä»“åº“: ${item.warehouse}
                    <br>åº“å­˜æ•°é‡: ${item.quantity}ç®±
                </div>
            `;
        });
        
        resultElement.innerHTML = html;
    }
    
    // ä¿å­˜æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
    function saveData() {
        try {
            const data = {
                tiles: tiles,
                currentMode: currentMode,
                customer: document.getElementById('customer').value,
                payment: document.getElementById('payment').value,
                unit: document.getElementById('unit').value,
                containerNo: document.getElementById('containerNo').value,
                warehouse: document.getElementById('warehouse').value,
                result: document.getElementById('result').textContent,
                customSize: document.getElementById('customSize').value
            };
            
            localStorage.setItem('tilePlanData', JSON.stringify(data));
        } catch (e) {
            console.error('ä¿å­˜æ•°æ®å¤±è´¥', e);
            showToast('æ•°æ®ä¿å­˜å¤±è´¥');
        }
    }
    
    // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
    function showToast(message) {
        const toast = document.getElementById('toast');
        if (!toast) return;
        
        toast.textContent = message;
        toast.style.display = 'block';
        
        clearTimeout(window.toastTimeout);
        window.toastTimeout = setTimeout(() => {
            toast.style.display = 'none';
        }, 3000);
    }
</script>
</body>
</html>
