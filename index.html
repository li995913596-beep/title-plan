<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>瓷砖库存管理系统</title>
<!-- 引入Excel处理库 -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<!-- 引入Firebase -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, get } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";
    
    const firebaseConfig = {
        apiKey: "AIzaSyC65DEOgj4WeksRRVmw4ZTrNkCB83SoQpI",
        authDomain: "tile-management-system-f5db8.firebaseapp.com",
        databaseURL: "https://tile-management-system-f5db8-default-rtdb.firebaseio.com",
        projectId: "tile-management-system-f5db8",
        storageBucket: "tile-management-system-f5db8.appspot.com",
        messagingSenderId: "925027091187",
        appId: "1:925027091187:web:a2bb160b629f541abded86"
    };

    try {
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const stockRef = ref(database, 'tileStock');
        window.firebase = { app, database, ref, set, onValue, get, stockRef };
        window.firebaseInitialized = true;
    } catch (error) {
        window.firebaseInitialized = false;
        window.firebaseError = error.message;
    }
</script>
<!-- 引入ECharts用于可视化 -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
<style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
    body { padding: 15px; background-color: #f5f5f5; }
    .container { max-width: 1200px; margin: 0 auto; }
    .card { background: white; padding: 20px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    h1, h2, h3 { margin-bottom: 15px; color: #333; }
    h1 { text-align: center; color: #4F46E5; font-size: 24px; padding: 10px 0; }
    .form-group { margin-bottom: 15px; }
    label { display: block; margin-bottom: 6px; font-size: 14px; color: #666; }
    input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 15px; }
    button { background-color: #4F46E5; color: white; border: none; padding: 12px; border-radius: 4px; width: 100%; font-size: 16px; margin-top: 8px; cursor: pointer; transition: background 0.3s; }
    button:hover { background-color: #4338ca; }
    button.secondary { background-color: #10B981; }
    button.gray { background-color: #f0f0f0; color: #666; }
    button.admin { background-color: #f59e0b; }
    .flex-row { display: flex; gap: 10px; margin-bottom: 15px; }
    .flex-row button { flex: 1; }
    .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); color: white; padding: 12px 20px; border-radius: 4px; display: none; z-index: 1000; }
    .last-update { font-size: 13px; color: #666; margin-top: 10px; text-align: right; }
    .admin-section { margin: 20px 0; padding: 20px; background-color: #fff3cd; border-radius: 8px; display: none; }
    
    /* 表格样式 */
    .stock-table { width: 100%; border-collapse: collapse; margin-top: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .stock-table th { padding: 12px 15px; text-align: left; background-color: #4F46E5; color: white; font-weight: bold; }
    .stock-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
    .stock-table tr:hover { background-color: #f0f7ff; }
    .stock-table tr:nth-child(even) { background-color: #f9f9f9; }
    
    /* 库存状态样式 */
    .stock-urgent { color: white; background-color: #ef4444; padding: 2px 6px; border-radius: 3px; font-weight: bold; }
    .stock-low { color: #ef4444; font-weight: bold; }
    .stock-medium { color: #f59e0b; font-weight: bold; }
    .stock-high { color: #10B981; font-weight: bold; }
    
    /* 选项卡样式 */
    .stock-tabs { display: flex; margin-bottom: 20px; border-bottom: 1px solid #ddd; }
    .stock-tab { padding: 10px 20px; cursor: pointer; border-bottom: 2px solid transparent; }
    .stock-tab.active { border-bottom-color: #4F46E5; color: #4F46E5; font-weight: bold; }
    .stock-tab-content { display: none; }
    .stock-tab-content.active { display: block; }
    
    /* 可视化区域 */
    .visualization-container { display: flex; flex-wrap: wrap; gap: 20px; margin-top: 20px; }
    .chart-box { width: 100%; height: 400px; min-width: 300px; flex: 1; }
    @media (min-width: 768px) {
        .chart-box { width: calc(50% - 10px); }
    }
    
    /* 上传区域 */
    .import-area { border: 2px dashed #4F46E5; border-radius: 8px; padding: 30px; text-align: center; margin: 15px 0; cursor: pointer; transition: all 0.3s; }
    .import-area:hover { background-color: #f0f7ff; }
    .import-icon { font-size: 40px; margin-bottom: 15px; color: #4F46E5; }
    #adminFileInput { display: none; }
    
    /* 表格容器 */
    .table-container { overflow-x: auto; margin-top: 10px; max-height: 500px; overflow-y: auto; }
</style>
</head>
<body>
<div class="container">
    <h1>瓷砖库存管理系统</h1>
    
    <!-- 库存管理内容 -->
    <div id="stock-content">
        <div class="card">
            <h2>库存管理</h2>
            <!-- 选项卡 -->
            <div class="stock-tabs">
                <div class="stock-tab active" onclick="switchStockTab('search')">库存查询</div>
                <div class="stock-tab" onclick="switchStockTab('full')">完整库存表</div>
                <div class="stock-tab" onclick="switchStockTab('visual')">库存可视化</div>
            </div>
            
            <!-- 查询内容 -->
            <div class="stock-tab-content active" id="search-tab-content">
                <div class="form-group">
                    <label>瓷砖编号 (B列，支持模糊查询)</label>
                    <input id="stockCode" placeholder="输入编号关键词" type="text"/>
                </div>
                <div class="flex-row">
                    <button onclick="searchStock()">查询库存</button>
                    <button class="secondary" onclick="refreshStockData()">刷新数据</button>
                </div>
                <div class="last-update" id="last-update-time">库存最后更新时间：加载中...</div>
                
                <div class="card" style="margin-top: 15px;">
                    <h3>查询结果</h3>
                    <div class="table-container">
                        <table class="stock-table" id="stock-result-table" style="display: none;">
                            <thead>
                                <tr>
                                    <th>编号 (B列)</th>
                                    <th>色号 (C列)</th>
                                    <th>数量(箱) (J列)</th>
                                    <th>仓库</th>
                                </tr>
                            </thead>
                            <tbody id="stock-result-body"></tbody>
                        </table>
                        <div id="stock-result-message">请输入编号并点击查询</div>
                    </div>
                </div>
            </div>
            
            <!-- 完整库存表 -->
            <div class="stock-tab-content" id="full-tab-content">
                <button class="secondary" onclick="refreshStockData()">刷新数据</button>
                <div class="last-update" id="full-last-update-time">库存最后更新时间：加载中...</div>
                
                <div class="card" style="margin-top: 15px;">
                    <h3>完整库存表</h3>
                    <div class="table-container">
                        <table class="stock-table" id="full-stock-table" style="display: none;">
                            <thead>
                                <tr>
                                    <th>编号 (B列)</th>
                                    <th>色号 (C列)</th>
                                    <th>数量(箱) (J列)</th>
                                    <th>仓库</th>
                                </tr>
                            </thead>
                            <tbody id="full-stock-body"></tbody>
                        </table>
                        <div id="full-stock-message">加载库存数据中...</div>
                    </div>
                </div>
            </div>
            
            <!-- 可视化内容 -->
            <div class="stock-tab-content" id="visual-tab-content">
                <h3>库存数据可视化</h3>
                <p>基于当前库存数据生成的统计图表</p>
                
                <div class="visualization-container">
                    <div class="chart-box" id="warehouse-pie-chart">
                        <!-- 仓库库存分布饼图 -->
                    </div>
                    <div class="chart-box" id="stock-bar-chart">
                        <!-- 库存数量柱状图 -->
                    </div>
                </div>
                
                <div class="chart-box" id="category-bar-chart" style="margin-top: 20px;">
                    <!-- 分类库存对比图 -->
                </div>
                
                <div class="last-update" style="margin-top: 15px;">
                    图表数据最后更新：<span id="visual-update-time">加载中...</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 管理员登录 -->
    <div class="compact-auth">
        <div class="form-group">
            <span class="auth-label">管理员入口</span>
            <input id="adminPassword" placeholder="输入密码" type="password"/>
            <div class="error-message" id="adminError"></div>
        </div>
        <button class="admin" onclick="authenticateAdmin()">登录</button>
    </div>
    
    <!-- 管理员功能区 -->
    <div class="admin-section" id="adminSection">
        <h2>管理员功能</h2>
        <p><strong>列映射说明：</strong>B列=编号，C列=色号（空则不显示），J列=数量</p>
        
        <div class="import-area" onclick="document.getElementById('adminFileInput').click()">
            <div class="import-icon">📂</div>
            <p>点击或拖拽Excel文件到此处上传库存数据</p>
            <input accept=".xlsx,.xls" id="adminFileInput" onchange="handleAdminFileUpload(event)" type="file"/>
        </div>
        
        <!-- 工作表选择 -->
        <div id="sheetSelection" style="display: none; margin: 20px 0;">
            <h3>工作表与仓库映射</h3>
            <div id="sheetList"></div>
            <button class="secondary" onclick="previewMappedData()">预览数据</button>
        </div>
        
        <!-- 数据预览 -->
        <div id="dataPreview" style="display: none; margin: 20px 0;">
            <h3>数据预览</h3>
            <div id="previewContent"></div>
            <div class="flex-row" style="margin-top: 15px;">
                <button onclick="saveMappedData()">确认并保存</button>
                <button class="gray" onclick="cancelUpload()">取消</button>
            </div>
        </div>
        
        <button class="gray" onclick="logoutAdmin()" style="margin-top: 20px;">退出管理员</button>
    </div>
</div>
<div class="toast" id="toast"></div>

<script>
    // 全局变量
    let stockData = [];
    let isAdmin = false;
    let workbookData = null;
    let sheetWarehouses = {};
    let mappedData = [];
    const DEFAULT_ADMIN_PASSWORD = "admin";
    const THAI_KEYWORD = "กระเบื้อง";
    
    // 列映射配置（B列=编号，C列=色号，J列=数量）
    const COLUMN_MAPPINGS = {
        checkColumn: "B",    // 检查是否包含泰语的列（B列）
        codeColumn: "B",     // 编号列（B列）
        colorColumn: "C",    // 色号列（C列）
        quantityColumn: "J", // 数量列（J列）
        startRow: 0          // 数据起始行
    };
    
    // 库存阈值
    const STOCK_THRESHOLDS = {
        urgent: 10,   // 紧急库存
        low: 50,      // 低库存
        medium: 100   // 中等库存
    };
    
    // 页面加载完成后初始化
    window.onload = function() {
        waitForFirebase();
    };
    
    // 等待Firebase初始化
    function waitForFirebase() {
        if (window.firebaseInitialized !== undefined) {
            if (window.firebaseInitialized) {
                initSystem();
            } else {
                showToast('初始化失败: ' + window.firebaseError);
            }
            return;
        }
        setTimeout(waitForFirebase, 100);
    }
    
    // 系统初始化
    function initSystem() {
        // 加载库存数据
        loadStockData();
        
        // 实时监听数据变化
        if (window.firebase) {
            firebase.onValue(firebase.stockRef, (snapshot) => {
                const data = snapshot.val();
                if (data && data.stockData) {
                    stockData = data.stockData;
                    updateLastUpdateTime(data.updateTime);
                    localStorage.setItem('cachedStockData', JSON.stringify(stockData));
                    localStorage.setItem('cachedStockTime', data.updateTime);
                    
                    // 更新可视化图表
                    if (document.querySelector('.stock-tab.active').getAttribute('onclick').includes('visual')) {
                        updateVisualizations();
                    }
                }
            });
        }
    }
    
    // 切换选项卡
    function switchStockTab(tabName) {
        // 更新选项卡样式
        document.querySelectorAll('.stock-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelector(`.stock-tab[onclick="switchStockTab('${tabName}')"]`).classList.add('active');
        
        // 更新内容显示
        document.querySelectorAll('.stock-tab-content').forEach(content => {
            content.classList.remove('active');
        });
        document.getElementById(`${tabName}-tab-content`).classList.add('active');
        
        // 如果切换到可视化标签，更新图表
        if (tabName === 'visual') {
            updateVisualizations();
        }
    }
    
    // 搜索库存
    function searchStock() {
        const code = document.getElementById('stockCode').value.trim().toLowerCase();
        const table = document.getElementById('stock-result-table');
        const tbody = document.getElementById('stock-result-body');
        const message = document.getElementById('stock-result-message');
        
        table.style.display = 'none';
        tbody.innerHTML = '';
        message.textContent = '';
        
        if (!code) {
            message.textContent = '请输入瓷砖编号关键词';
            return;
        }
        
        if (stockData.length === 0) {
            message.textContent = '暂无库存数据，请管理员上传';
            return;
        }
        
        // 执行搜索
        const results = stockData.filter(item => 
            item.code && item.code.toLowerCase().includes(code)
        );
        
        if (results.length === 0) {
            message.textContent = `未找到包含"${code}"的瓷砖编号`;
            return;
        }
        
        // 显示结果
        table.style.display = 'table';
        results.forEach(item => {
            const row = document.createElement('tr');
            
            // 库存状态样式
            let quantityHtml = item.quantity;
            if (quantityHtml <= STOCK_THRESHOLDS.urgent) {
                quantityHtml = `<span class="stock-urgent">${quantityHtml}</span>`;
            } else if (quantityHtml <= STOCK_THRESHOLDS.low) {
                quantityHtml = `<span class="stock-low">${quantityHtml}</span>`;
            } else if (quantityHtml <= STOCK_THRESHOLDS.medium) {
                quantityHtml = `<span class="stock-medium">${quantityHtml}</span>`;
            } else {
                quantityHtml = `<span class="stock-high">${quantityHtml}</span>`;
            }
            
            row.innerHTML = `
                <td>${item.code}</td>
                <td>${item.color || '-'}</td>
                <td>${quantityHtml}</td>
                <td>${item.warehouse}</td>
            `;
            tbody.appendChild(row);
        });
    }
    
    // 显示完整库存表
    function displayFullStockTable() {
        const table = document.getElementById('full-stock-table');
        const tbody = document.getElementById('full-stock-body');
        const message = document.getElementById('full-stock-message');
        
        table.style.display = 'none';
        tbody.innerHTML = '';
        
        if (stockData.length === 0) {
            message.textContent = '暂无库存数据，请管理员上传';
            return;
        }
        
        // 按仓库分组显示
        const sortedData = [...stockData].sort((a, b) => {
            if (a.warehouse !== b.warehouse) {
                return a.warehouse.localeCompare(b.warehouse);
            }
            return a.code.localeCompare(b.code);
        });
        
        table.style.display = 'table';
        message.textContent = '';
        
        sortedData.forEach(item => {
            const row = document.createElement('tr');
            
            let quantityHtml = item.quantity;
            if (quantityHtml <= STOCK_THRESHOLDS.urgent) {
                quantityHtml = `<span class="stock-urgent">${quantityHtml}</span>`;
            } else if (quantityHtml <= STOCK_THRESHOLDS.low) {
                quantityHtml = `<span class="stock-low">${quantityHtml}</span>`;
            } else if (quantityHtml <= STOCK_THRESHOLDS.medium) {
                quantityHtml = `<span class="stock-medium">${quantityHtml}</span>`;
            } else {
                quantityHtml = `<span class="stock-high">${quantityHtml}</span>`;
            }
            
            row.innerHTML = `
                <td>${item.code}</td>
                <td>${item.color || '-'}</td>
                <td>${quantityHtml}</td>
                <td>${item.warehouse}</td>
            `;
            tbody.appendChild(row);
        });
    }
    
    // 刷新库存数据
    function refreshStockData() {
        showToast('正在刷新数据...');
        stockData = [];
        loadStockData(true);
    }
    
    // 加载库存数据
    function loadStockData(forceRefresh = false) {
        // 尝试从缓存加载
        if (!forceRefresh) {
            const cachedStock = localStorage.getItem('cachedStockData');
            const cachedTime = localStorage.getItem('cachedStockTime');
            if (cachedStock && cachedTime) {
                try {
                    stockData = JSON.parse(cachedStock);
                    updateLastUpdateTime(cachedTime);
                    displayFullStockTable();
                    showToast('已加载缓存数据');
                    return;
                } catch (e) {
                    console.error('缓存数据解析失败', e);
                }
            }
        }
        
        // 从数据库加载
        if (window.firebase) {
            firebase.get(firebase.stockRef).then((snapshot) => {
                const data = snapshot.val();
                if (data && data.stockData) {
                    stockData = data.stockData;
                    updateLastUpdateTime(data.updateTime);
                    localStorage.setItem('cachedStockData', JSON.stringify(stockData));
                    localStorage.setItem('cachedStockTime', data.updateTime);
                    showToast('已加载最新数据');
                } else {
                    stockData = [];
                    showToast('暂无库存数据');
                }
                displayFullStockTable();
            }).catch((error) => {
                console.error('加载数据失败', error);
                showToast('加载数据失败，请检查网络');
            });
        }
    }
    
    // 更新最后更新时间
    function updateLastUpdateTime(time) {
        if (!time) return;
        const formattedTime = new Date(time).toLocaleString();
        document.getElementById('last-update-time').textContent = `库存最后更新时间：${formattedTime}`;
        document.getElementById('full-last-update-time').textContent = `库存最后更新时间：${formattedTime}`;
        document.getElementById('visual-update-time').textContent = formattedTime;
    }
    
    // 管理员登录
    function authenticateAdmin() {
        const password = document.getElementById('adminPassword').value;
        const errorElement = document.getElementById('adminError');
        
        if (!password) {
            errorElement.textContent = '请输入密码';
            errorElement.style.display = 'block';
            return;
        }
        
        if (password === DEFAULT_ADMIN_PASSWORD) {
            isAdmin = true;
            document.getElementById('adminSection').style.display = 'block';
            document.getElementById('adminPassword').value = '';
            showToast('管理员登录成功');
            errorElement.style.display = 'none';
        } else {
            errorElement.textContent = '密码错误';
            errorElement.style.display = 'block';
        }
    }
    
    // 管理员退出
    function logoutAdmin() {
        isAdmin = false;
        document.getElementById('adminSection').style.display = 'none';
        showToast('已退出管理员模式');
    }
    
    // 处理文件上传
    function handleAdminFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        if (!file.name.endsWith('.xlsx') && !file.name.endsWith('.xls')) {
            showToast('请上传Excel文件');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                workbookData = XLSX.read(data, { type: 'array' });
                const sheetNames = workbookData.SheetNames;
                
                if (sheetNames.length === 0) {
                    throw new Error('未找到工作表');
                }
                
                // 生成工作表选择列表
                const sheetListElement = document.getElementById('sheetList');
                sheetListElement.innerHTML = '';
                
                sheetNames.forEach((sheetName, index) => {
                    const defaultWarehouse = index === 0 ? '1号仓库' : 
                                           index === 1 ? 'k38仓库' : 'k39仓库';
                    
                    sheetWarehouses[sheetName] = defaultWarehouse;
                    
                    const sheetItem = document.createElement('div');
                    sheetItem.className = 'form-group';
                    sheetItem.innerHTML = `
                        <label>
                            <input type="checkbox" checked id="sheet-${index}">
                            工作表: ${sheetName}
                        </label>
                        <select onchange="sheetWarehouses['${sheetName}'] = this.value">
                            <option value="1号仓库" ${defaultWarehouse === '1号仓库' ? 'selected' : ''}>1号仓库</option>
                            <option value="k38仓库" ${defaultWarehouse === 'k38仓库' ? 'selected' : ''}>k38仓库</option>
                            <option value="k39仓库" ${defaultWarehouse === 'k39仓库' ? 'selected' : ''}>k39仓库</option>
                        </select>
                    `;
                    sheetListElement.appendChild(sheetItem);
                });
                
                document.getElementById('sheetSelection').style.display = 'block';
                showToast(`已解析文件，发现 ${sheetNames.length} 个工作表`);
            } catch (error) {
                console.error('处理文件失败', error);
                showToast('处理文件失败: ' + error.message);
            }
        };
        reader.readAsArrayBuffer(file);
    }
    
    // 预览映射数据
    function previewMappedData() {
        if (!workbookData) return;
        
        mappedData = [];
        const previewContent = document.getElementById('previewContent');
        previewContent.innerHTML = '';
        
        // 处理每个选中的工作表
        Object.keys(sheetWarehouses).forEach(sheetName => {
            const sheetIndex = workbookData.SheetNames.indexOf(sheetName);
            const isChecked = document.getElementById(`sheet-${sheetIndex}`).checked;
            
            if (!isChecked) return;
            
            const warehouse = sheetWarehouses[sheetName];
            const worksheet = workbookData.Sheets[sheetName];
            const sheetData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            
            if (!sheetData || sheetData.length === 0) return;
            
            const warehouseData = [];
            let validCount = 0;
            
            // 处理每一行数据
            for (let i = COLUMN_MAPPINGS.startRow; i < sheetData.length; i++) {
                const row = sheetData[i];
                
                // 列索引转换 (A=0, B=1, C=2, ..., J=9)
                const checkColIndex = XLSX.utils.decode_col(COLUMN_MAPPINGS.checkColumn);
                const codeColIndex = XLSX.utils.decode_col(COLUMN_MAPPINGS.codeColumn);
                const colorColIndex = XLSX.utils.decode_col(COLUMN_MAPPINGS.colorColumn);
                const quantityColIndex = XLSX.utils.decode_col(COLUMN_MAPPINGS.quantityColumn);
                
                // 获取B列数据检查是否包含泰语关键词
                const checkValue = row[checkColIndex] ? String(row[checkColIndex]).trim() : '';
                const containsKeyword = checkValue.includes(THAI_KEYWORD);
                
                if (containsKeyword) {
                    // 提取数据
                    const code = row[codeColIndex] ? String(row[codeColIndex]).trim() : '';
                    const color = row[colorColIndex] ? String(row[colorColIndex]).trim() : '';
                    const quantity = row[quantityColIndex] ? Number(row[quantityColIndex]) : 0;
                    
                    // 验证数据
                    const isValid = code && !isNaN(quantity) && quantity >= 0;
                    if (isValid) validCount++;
                    
                    const item = {
                        code,
                        color,
                        quantity: isValid ? quantity : 0,
                        warehouse,
                        rowNumber: i + 1,
                        isValid
                    };
                    
                    warehouseData.push(item);
                    if (isValid) mappedData.push(item);
                }
            }
            
            // 生成预览表格
            const warehousePreview = document.createElement('div');
            warehousePreview.className = 'card';
            warehousePreview.style.marginBottom = '15px';
            
            warehousePreview.innerHTML = `
                <h4>${sheetName} - ${warehouse}</h4>
                <p>共发现 ${warehouseData.length} 条包含泰语关键词的数据，其中有效数据 ${validCount} 条</p>
                <table class="stock-table">
                    <thead>
                        <tr>
                            <th>行号</th>
                            <th>编号 (B列)</th>
                            <th>色号 (C列)</th>
                            <th>数量 (J列)</th>
                            <th>状态</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${warehouseData.slice(0, 5).map(item => `
                            <tr style="background-color: ${item.isValid ? '' : '#fff0f0'}">
                                <td>${item.rowNumber}</td>
                                <td>${item.code}</td>
                                <td>${item.color || '-'}</td>
                                <td>${item.quantity}</td>
                                <td>${item.isValid ? '有效' : '无效'}</td>
                            </tr>
                        `).join('')}
                        ${warehouseData.length > 5 ? `<tr><td colspan="5">... 共 ${warehouseData.length} 条数据 ...</td></tr>` : ''}
                    </tbody>
                </table>
            `;
            
            previewContent.appendChild(warehousePreview);
        });
        
        document.getElementById('dataPreview').style.display = 'block';
        showToast(`预览完成，共 ${mappedData.length} 条有效数据`);
    }
    
    // 保存映射数据
    function saveMappedData() {
        if (mappedData.length === 0) {
            showToast('没有有效数据可保存');
            return;
        }
        
        const updateTime = new Date().toLocaleString();
        
        if (window.firebase) {
            firebase.set(firebase.stockRef, {
                stockData: mappedData,
                updateTime
            }).then(() => {
                showToast('数据保存成功');
                document.getElementById('sheetSelection').style.display = 'none';
                document.getElementById('dataPreview').style.display = 'none';
                
                // 更新本地数据
                stockData = mappedData;
                updateLastUpdateTime(updateTime);
                displayFullStockTable();
            }).catch(error => {
                console.error('保存数据失败', error);
                showToast('保存数据失败: ' + error.message);
            });
        }
    }
    
    // 取消上传
    function cancelUpload() {
        document.getElementById('sheetSelection').style.display = 'none';
        document.getElementById('dataPreview').style.display = 'none';
        workbookData = null;
        showToast('已取消上传');
    }
    
    // 更新可视化图表
    function updateVisualizations() {
        if (stockData.length === 0) {
            document.getElementById('warehouse-pie-chart').innerHTML = '<p style="text-align: center; padding: 20px;">暂无数据可可视化</p>';
            document.getElementById('stock-bar-chart').innerHTML = '<p style="text-align: center; padding: 20px;">暂无数据可可视化</p>';
            document.getElementById('category-bar-chart').innerHTML = '<p style="text-align: center; padding: 20px;">暂无数据可可视化</p>';
            return;
        }
        
        // 1. 仓库库存分布饼图
        const warehouseData = {};
        stockData.forEach(item => {
            if (!warehouseData[item.warehouse]) {
                warehouseData[item.warehouse] = 0;
            }
            warehouseData[item.warehouse] += item.quantity;
        });
        
        const pieChart = echarts.init(document.getElementById('warehouse-pie-chart'));
        pieChart.setOption({
            title: { text: '各仓库库存总量分布', left: 'center' },
            tooltip: { trigger: 'item' },
            legend: { orient: 'vertical', left: 'left' },
            series: [{
                name: '库存数量',
                type: 'pie',
                radius: '70%',
                data: Object.entries(warehouseData).map(([name, value]) => ({ name, value })),
                emphasis: { itemStyle: { shadowBlur: 10, shadowOffsetX: 0, shadowColor: 'rgba(0, 0, 0, 0.5)' } }
            }]
        });
        
        // 2. 库存数量TOP10柱状图
        const topItems = [...stockData]
            .sort((a, b) => b.quantity - a.quantity)
            .slice(0, 10);
        
        const barChart = echarts.init(document.getElementById('stock-bar-chart'));
        barChart.setOption({
            title: { text: '库存数量TOP10', left: 'center' },
            tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
            grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
            xAxis: { type: 'value' },
            yAxis: { 
                type: 'category',
                data: topItems.map(item => item.code)
            },
            series: [{
                name: '数量(箱)',
                type: 'bar',
                data: topItems.map(item => item.quantity),
                itemStyle: {
                    color: function(params) {
                        const value = params.value;
                        if (value <= STOCK_THRESHOLDS.urgent) return '#ef4444';
                        if (value <= STOCK_THRESHOLDS.low) return '#f97316';
                        if (value <= STOCK_THRESHOLDS.medium) return '#f59e0b';
                        return '#10B981';
                    }
                }
            }]
        });
        
        // 3. 仓库库存分类对比图
        const categoryData = {};
        const warehouses = new Set(stockData.map(item => item.warehouse));
        
        // 初始化每个仓库的库存分类
        warehouses.forEach(warehouse => {
            categoryData[warehouse] = {
                urgent: 0,
                low: 0,
                medium: 0,
                high: 0
            };
        });
        
        // 统计各仓库的库存分类
        stockData.forEach(item => {
            let category;
            if (item.quantity <= STOCK_THRESHOLDS.urgent) category = 'urgent';
            else if (item.quantity <= STOCK_THRESHOLDS.low) category = 'low';
            else if (item.quantity <= STOCK_THRESHOLDS.medium) category = 'medium';
            else category = 'high';
            
            categoryData[item.warehouse][category]++;
        });
        
        const categoryChart = echarts.init(document.getElementById('category-bar-chart'));
        categoryChart.setOption({
            title: { text: '各仓库库存状态分布', left: 'center' },
            tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
            legend: { data: ['紧急', '低库存', '中等库存', '充足'] },
            grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
            xAxis: { type: 'category', data: Array.from(warehouses) },
            yAxis: { type: 'value', name: '商品数量' },
            series: [
                { name: '紧急', type: 'bar', stack: 'total', data: Array.from(warehouses).map(w => categoryData[w].urgent), itemStyle: { color: '#ef4444' } },
                { name: '低库存', type: 'bar', stack: 'total', data: Array.from(warehouses).map(w => categoryData[w].low), itemStyle: { color: '#f97316' } },
                { name: '中等库存', type: 'bar', stack: 'total', data: Array.from(warehouses).map(w => categoryData[w].medium), itemStyle: { color: '#f59e0b' } },
                { name: '充足', type: 'bar', stack: 'total', data: Array.from(warehouses).map(w => categoryData[w].high), itemStyle: { color: '#10B981' } }
            ]
        });
        
        // 响应窗口大小变化
        window.addEventListener('resize', () => {
            pieChart.resize();
            barChart.resize();
            categoryChart.resize();
        });
    }
    
    // 显示提示消息
    function showToast(message) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.style.display = 'block';
        setTimeout(() => { toast.style.display = 'none'; }, 3000);
    }
</script>
</body>
</html>
