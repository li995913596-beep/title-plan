<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç“·ç –å‡ºå…¥åº“ç®¡ç†ç³»ç»Ÿ</title>
    <!-- å¼•å…¥SheetJSåº“ç”¨äºå¤„ç†Excelæ–‡ä»¶ -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
        body { padding: 15px; background-color: #f5f5f5; }
        .container { max-width: 500px; margin: 0 auto; }
        .card { background: white; padding: 15px; margin-bottom: 15px; border-radius: 8px; box-shadow: 0 1px 3px #eee; }
        h1, h2 { margin-bottom: 15px; color: #333; }
        h1 { text-align: center; color: #4F46E5; font-size: 20px; padding: 10px 0; }
        .form-group { margin-bottom: 12px; }
        label { display: block; margin-bottom: 5px; font-size: 14px; color: #666; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 15px; }
        button { background-color: #4F46E5; color: white; border: none; padding: 12px; border-radius: 4px; width: 100%; font-size: 16px; margin-top: 5px; cursor: pointer; }
        button.secondary { background-color: #10B981; }
        button.gray { background-color: #f0f0f0; color: #666; }
        .flex-row { display: flex; gap: 10px; }
        .flex-row button { flex: 1; }
        #tiles-list { margin: 10px 0; padding: 10px; border: 1px dashed #ddd; min-height: 60px; }
        .tile-item { padding: 8px; background: #f9f9f9; margin-bottom: 5px; border-radius: 4px; }
        #result { margin: 10px 0; padding: 10px; background: #f9f9f9; border-radius: 4px; white-space: pre-wrap; font-size: 14px; }
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); color: white; padding: 10px 15px; border-radius: 4px; display: none; }
        .mode-selector { display: flex; margin-bottom: 15px; flex-wrap: wrap; }
        .mode-selector button { flex: 1; margin: 0; min-width: 120px; }
        .mode-selector button.active { background-color: #4F46E5; color: white; }
        .mode-selector button:not(.active) { background-color: #f0f0f0; color: #666; }
        .mode-content { display: none; }
        .mode-content.active { display: block; }
        .stock-item { padding: 10px; border-bottom: 1px solid #eee; }
        .stock-item:last-child { border-bottom: none; }
        .common-content { display: block; }
        .stock-mode .common-content { display: none; }
        
        /* å¯¼å…¥åŒºåŸŸæ ·å¼ */
        .import-area {
            border: 2px dashed #ccc;
            border-radius: 6px;
            padding: 20px;
            text-align: center;
            margin-bottom: 15px;
            cursor: pointer;
            transition: border-color 0.3s;
        }
        .import-area:hover {
            border-color: #4F46E5;
        }
        .import-icon {
            font-size: 24px;
            color: #4F46E5;
            margin-bottom: 10px;
        }
        #file-input {
            display: none;
        }
        .last-update {
            font-size: 13px;
            color: #666;
            margin-top: 10px;
            text-align: right;
        }
        .column-info {
            font-size: 12px;
            color: #666;
            margin-top: 10px;
            padding: 8px;
            background-color: #f9f9f9;
            border-radius: 4px;
            text-align: left;
        }
        .worksheet-info {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            padding: 8px;
            background-color: #f0f9f0;
            border-radius: 4px;
            text-align: left;
        }
        /* GitHub Pages é€‚é…æ ·å¼ */
        .github-footer {
            text-align: center;
            font-size: 12px;
            color: #666;
            margin-top: 20px;
            padding: 10px;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>ç“·ç –å‡ºå…¥åº“ç®¡ç†ç³»ç»Ÿ</h1>
    <div class="mode-selector">
        <button id="outbound-mode" class="active" onclick="switchMode('outbound')">å‡ºè´§è®¡åˆ’</button>
        <button id="inbound-mode" onclick="switchMode('inbound')">æµ·è¿å…¥åº“</button>
        <button id="stock-mode" onclick="switchMode('stock')">åº“å­˜æŸ¥è¯¢</button>
    </div>
    <div class="card"><div id="date"></div></div>

    <div id="outbound-content" class="mode-content active">
        <div class="card">
            <h2>è®¢å•ä¿¡æ¯</h2>
            <div class="form-group"><label>å®¢æˆ· (å¯é€‰)</label><input type="text" id="customer" oninput="saveData()"></div>
            <div class="form-group">
                <label>æ˜¯å¦ä»˜æ¬¾</label>
                <select id="payment" onchange="saveData()">
                    <option value="">è¯·é€‰æ‹©</option>
                    <option value="yes">æ˜¯</option>
                    <option value="no">å¦</option>
                </select>
            </div>
            <div class="form-group"><label>å•ä½æˆ–è½¦ç‰Œ</label><input type="text" id="unit" oninput="saveData()"></div>
        </div>
    </div>

    <div id="inbound-content" class="mode-content">
        <div class="card">
            <h2>å…¥åº“ä¿¡æ¯</h2>
            <div class="form-group"><label>æŸœå· *</label><input type="text" id="containerNo" oninput="saveData()"></div>
            <div class="form-group">
                <label>å…¥åº“ä»“åº“ *</label>
                <select id="warehouse" onchange="saveData()">
                    <option value="">è¯·é€‰æ‹©</option>
                    <option value="1å·ä»“åº“">1å·ä»“åº“</option>
                    <option value="k38ä»“åº“">k38ä»“åº“</option>
                    <option value="k39ä»“åº“">k39ä»“åº“</option>
                </select>
            </div>
        </div>
    </div>

    <div id="stock-content" class="mode-content">
        <div class="card">
            <h2>åº“å­˜ç®¡ç†</h2>
            
            <!-- Excelå¯¼å…¥åŒºåŸŸ -->
            <div class="import-area" onclick="document.getElementById('file-input').click()">
                <div class="import-icon">ğŸ“‚</div>
                <p>ç‚¹å‡»æˆ–æ‹–æ‹½Excelæ–‡ä»¶åˆ°æ­¤å¤„å¯¼å…¥åº“å­˜æ•°æ®</p>
                <p style="font-size: 12px; color: #666; margin-top: 5px;">æ”¯æŒ .xlsx å’Œ .xls æ ¼å¼</p>
                <input type="file" id="file-input" accept=".xlsx,.xls" onchange="handleFileUpload(event)">
                
                <!-- æ˜¾ç¤ºåˆ—ä¿¡æ¯ -->
                <div class="column-info">
                    <p><strong>æ–‡ä»¶æ ¼å¼è¦æ±‚ï¼š</strong></p>
                    <p>â€¢ ç¼–å· - Båˆ—ï¼ˆç¬¬2åˆ—ï¼‰</p>
                    <p>â€¢ è‰²å· - Cåˆ—ï¼ˆç¬¬3åˆ—ï¼‰</p>
                    <p>â€¢ å‰©ä½™åº“å­˜ - Jåˆ—ï¼ˆç¬¬10åˆ—ï¼‰</p>
                </div>
                
                <!-- æ˜¾ç¤ºå·¥ä½œè¡¨ä¿¡æ¯ -->
                <div class="worksheet-info">
                    <p><strong>å·¥ä½œè¡¨è¯´æ˜ï¼š</strong></p>
                    <p>â€¢ æ¯ä¸ªå·¥ä½œè¡¨ä»£è¡¨ä¸€ä¸ªä»“åº“</p>
                    <p>â€¢ å·¥ä½œè¡¨åç§°å°†ä½œä¸ºä»“åº“åç§°</p>
                </div>
            </div>
            
            <div class="last-update" id="last-update-time">
                ä¸Šæ¬¡æ›´æ–°æ—¶é—´ï¼šä»æœªæ›´æ–°
            </div>
            
            <h2 style="margin-top: 20px;">åº“å­˜æŸ¥è¯¢</h2>
            <div class="form-group">
                <label>ç“·ç –ç¼–å· (æ”¯æŒæ¨¡ç³ŠæŸ¥è¯¢)</label>
                <input type="text" id="stockCode" placeholder="è¾“å…¥ç¼–å·å…³é”®è¯">
            </div>
            <button onclick="searchStock()">æŸ¥è¯¢åº“å­˜</button>
        </div>
        
        <div class="card">
            <h2>æŸ¥è¯¢ç»“æœ</h2>
            <div id="stock-result">è¯·è¾“å…¥ç¼–å·å¹¶ç‚¹å‡»æŸ¥è¯¢</div>
        </div>
    </div>

    <!-- å…¬å…±å†…å®¹åŒºåŸŸ - åœ¨åº“å­˜æŸ¥è¯¢æ¨¡å¼ä¸‹ä¼šéšè— -->
    <div class="common-content">
        <div class="card">
            <h2>ç“·ç –ä¿¡æ¯</h2>
            <div class="form-group"><label>ç¼–å· *</label><input type="text" id="code"></div>
            <div class="form-group">
                <label>è§„æ ¼ *</label>
                <select id="size" onchange="handleSizeChange()">
                    <option value="">è¯·é€‰æ‹©</option>
                    <option value="300*300">300*300</option>
                    <option value="300*600">300*600</option>
                    <option value="400*400">400*400</option>
                    <option value="400*800">400*800</option>
                    <option value="470*1200">470*1200</option>
                    <option value="470*1350">470*1350</option>
                    <option value="600*600">600*600</option>
                    <option value="600*1200">600*1200</option>
                    <option value="750*1500">750*1500</option>
                    <option value="800*800">800*800</option>
                    <option value="200*1200">200*1200</option>
                    <option value="custom">è‡ªå®šä¹‰</option>
                </select>
                <input type="text" id="customSize" placeholder="è¯·è¾“å…¥è‡ªå®šä¹‰è§„æ ¼" style="margin-top:5px; display:none;" oninput="saveData()">
            </div>
            <div class="form-group"><label>æ•°é‡ *</label><input type="text" id="quantity" oninput="this.value=this.value.replace(/\D/g,''); saveData();"></div>
            <div class="form-group"><label>è‰²å· (å¯é€‰)</label><input type="text" id="color"></div>
            <button onclick="addTile()">æ·»åŠ åˆ°åˆ—è¡¨</button>
        </div>

        <div class="card">
            <h2>å·²æ·»åŠ çš„ç“·ç –</h2>
            <div id="tiles-list">å°šæœªæ·»åŠ ç“·ç –</div>
            <div class="flex-row">
                <button class="gray" onclick="clearAll()">æ¸…ç©º</button>
                <button class="secondary" onclick="generatePlan()">ç”Ÿæˆè®¡åˆ’</button>
            </div>
        </div>

        <div class="card">
            <h2>è®¡åˆ’ç»“æœ</h2>
            <div id="result"></div>
            <button onclick="copyResult()">å¤åˆ¶å†…å®¹</button>
        </div>
    </div>
    
    <!-- GitHub Pages é¡µè„šä¿¡æ¯ -->
    <div class="github-footer">
        ç“·ç –å‡ºå…¥åº“ç®¡ç†ç³»ç»Ÿ &copy; 2023 | éƒ¨ç½²äº GitHub Pages
    </div>
</div>
<div class="toast" id="toast"></div>

<script>
    var tiles = [], tileIndex = 0, currentMode = 'outbound';
    var stockData = []; // åº“å­˜æ•°æ®å°†ä»Excelå¯¼å…¥
    
    // é¡µé¢åŠ è½½æ—¶å°è¯•ä»æœ¬åœ°å­˜å‚¨åŠ è½½åº“å­˜æ•°æ®
    window.onload = function() {
        // æ£€æŸ¥æ˜¯å¦åœ¨GitHub Pagesç¯å¢ƒ
        const isGitHubPages = window.location.hostname.includes('github.io');
        if (isGitHubPages) {
            console.log('æ£€æµ‹åˆ°GitHub Pagesç¯å¢ƒï¼Œå·²ä¼˜åŒ–é…ç½®');
        }
        
        var now = new Date();
        document.getElementById('date').textContent = 
            now.getFullYear() + '/' + (now.getMonth()+1) + '/' + now.getDate();

        // æ¢å¤åº“å­˜æ•°æ®
        var savedStock = localStorage.getItem('tileStockData');
        var lastUpdate = localStorage.getItem('lastStockUpdate');
        
        if (savedStock) {
            try {
                stockData = JSON.parse(savedStock);
            } catch (e) {
                console.error('è§£æåº“å­˜æ•°æ®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®', e);
                // ä½¿ç”¨é»˜è®¤æ•°æ®
                stockData = [
                    { code: "TC001", color: "ç™½è‰²", warehouse: "1å·ä»“åº“", quantity: 150 },
                    { code: "TC002", color: "ç°è‰²", warehouse: "k38ä»“åº“", quantity: 80 },
                    { code: "TC003", color: "ç±³é»„", warehouse: "k39ä»“åº“", quantity: 200 },
                    { code: "TC004", color: "æµ…ç°", warehouse: "1å·ä»“åº“", quantity: 120 },
                    { code: "TC005", color: "æ·±ç°", warehouse: "k38ä»“åº“", quantity: 50 }
                ];
                saveStockData();
            }
        } else {
            // å¦‚æœæ²¡æœ‰ä¿å­˜çš„åº“å­˜æ•°æ®ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®
            stockData = [
                { code: "TC001", color: "ç™½è‰²", warehouse: "1å·ä»“åº“", quantity: 150 },
                { code: "TC002", color: "ç°è‰²", warehouse: "k38ä»“åº“", quantity: 80 },
                { code: "TC003", color: "ç±³é»„", warehouse: "k39ä»“åº“", quantity: 200 },
                { code: "TC004", color: "æµ…ç°", warehouse: "1å·ä»“åº“", quantity: 120 },
                { code: "TC005", color: "æ·±ç°", warehouse: "k38ä»“åº“", quantity: 50 }
            ];
            saveStockData(); // ä¿å­˜é»˜è®¤æ•°æ®
        }
        
        // æ›´æ–°ä¸Šæ¬¡æ›´æ–°æ—¶é—´æ˜¾ç¤º
        updateLastUpdateTime(lastUpdate);

        // æ¢å¤å…¶ä»–æ•°æ®
        var saved = localStorage.getItem('tilePlanData');
        if (saved) {
            try {
                var data = JSON.parse(saved);
                tiles = data.tiles || [];
                currentMode = data.currentMode || 'outbound';
                document.getElementById('customer').value = data.customer || '';
                document.getElementById('payment').value = data.payment || '';
                document.getElementById('unit').value = data.unit || '';
                document.getElementById('containerNo').value = data.containerNo || '';
                document.getElementById('warehouse').value = data.warehouse || '';
                document.getElementById('result').textContent = data.result || '';
                document.getElementById('customSize').value = data.customSize || '';
                updateTilesList();
                switchMode(currentMode);
                handleSizeChange();
            } catch (e) {
                console.error('è§£æè®¡åˆ’æ•°æ®å¤±è´¥ï¼Œé‡ç½®æ•°æ®', e);
                localStorage.removeItem('tilePlanData');
            }
        }
    };

    // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
    function handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        // æ£€æŸ¥æ–‡ä»¶ç±»å‹
        const fileExtension = file.name.split('.').pop().toLowerCase();
        if (fileExtension !== 'xlsx' && fileExtension !== 'xls') {
            showToast('è¯·ä¸Šä¼ Excelæ–‡ä»¶ï¼ˆ.xlsxæˆ–.xlsæ ¼å¼ï¼‰');
            return;
        }
        
        const reader = new FileReader();
        
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                
                // å¤„ç†æ‰€æœ‰å·¥ä½œè¡¨
                stockData = [];
                let totalValidCount = 0;
                
                // éå†æ¯ä¸ªå·¥ä½œè¡¨ï¼ˆæ¯ä¸ªå·¥ä½œè¡¨ä»£è¡¨ä¸€ä¸ªä»“åº“ï¼‰
                workbook.SheetNames.forEach(warehouseName => {
                    const worksheet = workbook.Sheets[warehouseName];
                    const range = XLSX.utils.decode_range(worksheet['!ref'] || 'A1:A1');
                    
                    // éªŒè¯æ˜¯å¦æœ‰è¶³å¤Ÿçš„åˆ—
                    if (range.e.c < 9) { // Jåˆ—æ˜¯ç¬¬10åˆ—ï¼Œç´¢å¼•ä¸º9
                        showToast(`å·¥ä½œè¡¨ "${warehouseName}" åˆ—æ•°ä¸è¶³ï¼Œéœ€è¦è‡³å°‘10åˆ—ï¼ˆJåˆ—ï¼‰`);
                        return;
                    }
                    
                    // ä»ç¬¬2è¡Œå¼€å§‹è¯»å–æ•°æ®ï¼ˆè·³è¿‡è¡¨å¤´ï¼‰
                    let sheetValidCount = 0;
                    
                    for (let row = range.s.r + 1; row <= range.e.r; row++) {
                        // è¯»å–Båˆ—ï¼ˆç´¢å¼•1ï¼‰ã€Cåˆ—ï¼ˆç´¢å¼•2ï¼‰å’ŒJåˆ—ï¼ˆç´¢å¼•9ï¼‰
                        const codeCell = worksheet[XLSX.utils.encode_cell({r: row, c: 1})];
                        const colorCell = worksheet[XLSX.utils.encode_cell({r: row, c: 2})];
                        const quantityCell = worksheet[XLSX.utils.encode_cell({r: row, c: 9})];
                        
                        // è·å–å•å…ƒæ ¼å€¼
                        let code = codeCell ? (codeCell.v || '').toString().trim() : '';
                        const color = colorCell ? (colorCell.v || '').toString().trim() : '';
                        const quantity = quantityCell ? parseInt(quantityCell.v || 0) : 0;
                        
                        // å»é™¤ç¼–å·ä¸­çš„æ³°è¯­å‰ç¼€
                        code = removeThaiPrefix(code);
                        
                        // åªä¿ç•™æœ‰ç¼–å·çš„è®°å½•
                        if (code) {
                            stockData.push({
                                code: code,
                                color: color,
                                warehouse: warehouseName, // å·¥ä½œè¡¨åç§°ä½œä¸ºä»“åº“åç§°
                                quantity: isNaN(quantity) ? 0 : quantity
                            });
                            sheetValidCount++;
                            totalValidCount++;
                        }
                    }
                    
                    console.log(`å·¥ä½œè¡¨ "${warehouseName}" å¯¼å…¥ ${sheetValidCount} æ¡æœ‰æ•ˆè®°å½•`);
                });
                
                if (totalValidCount === 0) {
                    showToast('æœªæ‰¾åˆ°æœ‰æ•ˆçš„åº“å­˜æ•°æ®ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼');
                    return;
                }
                
                // ä¿å­˜æ•°æ®å¹¶æ›´æ–°UI
                saveStockData();
                
                // è®°å½•æ›´æ–°æ—¶é—´
                const updateTime = new Date();
                localStorage.setItem('lastStockUpdate', updateTime.toISOString());
                updateLastUpdateTime(updateTime.toISOString());
                
                showToast(`æˆåŠŸå¯¼å…¥ ${totalValidCount} æ¡åº“å­˜è®°å½•ï¼Œæ¥è‡ª ${workbook.SheetNames.length} ä¸ªä»“åº“`);
                
                // æ¸…ç©ºæ–‡ä»¶è¾“å…¥ï¼Œå…è®¸é‡å¤ä¸Šä¼ åŒä¸€æ–‡ä»¶
                document.getElementById('file-input').value = '';
            } catch (error) {
                console.error('å¯¼å…¥å¤±è´¥:', error);
                showToast('æ–‡ä»¶å¯¼å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼');
            }
        };
        
        reader.readAsArrayBuffer(file);
    }
    
    // å»é™¤ç¼–å·ä¸­çš„æ³°è¯­å‰ç¼€
    function removeThaiPrefix(code) {
        if (!code) return code;
        
        // æ³°è¯­UnicodeèŒƒå›´ï¼š0E00-0E7F
        const thaiRegex = /^[\u0E00-\u0E7F]+/;
        return code.replace(thaiRegex, '').trim();
    }
    
    // ä¿å­˜åº“å­˜æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
    function saveStockData() {
        try {
            localStorage.setItem('tileStockData', JSON.stringify(stockData));
        } catch (e) {
            console.warn('ä¿å­˜åº“å­˜æ•°æ®å¤±è´¥', e);
            showToast('ä¿å­˜åº“å­˜æ•°æ®å¤±è´¥');
        }
    }
    
    // æ›´æ–°ä¸Šæ¬¡æ›´æ–°æ—¶é—´æ˜¾ç¤º
    function updateLastUpdateTime(timestamp) {
        const element = document.getElementById('last-update-time');
        if (!timestamp) {
            element.textContent = 'ä¸Šæ¬¡æ›´æ–°æ—¶é—´ï¼šä»æœªæ›´æ–°';
            return;
        }
        
        const date = new Date(timestamp);
        const formattedTime = `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
        element.textContent = `ä¸Šæ¬¡æ›´æ–°æ—¶é—´ï¼š${formattedTime}`;
    }

    function switchMode(mode){
        currentMode = mode;
        // æ›´æ–°æ¨¡å¼æŒ‰é’®çŠ¶æ€
        document.getElementById('outbound-mode').classList.remove('active');
        document.getElementById('inbound-mode').classList.remove('active');
        document.getElementById('stock-mode').classList.remove('active');
        document.getElementById(mode+'-mode').classList.add('active');
        
        // æ›´æ–°å†…å®¹åŒºåŸŸæ˜¾ç¤º
        document.getElementById('outbound-content').classList.remove('active');
        document.getElementById('inbound-content').classList.remove('active');
        document.getElementById('stock-content').classList.remove('active');
        document.getElementById(mode+'-content').classList.add('active');
        
        // æ§åˆ¶å…¬å…±å†…å®¹åŒºåŸŸæ˜¾ç¤º
        document.body.classList.toggle('stock-mode', mode === 'stock');
        
        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        let msg = '';
        switch(mode) {
            case 'outbound': msg = 'å·²åˆ‡æ¢åˆ°å‡ºè´§è®¡åˆ’'; break;
            case 'inbound': msg = 'å·²åˆ‡æ¢åˆ°æµ·è¿å…¥åº“'; break;
            case 'stock': msg = 'å·²åˆ‡æ¢åˆ°åº“å­˜æŸ¥è¯¢'; break;
        }
        showToast(msg);
        saveData();
    }

    function showToast(msg){
        var t=document.getElementById('toast');
        t.textContent=msg;
        t.style.display='block';
        setTimeout(()=>{t.style.display='none';},2000);
    }

    function handleSizeChange() {
        var sizeSelect = document.getElementById('size');
        var customInput = document.getElementById('customSize');
        if (sizeSelect.value === 'custom') {
            customInput.style.display = 'block';
            customInput.value = '';
        } else {
            customInput.style.display = 'none';
            customInput.value = '';
        }
        saveData();
    }

    function addTile(){
        var code=document.getElementById('code').value.trim();
        var sizeSelect=document.getElementById('size');
        var size=sizeSelect.value;
        if(size==='custom'){
            size=document.getElementById('customSize').value.trim();
        }
        var quantity=document.getElementById('quantity').value.trim();
        var color=document.getElementById('color').value.trim();

        if(!code){showToast('è¯·å¡«å†™ç¼–å·');return;}
        if(!size){showToast('è¯·å¡«å†™è§„æ ¼');return;}
        if(!quantity){showToast('è¯·å¡«å†™æ•°é‡');return;}

        tileIndex++;
        tiles.push({id:tileIndex,code,size,quantity,color});
        updateTilesList();

        document.getElementById('code').value='';
        document.getElementById('quantity').value='';
        document.getElementById('color').value='';
        document.getElementById('size').value='';
        document.getElementById('customSize').value='';
        document.getElementById('customSize').style.display='none';

        showToast('å·²æ·»åŠ ');
        saveData();
    }

    function updateTilesList(){
        var listEl=document.getElementById('tiles-list');
        if(tiles.length===0){listEl.innerHTML='å°šæœªæ·»åŠ ç“·ç –';return;}
        listEl.innerHTML=tiles.map((t,i)=>`<div class="tile-item">${i+1}. ${t.code} ${t.size} ${t.quantity}ä»¶ 
        <button style="padding:3px 6px;font-size:12px;background:#ff4d4f;" onclick="deleteTile(${t.id})">åˆ é™¤</button></div>`).join('');
    }

    function deleteTile(id){
        tiles=tiles.filter(t=>t.id!==id);
        updateTilesList();
        showToast('å·²åˆ é™¤');
        saveData();
    }

    function clearAll(){
        if(confirm('ç¡®å®šè¦æ¸…ç©ºå—ï¼Ÿ')){
            tiles=[];
            ['customer','payment','unit','containerNo','warehouse','code','size','quantity','color','customSize','stockCode'].forEach(id=>{
                document.getElementById(id).value='';
            });
            document.getElementById('customSize').style.display='none';
            document.getElementById('result').textContent='';
            document.getElementById('stock-result').textContent='è¯·è¾“å…¥ç¼–å·å¹¶ç‚¹å‡»æŸ¥è¯¢';
            updateTilesList();
            localStorage.removeItem('tilePlanData');
        }
    }

    function generatePlan(){
        if(tiles.length===0){showToast('è¯·å…ˆæ·»åŠ ç“·ç –');return;}
        if(currentMode==='inbound'){
            var containerNo=document.getElementById('containerNo').value.trim(),
                warehouse=document.getElementById('warehouse').value;
            if(!containerNo){showToast('è¯·å¡«å†™æŸœå·');return;}
            if(!warehouse){showToast('è¯·é€‰æ‹©å…¥åº“ä»“åº“');return;}
        }
        var plan=document.getElementById('date').textContent+'\n';
        if(currentMode==='outbound'){
            plan+='å‡ºè´§è®¡åˆ’\n';
            var customer=document.getElementById('customer').value.trim(),
                payment=document.getElementById('payment').value,
                unit=document.getElementById('unit').value.trim();
            if(customer) plan+='å®¢æˆ·ï¼š'+customer+'\n';
            if(payment==='yes') plan+='å·²ä»˜æ¬¾\n';
            if(payment==='no') plan+='æœªä»˜æ¬¾\n';
            if(unit) plan+='å•ä½/è½¦ç‰Œï¼š'+unit+'\n';
        }else{
            plan+='æµ·è¿å…¥åº“ï¼š\n';
            plan+='æŸœå·ï¼š'+document.getElementById('containerNo').value.trim()+'\n';
            plan+='å…¥åº“ä»“åº“ï¼š'+document.getElementById('warehouse').value+'\n';
        }
        plan+='\n';
        tiles.forEach((t,i)=>{
            plan+=(i+1)+'.á€€á€¯á€’á€ºá€”á€­á€•á€á€º/ç¼–å·ï¼š'+t.code+'\n';
            plan+='á€¡á€œá€»á€¬á€¸á€¡á€”á€¶/è§„æ ¼ï¼š'+t.size+'\n';
            plan+='á€¡á€›á€±á€¡á€á€½á€€á€º/æ•°é‡ï¼š'+t.quantity+'\n';
            if(t.color) plan+='á€¡á€›á€±á€¬á€„á€ºá€€á€¯á€’á€º/è‰²å·ï¼š'+t.color+'\n';
            plan+='\n';
        });
        document.getElementById('result').textContent=plan;
        showToast('è®¡åˆ’å·²ç”Ÿæˆ');
        saveData();
    }

    async function copyResult(){
        var text=document.getElementById('result').textContent;
        if(!text){showToast('è¯·å…ˆç”Ÿæˆè®¡åˆ’');return;}
        try{
            await navigator.clipboard.writeText(text);
            showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
        }catch(e){
            console.error('å¤åˆ¶å¤±è´¥:', e);
            showToast('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å¤åˆ¶');
        }
    }

    function saveData(){
        const data = {
            tiles: tiles,
            customer: document.getElementById('customer').value,
            payment: document.getElementById('payment').value,
            unit: document.getElementById('unit').value,
            containerNo: document.getElementById('containerNo').value,
            warehouse: document.getElementById('warehouse').value,
            result: document.getElementById('result').textContent,
            currentMode: currentMode,
            customSize: document.getElementById('customSize').value
        };
        try {
            localStorage.setItem('tilePlanData', JSON.stringify(data));
        } catch(e) {
            console.warn('ä¿å­˜æ•°æ®å¤±è´¥', e);
            // åœ¨GitHub Pagesç¯å¢ƒä¸‹å¯èƒ½æœ‰å­˜å‚¨é™åˆ¶ï¼Œæ·»åŠ æ›´å‹å¥½çš„æç¤º
            showToast('æ•°æ®ä¿å­˜å¤±è´¥ï¼Œå¯èƒ½æ˜¯æµè§ˆå™¨å­˜å‚¨é™åˆ¶');
        }
    }

    // åº“å­˜æŸ¥è¯¢åŠŸèƒ½
    function searchStock() {
        const code = document.getElementById('stockCode').value.trim().toLowerCase();
        const resultEl = document.getElementById('stock-result');
        
        if (!code) {
            showToast('è¯·è¾“å…¥ç¼–å·å…³é”®è¯');
            return;
        }
        
        // å¤„ç†æŸ¥è¯¢å…³é”®è¯ï¼Œå»é™¤å¯èƒ½çš„æ³°è¯­å‰ç¼€
        const processedCode = removeThaiPrefix(code);
        
        // æ¨¡ç³ŠæŸ¥è¯¢ï¼Œä¸åŒºåˆ†å¤§å°å†™
        const matches = stockData.filter(item => 
            item.code.toLowerCase().includes(processedCode)
        );
        
        if (matches.length === 0) {
            resultEl.innerHTML = 'æœªæ‰¾åˆ°åŒ¹é…çš„åº“å­˜è®°å½•';
            showToast('æœªæ‰¾åˆ°åŒ¹é…çš„åº“å­˜');
            return;
        }
        
        // æ˜¾ç¤ºæŸ¥è¯¢ç»“æœï¼ŒæŒ‰ä»“åº“åˆ†ç»„
        const groupedByWarehouse = {};
        matches.forEach(item => {
            if (!groupedByWarehouse[item.warehouse]) {
                groupedByWarehouse[item.warehouse] = [];
            }
            groupedByWarehouse[item.warehouse].push(item);
        });
        
        let html = '';
        let itemIndex = 1;
        
        // éå†æ¯ä¸ªä»“åº“çš„ç»“æœ
        for (const warehouse in groupedByWarehouse) {
            html += `<div style="margin-bottom: 15px;"><strong>ã€${warehouse}ã€‘</strong></div>`;
            
            groupedByWarehouse[warehouse].forEach(item => {
                html += `
                <div class="stock-item">
                    <p><strong>${itemIndex}. ç¼–å·ï¼š</strong>${item.code}</p>
                    <p><strong>è‰²å·ï¼š</strong>${item.color}</p>
                    <p><strong>å‰©ä½™åº“å­˜ï¼š</strong>${item.quantity}ä»¶</p>
                </div>
                `;
                itemIndex++;
            });
        }
        
        resultEl.innerHTML = html;
        showToast(`æ‰¾åˆ°${matches.length}æ¡åŒ¹é…è®°å½•`);
    }

    // æ”¯æŒå›è½¦é”®æŸ¥è¯¢åº“å­˜
    document.getElementById('stockCode').addEventListener('keyup', function(event) {
        if (event.key === 'Enter') {
            searchStock();
        }
    });

    // æ”¯æŒæ‹–æ”¾æ–‡ä»¶ä¸Šä¼ 
    const importArea = document.querySelector('.import-area');
    
    importArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        importArea.style.borderColor = '#4F46E5';
        importArea.style.backgroundColor = 'rgba(79, 70, 229, 0.05)';
    });
    
    importArea.addEventListener('dragleave', function() {
        importArea.style.borderColor = '#ccc';
        importArea.style.backgroundColor = 'transparent';
    });
    
    importArea.addEventListener('drop', function(e) {
        e.preventDefault();
        importArea.style.borderColor = '#ccc';
        importArea.style.backgroundColor = 'transparent';
        
        if (e.dataTransfer.files.length) {
            document.getElementById('file-input').files = e.dataTransfer.files;
            handleFileUpload({ target: document.getElementById('file-input') });
        }
    });
</script>
</body>
</html>
    