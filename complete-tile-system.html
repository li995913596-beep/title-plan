<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>ç“·ç –åº“å­˜ç®¡ç†ç³»ç»Ÿ</title>
<!-- å¼•å…¥Excelå¤„ç†åº“ -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<!-- å¼•å…¥Firebase -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, get } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";
    
    const firebaseConfig = {
        apiKey: "AIzaSyC65DEOgj4WeksRRVmw4ZTrNkCB83SoQpI",
        authDomain: "tile-management-system-f5db8.firebaseapp.com",
        databaseURL: "https://tile-management-system-f5db8-default-rtdb.firebaseio.com",
        projectId: "tile-management-system-f5db8",
        storageBucket: "tile-management-system-f5db8.appspot.com",
        messagingSenderId: "925027091187",
        appId: "1:925027091187:web:a2bb160b629f541abded86"
    };

    try {
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const stockRef = ref(database, 'tileStock');
        window.firebase = { app, database, ref, set, onValue, get, stockRef };
        window.firebaseInitialized = true;
    } catch (error) {
        window.firebaseInitialized = false;
        window.firebaseError = error.message;
    }
</script>
<!-- å¼•å…¥EChartsç”¨äºå¯è§†åŒ– -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
<style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
    body { padding: 15px; background-color: #f5f5f5; }
    .container { max-width: 1200px; margin: 0 auto; }
    .card { background: white; padding: 20px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    h1, h2, h3 { margin-bottom: 15px; color: #333; }
    h1 { text-align: center; color: #4F46E5; font-size: 24px; padding: 10px 0; }
    .form-group { margin-bottom: 15px; }
    label { display: block; margin-bottom: 6px; font-size: 14px; color: #666; }
    input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 15px; }
    button { background-color: #4F46E5; color: white; border: none; padding: 12px; border-radius: 4px; width: 100%; font-size: 16px; margin-top: 8px; cursor: pointer; transition: background 0.3s; }
    button:hover { background-color: #4338ca; }
    button.secondary { background-color: #10B981; }
    button.gray { background-color: #f0f0f0; color: #666; }
    button.admin { background-color: #f59e0b; }
    .flex-row { display: flex; gap: 10px; margin-bottom: 15px; }
    .flex-row button { flex: 1; }
    .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); color: white; padding: 12px 20px; border-radius: 4px; display: none; z-index: 1000; }
    .last-update { font-size: 13px; color: #666; margin-top: 10px; text-align: right; }
    .admin-section { margin: 20px 0; padding: 20px; background-color: #fff3cd; border-radius: 8px; display: none; }
    
    /* è¡¨æ ¼æ ·å¼ */
    .stock-table { width: 100%; border-collapse: collapse; margin-top: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .stock-table th { padding: 12px 15px; text-align: left; background-color: #4F46E5; color: white; font-weight: bold; }
    .stock-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
    .stock-table tr:hover { background-color: #f0f7ff; }
    .stock-table tr:nth-child(even) { background-color: #f9f9f9; }
    
    /* åº“å­˜çŠ¶æ€æ ·å¼ */
    .stock-urgent { color: white; background-color: #ef4444; padding: 2px 6px; border-radius: 3px; font-weight: bold; }
    .stock-low { color: #ef4444; font-weight: bold; }
    .stock-medium { color: #f59e0b; font-weight: bold; }
    .stock-high { color: #10B981; font-weight: bold; }
    
    /* é€‰é¡¹å¡æ ·å¼ */
    .stock-tabs { display: flex; margin-bottom: 20px; border-bottom: 1px solid #ddd; }
    .stock-tab { padding: 10px 20px; cursor: pointer; border-bottom: 2px solid transparent; }
    .stock-tab.active { border-bottom-color: #4F46E5; color: #4F46E5; font-weight: bold; }
    .stock-tab-content { display: none; }
    .stock-tab-content.active { display: block; }
    
    /* å¯è§†åŒ–åŒºåŸŸ */
    .visualization-container { display: flex; flex-wrap: wrap; gap: 20px; margin-top: 20px; }
    .chart-box { width: 100%; height: 400px; min-width: 300px; flex: 1; }
    @media (min-width: 768px) {
        .chart-box { width: calc(50% - 10px); }
    }
    
    /* ä¸Šä¼ åŒºåŸŸ */
    .import-area { border: 2px dashed #4F46E5; border-radius: 8px; padding: 30px; text-align: center; margin: 15px 0; cursor: pointer; transition: all 0.3s; }
    .import-area:hover { background-color: #f0f7ff; }
    .import-icon { font-size: 40px; margin-bottom: 15px; color: #4F46E5; }
    #adminFileInput { display: none; }
    
    /* è¡¨æ ¼å®¹å™¨ */
    .table-container { overflow-x: auto; margin-top: 10px; max-height: 500px; overflow-y: auto; }
</style>
</head>
<body>
<div class="container">
    <h1>ç“·ç –åº“å­˜ç®¡ç†ç³»ç»Ÿ</h1>
    
    <!-- åº“å­˜ç®¡ç†å†…å®¹ -->
    <div id="stock-content">
        <div class="card">
            <h2>åº“å­˜ç®¡ç†</h2>
            <!-- é€‰é¡¹å¡ -->
            <div class="stock-tabs">
                <div class="stock-tab active" onclick="switchStockTab('search')">åº“å­˜æŸ¥è¯¢</div>
                <div class="stock-tab" onclick="switchStockTab('full')">å®Œæ•´åº“å­˜è¡¨</div>
                <div class="stock-tab" onclick="switchStockTab('visual')">åº“å­˜å¯è§†åŒ–</div>
            </div>
            
            <!-- æŸ¥è¯¢å†…å®¹ -->
            <div class="stock-tab-content active" id="search-tab-content">
                <div class="form-group">
                    <label>ç“·ç –ç¼–å· (Båˆ—ï¼Œæ”¯æŒæ¨¡ç³ŠæŸ¥è¯¢)</label>
                    <input id="stockCode" placeholder="è¾“å…¥ç¼–å·å…³é”®è¯" type="text"/>
                </div>
                <div class="flex-row">
                    <button onclick="searchStock()">æŸ¥è¯¢åº“å­˜</button>
                    <button class="secondary" onclick="refreshStockData()">åˆ·æ–°æ•°æ®</button>
                </div>
                <div class="last-update" id="last-update-time">åº“å­˜æœ€åæ›´æ–°æ—¶é—´ï¼šåŠ è½½ä¸­...</div>
                
                <div class="card" style="margin-top: 15px;">
                    <h3>æŸ¥è¯¢ç»“æœ</h3>
                    <div class="table-container">
                        <table class="stock-table" id="stock-result-table" style="display: none;">
                            <thead>
                                <tr>
                                    <th>ç¼–å· (Båˆ—)</th>
                                    <th>è‰²å· (Cåˆ—)</th>
                                    <th>æ•°é‡(ç®±) (Jåˆ—)</th>
                                    <th>ä»“åº“</th>
                                </tr>
                            </thead>
                            <tbody id="stock-result-body"></tbody>
                        </table>
                        <div id="stock-result-message">è¯·è¾“å…¥ç¼–å·å¹¶ç‚¹å‡»æŸ¥è¯¢</div>
                    </div>
                </div>
            </div>
            
            <!-- å®Œæ•´åº“å­˜è¡¨ -->
            <div class="stock-tab-content" id="full-tab-content">
                <button class="secondary" onclick="refreshStockData()">åˆ·æ–°æ•°æ®</button>
                <div class="last-update" id="full-last-update-time">åº“å­˜æœ€åæ›´æ–°æ—¶é—´ï¼šåŠ è½½ä¸­...</div>
                
                <div class="card" style="margin-top: 15px;">
                    <h3>å®Œæ•´åº“å­˜è¡¨</h3>
                    <div class="table-container">
                        <table class="stock-table" id="full-stock-table" style="display: none;">
                            <thead>
                                <tr>
                                    <th>ç¼–å· (Båˆ—)</th>
                                    <th>è‰²å· (Cåˆ—)</th>
                                    <th>æ•°é‡(ç®±) (Jåˆ—)</th>
                                    <th>ä»“åº“</th>
                                </tr>
                            </thead>
                            <tbody id="full-stock-body"></tbody>
                        </table>
                        <div id="full-stock-message">åŠ è½½åº“å­˜æ•°æ®ä¸­...</div>
                    </div>
                </div>
            </div>
            
            <!-- å¯è§†åŒ–å†…å®¹ -->
            <div class="stock-tab-content" id="visual-tab-content">
                <h3>åº“å­˜æ•°æ®å¯è§†åŒ–</h3>
                <p>åŸºäºå½“å‰åº“å­˜æ•°æ®ç”Ÿæˆçš„ç»Ÿè®¡å›¾è¡¨</p>
                
                <div class="visualization-container">
                    <div class="chart-box" id="warehouse-pie-chart">
                        <!-- ä»“åº“åº“å­˜åˆ†å¸ƒé¥¼å›¾ -->
                    </div>
                    <div class="chart-box" id="stock-bar-chart">
                        <!-- åº“å­˜æ•°é‡æŸ±çŠ¶å›¾ -->
                    </div>
                </div>
                
                <div class="chart-box" id="category-bar-chart" style="margin-top: 20px;">
                    <!-- åˆ†ç±»åº“å­˜å¯¹æ¯”å›¾ -->
                </div>
                
                <div class="last-update" style="margin-top: 15px;">
                    å›¾è¡¨æ•°æ®æœ€åæ›´æ–°ï¼š<span id="visual-update-time">åŠ è½½ä¸­...</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ç®¡ç†å‘˜ç™»å½• -->
    <div class="compact-auth">
        <div class="form-group">
            <span class="auth-label">ç®¡ç†å‘˜å…¥å£</span>
            <input id="adminPassword" placeholder="è¾“å…¥å¯†ç " type="password"/>
            <div class="error-message" id="adminError"></div>
        </div>
        <button class="admin" onclick="authenticateAdmin()">ç™»å½•</button>
    </div>
    
    <!-- ç®¡ç†å‘˜åŠŸèƒ½åŒº -->
    <div class="admin-section" id="adminSection">
        <h2>ç®¡ç†å‘˜åŠŸèƒ½</h2>
        <p><strong>åˆ—æ˜ å°„è¯´æ˜ï¼š</strong>Båˆ—=ç¼–å·ï¼ŒCåˆ—=è‰²å·ï¼ˆç©ºåˆ™ä¸æ˜¾ç¤ºï¼‰ï¼ŒJåˆ—=æ•°é‡</p>
        
        <div class="import-area" onclick="document.getElementById('adminFileInput').click()">
            <div class="import-icon">ğŸ“‚</div>
            <p>ç‚¹å‡»æˆ–æ‹–æ‹½Excelæ–‡ä»¶åˆ°æ­¤å¤„ä¸Šä¼ åº“å­˜æ•°æ®</p>
            <input accept=".xlsx,.xls" id="adminFileInput" onchange="handleAdminFileUpload(event)" type="file"/>
        </div>
        
        <!-- å·¥ä½œè¡¨é€‰æ‹© -->
        <div id="sheetSelection" style="display: none; margin: 20px 0;">
            <h3>å·¥ä½œè¡¨ä¸ä»“åº“æ˜ å°„</h3>
            <div id="sheetList"></div>
            <button class="secondary" onclick="previewMappedData()">é¢„è§ˆæ•°æ®</button>
        </div>
        
        <!-- æ•°æ®é¢„è§ˆ -->
        <div id="dataPreview" style="display: none; margin: 20px 0;">
            <h3>æ•°æ®é¢„è§ˆ</h3>
            <div id="previewContent"></div>
            <div class="flex-row" style="margin-top: 15px;">
                <button onclick="saveMappedData()">ç¡®è®¤å¹¶ä¿å­˜</button>
                <button class="gray" onclick="cancelUpload()">å–æ¶ˆ</button>
            </div>
        </div>
        
        <button class="gray" onclick="logoutAdmin()" style="margin-top: 20px;">é€€å‡ºç®¡ç†å‘˜</button>
    </div>
</div>
<div class="toast" id="toast"></div>

<script>
    // å…¨å±€å˜é‡
    let stockData = [];
    let isAdmin = false;
    let workbookData = null;
    let sheetWarehouses = {};
    let mappedData = [];
    const DEFAULT_ADMIN_PASSWORD = "admin";
    const THAI_KEYWORD = "à¸à¸£à¸°à¹€à¸šà¸·à¹‰à¸­à¸‡";
    
    // åˆ—æ˜ å°„é…ç½®ï¼ˆBåˆ—=ç¼–å·ï¼ŒCåˆ—=è‰²å·ï¼ŒJåˆ—=æ•°é‡ï¼‰
    const COLUMN_MAPPINGS = {
        checkColumn: "B",    // æ£€æŸ¥æ˜¯å¦åŒ…å«æ³°è¯­çš„åˆ—ï¼ˆBåˆ—ï¼‰
        codeColumn: "B",     // ç¼–å·åˆ—ï¼ˆBåˆ—ï¼‰
        colorColumn: "C",    // è‰²å·åˆ—ï¼ˆCåˆ—ï¼‰
        quantityColumn: "J", // æ•°é‡åˆ—ï¼ˆJåˆ—ï¼‰
        startRow: 0          // æ•°æ®èµ·å§‹è¡Œ
    };
    
    // åº“å­˜é˜ˆå€¼
    const STOCK_THRESHOLDS = {
        urgent: 10,   // ç´§æ€¥åº“å­˜
        low: 50,      // ä½åº“å­˜
        medium: 100   // ä¸­ç­‰åº“å­˜
    };
    
    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    window.onload = function() {
        waitForFirebase();
    };
    
    // ç­‰å¾…Firebaseåˆå§‹åŒ–
    function waitForFirebase() {
        if (window.firebaseInitialized !== undefined) {
            if (window.firebaseInitialized) {
                initSystem();
            } else {
                showToast('åˆå§‹åŒ–å¤±è´¥: ' + window.firebaseError);
            }
            return;
        }
        setTimeout(waitForFirebase, 100);
    }
    
    // ç³»ç»Ÿåˆå§‹åŒ–
    function initSystem() {
        // åŠ è½½åº“å­˜æ•°æ®
        loadStockData();
        
        // å®æ—¶ç›‘å¬æ•°æ®å˜åŒ–
        if (window.firebase) {
            firebase.onValue(firebase.stockRef, (snapshot) => {
                const data = snapshot.val();
                if (data && data.stockData) {
                    stockData = data.stockData;
                    updateLastUpdateTime(data.updateTime);
                    localStorage.setItem('cachedStockData', JSON.stringify(stockData));
                    localStorage.setItem('cachedStockTime', data.updateTime);
                    
                    // æ›´æ–°å¯è§†åŒ–å›¾è¡¨
                    if (document.querySelector('.stock-tab.active').getAttribute('onclick').includes('visual')) {
                        updateVisualizations();
                    }
                }
            });
        }
    }
    
    // åˆ‡æ¢é€‰é¡¹å¡
    function switchStockTab(tabName) {
        // æ›´æ–°é€‰é¡¹å¡æ ·å¼
        document.querySelectorAll('.stock-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelector(`.stock-tab[onclick="switchStockTab('${tabName}')"]`).classList.add('active');
        
        // æ›´æ–°å†…å®¹æ˜¾ç¤º
        document.querySelectorAll('.stock-tab-content').forEach(content => {
            content.classList.remove('active');
        });
        document.getElementById(`${tabName}-tab-content`).classList.add('active');
        
        // å¦‚æœåˆ‡æ¢åˆ°å¯è§†åŒ–æ ‡ç­¾ï¼Œæ›´æ–°å›¾è¡¨
        if (tabName === 'visual') {
            updateVisualizations();
        }
    }
    
    // æœç´¢åº“å­˜
    function searchStock() {
        const code = document.getElementById('stockCode').value.trim().toLowerCase();
        const table = document.getElementById('stock-result-table');
        const tbody = document.getElementById('stock-result-body');
        const message = document.getElementById('stock-result-message');
        
        table.style.display = 'none';
        tbody.innerHTML = '';
        message.textContent = '';
        
        if (!code) {
            message.textContent = 'è¯·è¾“å…¥ç“·ç –ç¼–å·å…³é”®è¯';
            return;
        }
        
        if (stockData.length === 0) {
            message.textContent = 'æš‚æ— åº“å­˜æ•°æ®ï¼Œè¯·ç®¡ç†å‘˜ä¸Šä¼ ';
            return;
        }
        
        // æ‰§è¡Œæœç´¢
        const results = stockData.filter(item => 
            item.code && item.code.toLowerCase().includes(code)
        );
        
        if (results.length === 0) {
            message.textContent = `æœªæ‰¾åˆ°åŒ…å«"${code}"çš„ç“·ç –ç¼–å·`;
            return;
        }
        
        // æ˜¾ç¤ºç»“æœ
        table.style.display = 'table';
        results.forEach(item => {
            const row = document.createElement('tr');
            
            // åº“å­˜çŠ¶æ€æ ·å¼
            let quantityHtml = item.quantity;
            if (quantityHtml <= STOCK_THRESHOLDS.urgent) {
                quantityHtml = `<span class="stock-urgent">${quantityHtml}</span>`;
            } else if (quantityHtml <= STOCK_THRESHOLDS.low) {
                quantityHtml = `<span class="stock-low">${quantityHtml}</span>`;
            } else if (quantityHtml <= STOCK_THRESHOLDS.medium) {
                quantityHtml = `<span class="stock-medium">${quantityHtml}</span>`;
            } else {
                quantityHtml = `<span class="stock-high">${quantityHtml}</span>`;
            }
            
            row.innerHTML = `
                <td>${item.code}</td>
                <td>${item.color || '-'}</td>
                <td>${quantityHtml}</td>
                <td>${item.warehouse}</td>
            `;
            tbody.appendChild(row);
        });
    }
    
    // æ˜¾ç¤ºå®Œæ•´åº“å­˜è¡¨
    function displayFullStockTable() {
        const table = document.getElementById('full-stock-table');
        const tbody = document.getElementById('full-stock-body');
        const message = document.getElementById('full-stock-message');
        
        table.style.display = 'none';
        tbody.innerHTML = '';
        
        if (stockData.length === 0) {
            message.textContent = 'æš‚æ— åº“å­˜æ•°æ®ï¼Œè¯·ç®¡ç†å‘˜ä¸Šä¼ ';
            return;
        }
        
        // æŒ‰ä»“åº“åˆ†ç»„æ˜¾ç¤º
        const sortedData = [...stockData].sort((a, b) => {
            if (a.warehouse !== b.warehouse) {
                return a.warehouse.localeCompare(b.warehouse);
            }
            return a.code.localeCompare(b.code);
        });
        
        table.style.display = 'table';
        message.textContent = '';
        
        sortedData.forEach(item => {
            const row = document.createElement('tr');
            
            let quantityHtml = item.quantity;
            if (quantityHtml <= STOCK_THRESHOLDS.urgent) {
                quantityHtml = `<span class="stock-urgent">${quantityHtml}</span>`;
            } else if (quantityHtml <= STOCK_THRESHOLDS.low) {
                quantityHtml = `<span class="stock-low">${quantityHtml}</span>`;
            } else if (quantityHtml <= STOCK_THRESHOLDS.medium) {
                quantityHtml = `<span class="stock-medium">${quantityHtml}</span>`;
            } else {
                quantityHtml = `<span class="stock-high">${quantityHtml}</span>`;
            }
            
            row.innerHTML = `
                <td>${item.code}</td>
                <td>${item.color || '-'}</td>
                <td>${quantityHtml}</td>
                <td>${item.warehouse}</td>
            `;
            tbody.appendChild(row);
        });
    }
    
    // åˆ·æ–°åº“å­˜æ•°æ®
    function refreshStockData() {
        showToast('æ­£åœ¨åˆ·æ–°æ•°æ®...');
        stockData = [];
        loadStockData(true);
    }
    
    // åŠ è½½åº“å­˜æ•°æ®
    function loadStockData(forceRefresh = false) {
        // å°è¯•ä»ç¼“å­˜åŠ è½½
        if (!forceRefresh) {
            const cachedStock = localStorage.getItem('cachedStockData');
            const cachedTime = localStorage.getItem('cachedStockTime');
            if (cachedStock && cachedTime) {
                try {
                    stockData = JSON.parse(cachedStock);
                    updateLastUpdateTime(cachedTime);
                    displayFullStockTable();
                    showToast('å·²åŠ è½½ç¼“å­˜æ•°æ®');
                    return;
                } catch (e) {
                    console.error('ç¼“å­˜æ•°æ®è§£æå¤±è´¥', e);
                }
            }
        }
        
        // ä»æ•°æ®åº“åŠ è½½
        if (window.firebase) {
            firebase.get(firebase.stockRef).then((snapshot) => {
                const data = snapshot.val();
                if (data && data.stockData) {
                    stockData = data.stockData;
                    updateLastUpdateTime(data.updateTime);
                    localStorage.setItem('cachedStockData', JSON.stringify(stockData));
                    localStorage.setItem('cachedStockTime', data.updateTime);
                    showToast('å·²åŠ è½½æœ€æ–°æ•°æ®');
                } else {
                    stockData = [];
                    showToast('æš‚æ— åº“å­˜æ•°æ®');
                }
                displayFullStockTable();
            }).catch((error) => {
                console.error('åŠ è½½æ•°æ®å¤±è´¥', error);
                showToast('åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ');
            });
        }
    }
    
    // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
    function updateLastUpdateTime(time) {
        if (!time) return;
        const formattedTime = new Date(time).toLocaleString();
        document.getElementById('last-update-time').textContent = `åº“å­˜æœ€åæ›´æ–°æ—¶é—´ï¼š${formattedTime}`;
        document.getElementById('full-last-update-time').textContent = `åº“å­˜æœ€åæ›´æ–°æ—¶é—´ï¼š${formattedTime}`;
        document.getElementById('visual-update-time').textContent = formattedTime;
    }
    
    // ç®¡ç†å‘˜ç™»å½•
    function authenticateAdmin() {
        const password = document.getElementById('adminPassword').value;
        const errorElement = document.getElementById('adminError');
        
        if (!password) {
            errorElement.textContent = 'è¯·è¾“å…¥å¯†ç ';
            errorElement.style.display = 'block';
            return;
        }
        
        if (password === DEFAULT_ADMIN_PASSWORD) {
            isAdmin = true;
            document.getElementById('adminSection').style.display = 'block';
            document.getElementById('adminPassword').value = '';
            showToast('ç®¡ç†å‘˜ç™»å½•æˆåŠŸ');
            errorElement.style.display = 'none';
        } else {
            errorElement.textContent = 'å¯†ç é”™è¯¯';
            errorElement.style.display = 'block';
        }
    }
    
    // ç®¡ç†å‘˜é€€å‡º
    function logoutAdmin() {
        isAdmin = false;
        document.getElementById('adminSection').style.display = 'none';
        showToast('å·²é€€å‡ºç®¡ç†å‘˜æ¨¡å¼');
    }
    
    // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
    function handleAdminFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        if (!file.name.endsWith('.xlsx') && !file.name.endsWith('.xls')) {
            showToast('è¯·ä¸Šä¼ Excelæ–‡ä»¶');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                workbookData = XLSX.read(data, { type: 'array' });
                const sheetNames = workbookData.SheetNames;
                
                if (sheetNames.length === 0) {
                    throw new Error('æœªæ‰¾åˆ°å·¥ä½œè¡¨');
                }
                
                // ç”Ÿæˆå·¥ä½œè¡¨é€‰æ‹©åˆ—è¡¨
                const sheetListElement = document.getElementById('sheetList');
                sheetListElement.innerHTML = '';
                
                sheetNames.forEach((sheetName, index) => {
                    const defaultWarehouse = index === 0 ? '1å·ä»“åº“' : 
                                           index === 1 ? 'k38ä»“åº“' : 'k39ä»“åº“';
                    
                    sheetWarehouses[sheetName] = defaultWarehouse;
                    
                    const sheetItem = document.createElement('div');
                    sheetItem.className = 'form-group';
                    sheetItem.innerHTML = `
                        <label>
                            <input type="checkbox" checked id="sheet-${index}">
                            å·¥ä½œè¡¨: ${sheetName}
                        </label>
                        <select onchange="sheetWarehouses['${sheetName}'] = this.value">
                            <option value="1å·ä»“åº“" ${defaultWarehouse === '1å·ä»“åº“' ? 'selected' : ''}>1å·ä»“åº“</option>
                            <option value="k38ä»“åº“" ${defaultWarehouse === 'k38ä»“åº“' ? 'selected' : ''}>k38ä»“åº“</option>
                            <option value="k39ä»“åº“" ${defaultWarehouse === 'k39ä»“åº“' ? 'selected' : ''}>k39ä»“åº“</option>
                        </select>
                    `;
                    sheetListElement.appendChild(sheetItem);
                });
                
                document.getElementById('sheetSelection').style.display = 'block';
                showToast(`å·²è§£ææ–‡ä»¶ï¼Œå‘ç° ${sheetNames.length} ä¸ªå·¥ä½œè¡¨`);
            } catch (error) {
                console.error('å¤„ç†æ–‡ä»¶å¤±è´¥', error);
                showToast('å¤„ç†æ–‡ä»¶å¤±è´¥: ' + error.message);
            }
        };
        reader.readAsArrayBuffer(file);
    }
    
    // é¢„è§ˆæ˜ å°„æ•°æ®
    function previewMappedData() {
        if (!workbookData) return;
        
        mappedData = [];
        const previewContent = document.getElementById('previewContent');
        previewContent.innerHTML = '';
        
        // å¤„ç†æ¯ä¸ªé€‰ä¸­çš„å·¥ä½œè¡¨
        Object.keys(sheetWarehouses).forEach(sheetName => {
            const sheetIndex = workbookData.SheetNames.indexOf(sheetName);
            const isChecked = document.getElementById(`sheet-${sheetIndex}`).checked;
            
            if (!isChecked) return;
            
            const warehouse = sheetWarehouses[sheetName];
            const worksheet = workbookData.Sheets[sheetName];
            const sheetData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            
            if (!sheetData || sheetData.length === 0) return;
            
            const warehouseData = [];
            let validCount = 0;
            
            // å¤„ç†æ¯ä¸€è¡Œæ•°æ®
            for (let i = COLUMN_MAPPINGS.startRow; i < sheetData.length; i++) {
                const row = sheetData[i];
                
                // åˆ—ç´¢å¼•è½¬æ¢ (A=0, B=1, C=2, ..., J=9)
                const checkColIndex = XLSX.utils.decode_col(COLUMN_MAPPINGS.checkColumn);
                const codeColIndex = XLSX.utils.decode_col(COLUMN_MAPPINGS.codeColumn);
                const colorColIndex = XLSX.utils.decode_col(COLUMN_MAPPINGS.colorColumn);
                const quantityColIndex = XLSX.utils.decode_col(COLUMN_MAPPINGS.quantityColumn);
                
                // è·å–Båˆ—æ•°æ®æ£€æŸ¥æ˜¯å¦åŒ…å«æ³°è¯­å…³é”®è¯
                const checkValue = row[checkColIndex] ? String(row[checkColIndex]).trim() : '';
                const containsKeyword = checkValue.includes(THAI_KEYWORD);
                
                if (containsKeyword) {
                    // æå–æ•°æ®
                    const code = row[codeColIndex] ? String(row[codeColIndex]).trim() : '';
                    const color = row[colorColIndex] ? String(row[colorColIndex]).trim() : '';
                    const quantity = row[quantityColIndex] ? Number(row[quantityColIndex]) : 0;
                    
                    // éªŒè¯æ•°æ®
                    const isValid = code && !isNaN(quantity) && quantity >= 0;
                    if (isValid) validCount++;
                    
                    const item = {
                        code,
                        color,
                        quantity: isValid ? quantity : 0,
                        warehouse,
                        rowNumber: i + 1,
                        isValid
                    };
                    
                    warehouseData.push(item);
                    if (isValid) mappedData.push(item);
                }
            }
            
            // ç”Ÿæˆé¢„è§ˆè¡¨æ ¼
            const warehousePreview = document.createElement('div');
            warehousePreview.className = 'card';
            warehousePreview.style.marginBottom = '15px';
            
            warehousePreview.innerHTML = `
                <h4>${sheetName} - ${warehouse}</h4>
                <p>å…±å‘ç° ${warehouseData.length} æ¡åŒ…å«æ³°è¯­å…³é”®è¯çš„æ•°æ®ï¼Œå…¶ä¸­æœ‰æ•ˆæ•°æ® ${validCount} æ¡</p>
                <table class="stock-table">
                    <thead>
                        <tr>
                            <th>è¡Œå·</th>
                            <th>ç¼–å· (Båˆ—)</th>
                            <th>è‰²å· (Cåˆ—)</th>
                            <th>æ•°é‡ (Jåˆ—)</th>
                            <th>çŠ¶æ€</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${warehouseData.slice(0, 5).map(item => `
                            <tr style="background-color: ${item.isValid ? '' : '#fff0f0'}">
                                <td>${item.rowNumber}</td>
                                <td>${item.code}</td>
                                <td>${item.color || '-'}</td>
                                <td>${item.quantity}</td>
                                <td>${item.isValid ? 'æœ‰æ•ˆ' : 'æ— æ•ˆ'}</td>
                            </tr>
                        `).join('')}
                        ${warehouseData.length > 5 ? `<tr><td colspan="5">... å…± ${warehouseData.length} æ¡æ•°æ® ...</td></tr>` : ''}
                    </tbody>
                </table>
            `;
            
            previewContent.appendChild(warehousePreview);
        });
        
        document.getElementById('dataPreview').style.display = 'block';
        showToast(`é¢„è§ˆå®Œæˆï¼Œå…± ${mappedData.length} æ¡æœ‰æ•ˆæ•°æ®`);
    }
    
    // ä¿å­˜æ˜ å°„æ•°æ®
    function saveMappedData() {
        if (mappedData.length === 0) {
            showToast('æ²¡æœ‰æœ‰æ•ˆæ•°æ®å¯ä¿å­˜');
            return;
        }
        
        const updateTime = new Date().toLocaleString();
        
        if (window.firebase) {
            firebase.set(firebase.stockRef, {
                stockData: mappedData,
                updateTime
            }).then(() => {
                showToast('æ•°æ®ä¿å­˜æˆåŠŸ');
                document.getElementById('sheetSelection').style.display = 'none';
                document.getElementById('dataPreview').style.display = 'none';
                
                // æ›´æ–°æœ¬åœ°æ•°æ®
                stockData = mappedData;
                updateLastUpdateTime(updateTime);
                displayFullStockTable();
            }).catch(error => {
                console.error('ä¿å­˜æ•°æ®å¤±è´¥', error);
                showToast('ä¿å­˜æ•°æ®å¤±è´¥: ' + error.message);
            });
        }
    }
    
    // å–æ¶ˆä¸Šä¼ 
    function cancelUpload() {
        document.getElementById('sheetSelection').style.display = 'none';
        document.getElementById('dataPreview').style.display = 'none';
        workbookData = null;
        showToast('å·²å–æ¶ˆä¸Šä¼ ');
    }
    
    // æ›´æ–°å¯è§†åŒ–å›¾è¡¨
    function updateVisualizations() {
        if (stockData.length === 0) {
            document.getElementById('warehouse-pie-chart').innerHTML = '<p style="text-align: center; padding: 20px;">æš‚æ— æ•°æ®å¯å¯è§†åŒ–</p>';
            document.getElementById('stock-bar-chart').innerHTML = '<p style="text-align: center; padding: 20px;">æš‚æ— æ•°æ®å¯å¯è§†åŒ–</p>';
            document.getElementById('category-bar-chart').innerHTML = '<p style="text-align: center; padding: 20px;">æš‚æ— æ•°æ®å¯å¯è§†åŒ–</p>';
            return;
        }
        
        // 1. ä»“åº“åº“å­˜åˆ†å¸ƒé¥¼å›¾
        const warehouseData = {};
        stockData.forEach(item => {
            if (!warehouseData[item.warehouse]) {
                warehouseData[item.warehouse] = 0;
            }
            warehouseData[item.warehouse] += item.quantity;
        });
        
        const pieChart = echarts.init(document.getElementById('warehouse-pie-chart'));
        pieChart.setOption({
            title: { text: 'å„ä»“åº“åº“å­˜æ€»é‡åˆ†å¸ƒ', left: 'center' },
            tooltip: { trigger: 'item' },
            legend: { orient: 'vertical', left: 'left' },
            series: [{
                name: 'åº“å­˜æ•°é‡',
                type: 'pie',
                radius: '70%',
                data: Object.entries(warehouseData).map(([name, value]) => ({ name, value })),
                emphasis: { itemStyle: { shadowBlur: 10, shadowOffsetX: 0, shadowColor: 'rgba(0, 0, 0, 0.5)' } }
            }]
        });
        
        // 2. åº“å­˜æ•°é‡TOP10æŸ±çŠ¶å›¾
        const topItems = [...stockData]
            .sort((a, b) => b.quantity - a.quantity)
            .slice(0, 10);
        
        const barChart = echarts.init(document.getElementById('stock-bar-chart'));
        barChart.setOption({
            title: { text: 'åº“å­˜æ•°é‡TOP10', left: 'center' },
            tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
            grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
            xAxis: { type: 'value' },
            yAxis: { 
                type: 'category',
                data: topItems.map(item => item.code)
            },
            series: [{
                name: 'æ•°é‡(ç®±)',
                type: 'bar',
                data: topItems.map(item => item.quantity),
                itemStyle: {
                    color: function(params) {
                        const value = params.value;
                        if (value <= STOCK_THRESHOLDS.urgent) return '#ef4444';
                        if (value <= STOCK_THRESHOLDS.low) return '#f97316';
                        if (value <= STOCK_THRESHOLDS.medium) return '#f59e0b';
                        return '#10B981';
                    }
                }
            }]
        });
        
        // 3. ä»“åº“åº“å­˜åˆ†ç±»å¯¹æ¯”å›¾
        const categoryData = {};
        const warehouses = new Set(stockData.map(item => item.warehouse));
        
        // åˆå§‹åŒ–æ¯ä¸ªä»“åº“çš„åº“å­˜åˆ†ç±»
        warehouses.forEach(warehouse => {
            categoryData[warehouse] = {
                urgent: 0,
                low: 0,
                medium: 0,
                high: 0
            };
        });
        
        // ç»Ÿè®¡å„ä»“åº“çš„åº“å­˜åˆ†ç±»
        stockData.forEach(item => {
            let category;
            if (item.quantity <= STOCK_THRESHOLDS.urgent) category = 'urgent';
            else if (item.quantity <= STOCK_THRESHOLDS.low) category = 'low';
            else if (item.quantity <= STOCK_THRESHOLDS.medium) category = 'medium';
            else category = 'high';
            
            categoryData[item.warehouse][category]++;
        });
        
        const categoryChart = echarts.init(document.getElementById('category-bar-chart'));
        categoryChart.setOption({
            title: { text: 'å„ä»“åº“åº“å­˜çŠ¶æ€åˆ†å¸ƒ', left: 'center' },
            tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
            legend: { data: ['ç´§æ€¥', 'ä½åº“å­˜', 'ä¸­ç­‰åº“å­˜', 'å……è¶³'] },
            grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
            xAxis: { type: 'category', data: Array.from(warehouses) },
            yAxis: { type: 'value', name: 'å•†å“æ•°é‡' },
            series: [
                { name: 'ç´§æ€¥', type: 'bar', stack: 'total', data: Array.from(warehouses).map(w => categoryData[w].urgent), itemStyle: { color: '#ef4444' } },
                { name: 'ä½åº“å­˜', type: 'bar', stack: 'total', data: Array.from(warehouses).map(w => categoryData[w].low), itemStyle: { color: '#f97316' } },
                { name: 'ä¸­ç­‰åº“å­˜', type: 'bar', stack: 'total', data: Array.from(warehouses).map(w => categoryData[w].medium), itemStyle: { color: '#f59e0b' } },
                { name: 'å……è¶³', type: 'bar', stack: 'total', data: Array.from(warehouses).map(w => categoryData[w].high), itemStyle: { color: '#10B981' } }
            ]
        });
        
        // å“åº”çª—å£å¤§å°å˜åŒ–
        window.addEventListener('resize', () => {
            pieChart.resize();
            barChart.resize();
            categoryChart.resize();
        });
    }
    
    // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
    function showToast(message) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.style.display = 'block';
        setTimeout(() => { toast.style.display = 'none'; }, 3000);
    }
</script>
</body>
</html>
